# Gong (å·¥) å®æ–½è®¡åˆ’

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° Gong é¡¹ç›®ä»éª¨æ¶åˆ°å¯ç”¨çš„å®Œæ•´å®æ–½è·¯å¾„ã€‚æŒ‰ä¾èµ–å…³ç³»ä»åº•å‘ä¸Šåˆ† 6 ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µç»“æŸéƒ½æœ‰å¯éªŒè¯çš„äº¤ä»˜ç‰©ã€‚

### ä¾èµ–å…³ç³»

```
å·¥å…· Actions (é˜¶æ®µä¸€)
    â†“
æˆªæ–­ç³»ç»Ÿ (é˜¶æ®µäºŒ)            Tape å­˜å‚¨ (é˜¶æ®µäº”) â†â€” å¯ä¸é˜¶æ®µä¸‰å¹¶è¡Œ
    â†“                            â†“
Agent å¾ªç¯ (é˜¶æ®µä¸‰)  â†â€”â€”â€”â†’  å‹ç¼© (é˜¶æ®µå…­ä¸Š)
    â†“
Hook ç³»ç»Ÿ (é˜¶æ®µå››)
    â†“
ZCPG é›†æˆ (é˜¶æ®µå…­ä¸‹)
```

### æµ‹è¯•åŸºå‡†

æ–‡æ¡£ `architecture.md` ç¬¬ J èŠ‚å®šä¹‰äº† 216 ä¸ª BDD æµ‹è¯•ï¼ˆå« 20 ä¸ª Pi bug å›å½’ + 23 ä¸ª Hook ç³»ç»Ÿ + 14 ä¸ªå‹ç¼©ç³»ç»Ÿ + 34 ä¸ª Tape å­˜å‚¨ + 30 ä¸ª Agent é›†æˆï¼‰ã€‚æ¯ä¸ªé˜¶æ®µå®ç°å®Œæˆåï¼Œå¯¹åº”çš„æµ‹è¯•å¿…é¡»å…¨éƒ¨é€šè¿‡ã€‚å½“å‰å…¨éƒ¨ 200 ä¸ª ExUnit æµ‹è¯•é€šè¿‡ï¼ˆéƒ¨åˆ† DSL åœºæ™¯åˆå¹¶ä¸ºåŒä¸€æµ‹è¯•ï¼‰ã€‚

---

## é˜¶æ®µä¸€ï¼š7 ä¸ªå·¥å…· Action âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šæ‰€æœ‰å·¥å…· Action çš„ `run/2` å®ç°å®Œæ•´åŠŸèƒ½ï¼Œé€šè¿‡å¯¹åº”çš„ BDD æµ‹è¯•ã€‚

**å‰ç½®æ¡ä»¶**ï¼šæ— ï¼ˆçº¯å‡½æ•°å¼ï¼Œä¸ä¾èµ– LLM å’Œå¤–éƒ¨æœåŠ¡ï¼‰

### å®ç°é¡ºåº

æŒ‰å¤æ‚åº¦ä»ä½åˆ°é«˜æ’åˆ—ï¼Œæ¯ä¸ªå·¥å…·åšå®Œç«‹å³å†™æµ‹è¯•ï¼š

#### 1.1 readï¼ˆæ–‡ä»¶è¯»å–ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Read`
- å¯¹åº”æµ‹è¯•ï¼šJ.3 èŠ‚ï¼Œ17 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `File.stream!/1` æŒ‰è¡Œè¯»å–
  - `offset` + `limit` åˆ†é¡µ
  - è¡Œå·å‰ç¼€æ ¼å¼ï¼š`"     {n}\t{line}"`
  - é•¿è¡Œæˆªæ–­ï¼ˆè¶…è¿‡ 2000 å­—ç¬¦çš„è¡Œæˆªæ–­å¹¶æ ‡è®°ï¼‰
  - æ–‡ä»¶ä¸å­˜åœ¨è¿”å›é”™è¯¯ä¿¡æ¯è€Œéå´©æºƒ
- è¾¹ç•Œæƒ…å†µï¼š
  - ç©ºæ–‡ä»¶è¿”å›ç©ºå†…å®¹æç¤º
  - äºŒè¿›åˆ¶æ–‡ä»¶æ£€æµ‹ï¼ˆè¯»å‰ 8KB æ£€æŸ¥ `\0` å­—èŠ‚ï¼‰
  - offset è¶…å‡ºæ–‡ä»¶è¡Œæ•° â†’ è¿”å›ç©º
  - è·¯å¾„ç©¿è¶Šæ ¡éªŒï¼ˆ`../` ä¸èƒ½é€ƒå‡ºå·¥ä½œåŒºï¼‰

#### 1.2 lsï¼ˆç›®å½•åˆ—è¡¨ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Ls`
- å¯¹åº”æµ‹è¯•ï¼šJ.7 èŠ‚ï¼Œ6 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `File.ls!/1` + `File.stat/1` è·å–å…ƒä¿¡æ¯
  - è¿”å›æ–‡ä»¶åã€å¤§å°ã€ç±»å‹ï¼ˆæ–‡ä»¶/ç›®å½•/ç¬¦å·é“¾æ¥ï¼‰
  - ç»“æœæŒ‰ç±»å‹æ’åºï¼šç›®å½•ä¼˜å…ˆï¼Œæ–‡ä»¶å…¶æ¬¡
- è¾¹ç•Œæƒ…å†µï¼š
  - ç›®å½•ä¸å­˜åœ¨ â†’ é”™è¯¯ä¿¡æ¯
  - å¯¹æ–‡ä»¶è·¯å¾„è°ƒç”¨ ls â†’ é”™è¯¯ä¿¡æ¯
  - ç©ºç›®å½• â†’ ç©ºåˆ—è¡¨
  - å¤§ç›®å½•ï¼ˆ>1000 æ¡ç›®ï¼‰â†’ æˆªæ–­å¹¶æç¤º

#### 1.3 findï¼ˆæ–‡ä»¶æŸ¥æ‰¾ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Find`
- å¯¹åº”æµ‹è¯•ï¼šJ.6 èŠ‚ï¼Œ6 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `Path.wildcard/2` æ‰§è¡Œ glob åŒ¹é…
  - æ’é™¤æ¨¡å¼è¿‡æ»¤ï¼ˆé»˜è®¤æ’é™¤ `.git/`ã€`node_modules/`ã€`_build/`ã€`deps/`ï¼‰
  - ç»“æœæŒ‰ä¿®æ”¹æ—¶é—´æ’åº
  - ç»“æœæ•°é‡é™åˆ¶ï¼ˆé»˜è®¤ 200ï¼‰
- è¾¹ç•Œæƒ…å†µï¼š
  - æ— åŒ¹é… â†’ ç©ºåˆ—è¡¨ + æç¤º
  - ç¬¦å·é“¾æ¥ä¸è¿½è¸ªï¼ˆé¿å…å¾ªç¯ï¼‰

#### 1.4 grepï¼ˆå†…å®¹æœç´¢ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Grep`
- å¯¹åº”æµ‹è¯•ï¼šJ.5 èŠ‚ï¼Œ10 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `Regex.compile/2` ç¼–è¯‘æ¨¡å¼
  - éå†æ–‡ä»¶ï¼ŒæŒ‰è¡ŒåŒ¹é…
  - æ”¯æŒä¸Šä¸‹æ–‡è¡Œæ•°ï¼ˆ`-A`/`-B`/`-C` è¯­ä¹‰ï¼‰
  - è¾“å‡ºæ¨¡å¼ï¼š`content`ï¼ˆæ˜¾ç¤ºåŒ¹é…è¡Œï¼‰ã€`files_with_matches`ï¼ˆåªæ˜¾ç¤ºæ–‡ä»¶åï¼‰ã€`count`ï¼ˆæ˜¾ç¤ºè®¡æ•°ï¼‰
  - glob è¿‡æ»¤æœç´¢èŒƒå›´
- è¾¹ç•Œæƒ…å†µï¼š
  - æ— æ•ˆæ­£åˆ™ â†’ å‹å¥½é”™è¯¯ä¿¡æ¯
  - äºŒè¿›åˆ¶æ–‡ä»¶è·³è¿‡
  - ç»“æœè¿‡å¤š â†’ æˆªæ–­
  - å¤šæ–‡ä»¶åŒ¹é…æ—¶æŒ‰æ–‡ä»¶åˆ†ç»„è¾“å‡º

#### 1.5 writeï¼ˆæ–‡ä»¶å†™å…¥ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Write`
- å¯¹åº”æµ‹è¯•ï¼šJ.4 èŠ‚ï¼Œ7 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `File.mkdir_p/1` è‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•
  - `File.write/3` è¦†ç›–å†™å…¥
  - è¿”å›å†™å…¥å­—èŠ‚æ•°
- è¾¹ç•Œæƒ…å†µï¼š
  - è·¯å¾„ç©¿è¶Šæ ¡éªŒ
  - å†™å…¥ç©ºå­—ç¬¦ä¸² â†’ åˆ›å»ºç©ºæ–‡ä»¶
  - æƒé™ä¸è¶³ â†’ é”™è¯¯ä¿¡æ¯
  - å†™å…¥åˆ°åªè¯»è·¯å¾„ â†’ é”™è¯¯ä¿¡æ¯

#### 1.6 editï¼ˆæ–‡ä»¶ç¼–è¾‘ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Edit`
- å¯¹åº”æµ‹è¯•ï¼šJ.1 èŠ‚ï¼Œ23 ä¸ªç”¨ä¾‹ï¼ˆæœ€å¤šï¼‰
- æ ¸å¿ƒé€»è¾‘ï¼š
  - è¯»æ–‡ä»¶ â†’ æŸ¥æ‰¾ `old_string` â†’ æ›¿æ¢ â†’ å†™å›
  - **å”¯ä¸€æ€§æ ¡éªŒ**ï¼š`old_string` åœ¨æ–‡ä»¶ä¸­å¿…é¡»æ°å¥½å‡ºç°ä¸€æ¬¡ï¼ˆé™¤é `replace_all: true`ï¼‰
  - å¤šæ¬¡åŒ¹é…æ—¶æŠ¥é”™å¹¶æ˜¾ç¤ºå„åŒ¹é…çš„è¡Œå·
  - é›¶åŒ¹é…æ—¶æŠ¥é”™å¹¶æä¾›æ¨¡ç³ŠåŒ¹é…å»ºè®®
  - ä¿æŒåŸå§‹æ¢è¡Œç¬¦ï¼ˆCRLF æˆ– LFï¼‰
- è¾¹ç•Œæƒ…å†µï¼š
  - `old_string == new_string` â†’ æŠ¥é”™ï¼Œä¸åšæ— æ„ä¹‰æ›¿æ¢
  - BOM å¤´å¤„ç†ï¼ˆUTF-8 BOM 0xEF 0xBB 0xBFï¼‰
  - åŒ…å«æ­£åˆ™ç‰¹æ®Šå­—ç¬¦çš„å­—ç¬¦ä¸² â†’ ç²¾ç¡®åŒ¹é…ï¼Œä¸åšæ­£åˆ™
  - è·¯å¾„ç©¿è¶Šæ ¡éªŒ
  - `replace_all: true` æ—¶è¿”å›æ›¿æ¢æ¬¡æ•°

#### 1.7 bashï¼ˆå‘½ä»¤æ‰§è¡Œï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Bash`
- å¯¹åº”æµ‹è¯•ï¼šJ.2 èŠ‚ï¼Œ14 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `System.cmd("bash", ["-c", command], opts)` æ‰§è¡Œå‘½ä»¤
  - æˆ–ç”¨ `Port.open/2` åšæ›´ç»†ç²’åº¦æ§åˆ¶
  - è¶…æ—¶æ§åˆ¶ï¼š`Task.async` + `Task.yield` + `Task.shutdown`
  - stdout å’Œ stderr åˆ†ç¦»æ•è·
  - è¾“å‡ºè¶…é•¿æ—¶è‡ªåŠ¨è°ƒç”¨ `Gong.Truncate`
  - å·¥ä½œç›®å½•è®¾ç½®ï¼ˆ`cd: working_dir`ï¼‰
- è¾¹ç•Œæƒ…å†µï¼š
  - å‘½ä»¤ä¸å­˜åœ¨ â†’ exit_code 127 + é”™è¯¯ä¿¡æ¯
  - è¶…æ—¶ â†’ æ€è¿›ç¨‹ + è¶…æ—¶æç¤º
  - å‘½ä»¤è¢«ä¿¡å·ç»ˆæ­¢ â†’ æŠ¥å‘Šä¿¡å·ç±»å‹
  - ç¯å¢ƒå˜é‡ç»§æ‰¿å½“å‰è¿›ç¨‹ç¯å¢ƒ
  - ç©ºå‘½ä»¤ â†’ æŠ¥é”™

### é˜¶æ®µä¸€äº¤ä»˜ç‰©

- âœ… 7 ä¸ª Action æ¨¡å—å…¨éƒ¨å®ç°
- âœ… 85 ä¸ª BDD æµ‹è¯•é€šè¿‡ï¼ˆJ.1 åˆ° J.7ï¼Œå« Pi bug å›å½’ + å‚æ•°æ ¡éªŒä¸å®‰å…¨ï¼‰
- âœ… æ¯ä¸ª Action å¯ä»¥ç‹¬ç«‹é€šè¿‡ `Jido.Action.run/2` è°ƒç”¨

---

## é˜¶æ®µäºŒï¼šæˆªæ–­ç³»ç»Ÿ âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šå®Œå–„ `Gong.Truncate`ï¼Œè¿”å›ç»“æ„åŒ–å…ƒæ•°æ®ï¼Œä¸å·¥å…·è¾“å‡ºå¯¹æ¥ã€‚

**å‰ç½®æ¡ä»¶**ï¼šé˜¶æ®µä¸€å®Œæˆï¼ˆæˆªæ–­è¦å¯¹æ¥å·¥å…·è¾“å‡ºï¼‰

### å®ç°å†…å®¹

#### 2.1 Result ç»“æ„ä½“ + åŒé™åˆ¶

é‡æ„ `Gong.Truncate`ï¼Œè¿”å› `%Gong.Truncate.Result{}` æ›¿ä»£æ—§çš„ `{text, boolean}` å…ƒç»„ï¼š

```elixir
defmodule Gong.Truncate.Result do
  defstruct content: "",
            truncated: false,
            truncated_by: nil,        # :lines | :bytes | :chars | nil
            total_lines: 0,
            total_bytes: 0,
            output_lines: 0,
            output_bytes: 0,
            last_line_partial: false,
            first_line_exceeds_limit: false,
            max_lines: nil,
            max_bytes: nil
end
```

- `truncate_head`ï¼šé€è¡Œç´¯åŠ ï¼Œ`max_lines` + `max_bytes` å…ˆè§¦å‘è€…ç”Ÿæ•ˆ
- `truncate_tail`ï¼šä»æœ«å°¾é€è¡Œæ”¶é›†ï¼Œè¾¹ç•Œè¡Œéƒ¨åˆ†åŒ…å«ï¼ˆUTF-8 å®‰å…¨ï¼‰
- `truncate_line`ï¼šæ–°å¢å•è¡Œæˆªæ–­ï¼ˆç”¨äº grep å•è¡Œé™åˆ¶ï¼‰ï¼Œè¶… `max_chars` åˆ™æˆªæ–­

#### 2.2 å·¥å…·è¾“å‡ºå¯¹æ¥

ä¸‰å¤„è°ƒç”¨æ”¹ä¸ºè§£æ„ `%Result{}`ï¼š

- **read.ex**ï¼šå­—èŠ‚æˆªæ–­åè¿½åŠ  `"Use offset=N to continue reading"` ç»­è¯»æç¤º
- **bash.ex**ï¼šæˆªæ–­åè¿½åŠ  `"åŸå§‹ N å­—èŠ‚"` åŸå§‹å¤§å°ä¿¡æ¯
- **grep.ex**ï¼šç®€å•è§£æ„ `%Result{content: truncated}`

#### 2.3 BDD æµ‹è¯•

æ–°å¢æŒ‡ä»¤ï¼š
- **GIVEN**: `set_var`ã€`generate_content`ï¼ˆå†…å­˜æ•°æ®å‡†å¤‡ï¼Œä¸ä¾èµ–æ–‡ä»¶ç³»ç»Ÿï¼‰
- **WHEN**: `truncate_head`ã€`truncate_tail`ã€`truncate_line`ï¼ˆç›´æ¥è°ƒç”¨æˆªæ–­æ¨¡å—ï¼‰
- **THEN**: `assert_truncation_result`ã€`assert_truncation_notification`ï¼ˆç»“æ„åŒ–æ–­è¨€ï¼‰

DSL æ–‡ä»¶ï¼š`docs/bdd/truncate_system.dsl`ï¼Œ14 ä¸ªåœºæ™¯ï¼ˆBDD-TRC-001 ~ 014ï¼‰

### é˜¶æ®µäºŒäº¤ä»˜ç‰©

- âœ… æˆªæ–­ç³»ç»Ÿ 14 ä¸ªæµ‹è¯•é€šè¿‡ï¼ˆJ.8 èŠ‚ï¼Œå« 2 ä¸ª Pi bug å›å½’ï¼‰
- âœ… é˜¶æ®µä¸€ 85 ä¸ªæµ‹è¯•æ— å›å½’
- âœ… å·¥å…· + æˆªæ–­åˆè®¡ **99 ä¸ªæµ‹è¯•é€šè¿‡**
- âœ… `mix compile --warnings-as-errors` æ— è­¦å‘Š

---

## é˜¶æ®µä¸‰ï¼šAgent å¾ªç¯ âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šLLM è°ƒç”¨ + å·¥å…·æ‰§è¡Œå½¢æˆå®Œæ•´çš„ agent loopã€‚

**å‰ç½®æ¡ä»¶**ï¼šé˜¶æ®µä¸€ã€äºŒå®Œæˆ

**å¤–éƒ¨ä¾èµ–**ï¼šéœ€è¦ LLM API keyï¼ˆAnthropic æˆ– OpenAIï¼‰

### å®ç°å†…å®¹

#### 3.1 å·¥å…·æ³¨å†Œä¸ schema è½¬æ¢

jido_ai çš„ `ToolAdapter` è‡ªåŠ¨æŠŠ Jido Action è½¬æˆ LLM çš„ tool schemaï¼š

```elixir
# Jido Action çš„ schema å®šä¹‰
schema: [
  file_path: [type: :string, required: true, doc: "æ–‡ä»¶ç»å¯¹è·¯å¾„"],
  offset: [type: :non_neg_integer, default: 0, doc: "èµ·å§‹è¡Œå·"]
]

# â†“ è‡ªåŠ¨è½¬æ¢ä¸º â†“

# LLM tool_call çš„ JSON Schema
%{
  "name" => "read_file",
  "description" => "è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒåˆ†é¡µ",
  "input_schema" => %{
    "type" => "object",
    "properties" => %{
      "file_path" => %{"type" => "string", "description" => "æ–‡ä»¶ç»å¯¹è·¯å¾„"},
      "offset" => %{"type" => "integer", "description" => "èµ·å§‹è¡Œå·"}
    },
    "required" => ["file_path"]
  }
}
```

éœ€è¦éªŒè¯ 7 ä¸ª Action çš„ schema éƒ½èƒ½æ­£ç¡®è½¬æ¢ã€‚

#### 3.2 Agent å¾ªç¯å®ç°

æ–°å»º `Gong.AgentLoop` æ¨¡å—ï¼Œæ ¸å¿ƒæµç¨‹ï¼š

```
ç”¨æˆ·æ¶ˆæ¯ â†’ æ‹¼è£…ä¸Šä¸‹æ–‡ï¼ˆç³»ç»Ÿæç¤º + å†å² + å·¥å…·åˆ—è¡¨ï¼‰
    â†’ è°ƒ LLMï¼ˆReqLLMï¼‰
    â†’ è§£æå“åº”
    â†’ å¦‚æœæœ‰ tool_call â†’ æ‰§è¡Œå¯¹åº” Action â†’ ç»“æœå›ä¼  â†’ ç»§ç»­å¾ªç¯
    â†’ å¦‚æœæ˜¯çº¯æ–‡æœ¬ â†’ è¿”å›ç»™ç”¨æˆ·
    â†’ å¦‚æœè¯·æ±‚ç»“æŸ â†’ é€€å‡ºå¾ªç¯
```

åˆ©ç”¨ jido_ai çš„ `ReAct` ç­–ç•¥ï¼Œä¸éœ€è¦æ‰‹å†™å¾ªç¯çŠ¶æ€æœºï¼š

```elixir
# jido_ai å·²ç»å°è£…äº† ReAct å¾ªç¯
Jido.AI.Agent.run(agent, signal, strategy: :react)
```

éœ€è¦ç¡®è®¤ `ReAct` ç­–ç•¥çš„ä»¥ä¸‹è¡Œä¸ºï¼š
- æœ€å¤§å¾ªç¯æ¬¡æ•°é™åˆ¶ï¼ˆé˜²æ­¢æ— é™ tool_callï¼‰
- tool_call å¤±è´¥æ—¶çš„é”™è¯¯æ¢å¤
- å¤šä¸ª tool_call çš„å¹¶è¡Œæ‰§è¡Œï¼ˆAnthropic æ”¯æŒï¼‰

#### 3.3 ç³»ç»Ÿæç¤ºè¯

æ–°å»º `Gong.Prompt` æ¨¡å—ï¼š

```elixir
defmodule Gong.Prompt do
  def system_prompt(workspace) do
    """
    ä½ æ˜¯ä¸€ä¸ªé€šç”¨ Agentï¼Œå·¥ä½œç›®å½•æ˜¯ #{workspace}ã€‚
    ä½¿ç”¨æä¾›çš„å·¥å…·å®Œæˆç”¨æˆ·çš„ä»»åŠ¡ã€‚
    ...
    """
  end
end
```

ç³»ç»Ÿæç¤ºè¯ä» `Gong.Agent` çš„ schema ä¸­çš„ `system_prompt` å­—æ®µæ³¨å…¥ï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è¦†ç›–ã€‚

#### 3.4 æµå¼è¾“å‡º

LLM çš„å“åº”æ”¯æŒ SSE æµå¼è¾“å‡ºï¼š

```elixir
ReqLLM.chat(model, messages, tools: tools, stream: true)
|> Stream.each(fn chunk -> send(caller, {:chunk, chunk}) end)
```

è¿™æ˜¯ ZCPG é›†æˆçš„å…³é”®â€”â€”ZCPG çš„ SSE client éœ€è¦å®æ—¶æ¥æ”¶ tokenã€‚

### é˜¶æ®µä¸‰äº¤ä»˜ç‰©

- âœ… `Gong.AgentLoop` æ¨¡å—å®ç°
- âœ… `Gong.Prompt` æ¨¡å—å®ç°
- âœ… 30 ä¸ªé›†æˆæµ‹è¯•é€šè¿‡ï¼ˆJ.9 èŠ‚ï¼Œå«æµå¼è¾“å‡ºã€Hook ç«¯åˆ°ç«¯ã€é”™è¯¯æ¢å¤ä¸å¥å£®æ€§ï¼‰
- âœ… å¯ä»¥åœ¨ IEx ä¸­æ‰‹åŠ¨è·‘å®Œæ•´çš„ agent å¯¹è¯

---

## é˜¶æ®µå››ï¼šHook ç³»ç»Ÿ âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šå®ç°äº‹ä»¶æ‹¦æˆªä¸æ•°æ®å˜æ¢åŸºç¡€è®¾æ–½ï¼Œåœ¨å·¥å…·æ‰§è¡Œã€LLM è°ƒç”¨ã€ä¼šè¯æ“ä½œç­‰å…³é”®èŠ‚ç‚¹æ’å…¥ç”¨æˆ·è‡ªå®šä¹‰é€»è¾‘ã€‚

**å‰ç½®æ¡ä»¶**ï¼šé˜¶æ®µä¸‰å®Œæˆï¼ˆHook çš„é›†æˆç‚¹åœ¨ Agent å¾ªç¯ä¸­ï¼‰

### å®ç°å†…å®¹

#### 4.1 Hook Behaviour å®šä¹‰

æ–°å»º `Gong.Hook` behaviourï¼Œå®šä¹‰ 3 ç±»å›è°ƒï¼š

```elixir
defmodule Gong.Hook do
  @doc "Gate å‹ï¼šæ‹¦æˆªæ“ä½œï¼Œè¿”å› :ok æ”¾è¡Œæˆ– {:block, reason} é˜»æ­¢"
  @callback before_tool_call(tool :: atom(), params :: map()) ::
    :ok | {:block, String.t()}
  @callback before_session_op(op :: atom(), meta :: map()) ::
    :ok | :cancel

  @doc "Pipe å‹ï¼šå˜æ¢æ•°æ®æµï¼Œè¿”å›ä¿®æ”¹åçš„æ•°æ®"
  @callback on_tool_result(tool :: atom(), result :: map()) :: map()
  @callback on_context(messages :: [map()]) :: [map()]
  @callback on_input(text :: String.t(), images :: [map()]) ::
    {:transform, String.t(), [map()]} | :passthrough | :handled

  @doc "Notify å‹ï¼šè§‚å¯Ÿäº‹ä»¶ï¼Œé€šè¿‡ :telemetry å¹¿æ’­"
  @callback on_before_agent(prompt :: String.t(), system :: String.t()) ::
    {String.t(), String.t(), [map()]}

  @optional_callbacks [before_tool_call: 2, before_session_op: 2,
    on_tool_result: 2, on_context: 1, on_input: 2, on_before_agent: 2]
end
```

#### 4.2 HookRunner å®ç°

æ–°å»º `Gong.HookRunner`ï¼Œä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š

- **`pipe/3`**ï¼šEnum.reduce é“¾å¼è°ƒç”¨ï¼Œæ¯ä¸ª hook å˜æ¢æ•°æ®åä¼ ç»™ä¸‹ä¸€ä¸ª
- **`gate/2`**ï¼šEnum.reduce_while é“¾å¼è°ƒç”¨ï¼Œä»»ä¸€ hook è¿”å› block åˆ™ç»ˆæ­¢

é”™è¯¯éš”ç¦»ï¼šå•ä¸ª hook å¼‚å¸¸ä¸å½±å“å…¶ä»– hookï¼Œé€šè¿‡ try/rescue æ•è·å¹¶å‘ telemetry äº‹ä»¶ã€‚

#### 4.3 Agent å¾ªç¯é›†æˆ

åœ¨ `Gong.AgentLoop` çš„ 5 ä¸ªå…³é”®èŠ‚ç‚¹æ’å…¥ hook è°ƒç”¨ï¼š

1. ç”¨æˆ·è¾“å…¥è¿›å…¥å‰ â†’ `on_input`
2. æ„å»ºä¸Šä¸‹æ–‡æ—¶ â†’ `on_context`
3. è°ƒ LLM å‰ â†’ `on_before_agent`
4. å·¥å…·æ‰§è¡Œå‰ â†’ `before_tool_call`ï¼ˆgateï¼‰
5. å·¥å…·æ‰§è¡Œå â†’ `on_tool_result`ï¼ˆpipeï¼‰

#### 4.4 Telemetry äº‹ä»¶

æ³¨å†Œæ ‡å‡† telemetry äº‹ä»¶ä¾›å¤–éƒ¨ç›‘æ§ï¼š

- `[:gong, :tool, :start]` / `[:gong, :tool, :stop]`
- `[:gong, :llm, :start]` / `[:gong, :llm, :stop]`
- `[:gong, :hook, :error]`

### é˜¶æ®µå››äº¤ä»˜ç‰©

- âœ… `Gong.Hook` behaviour æ¨¡å—
- âœ… `Gong.HookRunner` å®ç°æ¨¡å—ï¼ˆå« gate å¼‚å¸¸å€¼ catch-allï¼‰
- âœ… Agent å¾ªç¯ 5 ä¸ªé›†æˆç‚¹æ”¹é€ 
- âœ… 23 ä¸ª Hook ç³»ç»Ÿ BDD æµ‹è¯•é€šè¿‡ï¼ˆJ.10 èŠ‚ï¼Œå« short-circuitã€passthroughã€telemetry åºåˆ—éªŒè¯ï¼‰

---

## é˜¶æ®µäº”ï¼šTape å­˜å‚¨ âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šå®ç°æ–‡ä»¶å¤¹ + SQLite ç´¢å¼•çš„ä¼šè¯å­˜å‚¨ã€‚

**å‰ç½®æ¡ä»¶**ï¼šæ— ï¼ˆç‹¬ç«‹æ¨¡å—ï¼Œå¯ä¸é˜¶æ®µä¸‰å¹¶è¡Œå¼€å‘ï¼‰

### å®ç°å†…å®¹

#### 5.1 SQLite schema åˆå§‹åŒ–

```elixir
defp init_db(db_path) do
  {:ok, conn} = Exqlite.Sqlite3.open(db_path)

  Exqlite.Sqlite3.execute(conn, """
    CREATE TABLE IF NOT EXISTS entries (
      id          INTEGER PRIMARY KEY AUTOINCREMENT,
      kind        TEXT NOT NULL,
      anchor_name TEXT NOT NULL,
      anchor_seq  INTEGER NOT NULL,
      file_path   TEXT NOT NULL,
      line_offset INTEGER,
      created_at  TEXT NOT NULL,
      summary     TEXT
    )
  """)

  # å»ºç´¢å¼•...
  # å»º FTS5 è™šæ‹Ÿè¡¨...
end
```

æˆ–è€…ç”¨ Ecto + ecto_sqlite3 åš migrationï¼ˆæ›´è§„èŒƒä½†æ›´é‡ï¼‰ã€‚

**å†³ç­–ç‚¹**ï¼šç›´æ¥ç”¨ Exqlite è¿˜æ˜¯èµ° Ectoï¼Ÿ
- Exqlite ç›´æ¥ SQLï¼šè½»é‡ï¼Œé€‚åˆåµŒå…¥å¼åœºæ™¯ï¼Œä»£ç æ›´å°‘
- Ecto migrationï¼šè§„èŒƒï¼Œæœ‰ schema ç‰ˆæœ¬ç®¡ç†ï¼Œä½†å¼•å…¥ Repo æ¦‚å¿µ

å»ºè®®å…ˆç”¨ Exqlite ç›´æ¥å†™ï¼Œåç»­éœ€è¦å†æŠ½ Ectoã€‚

#### 5.2 æ ¸å¿ƒæ“ä½œå®ç°

æŒ‰é¡ºåºï¼š

1. **`init/1`** â€” åˆ›å»º `anchors/` ç›®å½• + `index.db` + é»˜è®¤ anchor `001_session-start`
2. **`append/3`** â€” å†™ JSONL æ–‡ä»¶ + INSERT SQLiteï¼Œç”¨äº‹åŠ¡åŒ…è£¹
3. **`handoff/3`** â€” åˆ›å»ºæ–° anchor ç›®å½• + INSERT anchor è®°å½•
4. **`between_anchors/3`** â€” SQL èŒƒå›´æŸ¥è¯¢ â†’ å®šä½æ–‡ä»¶ â†’ è¯» JSONL
5. **`search/2`** â€” FTS5 å…¨æ–‡æœç´¢ â†’ å®šä½æ–‡ä»¶ â†’ è¯»å®Œæ•´æ¡ç›®
6. **`fork/1`** â€” SQLite savepoint + ä¸´æ—¶ç›®å½•
7. **`merge/2`** â€” åˆå¹¶ä¸´æ—¶ç›®å½•åˆ°ä¸»ç›®å½• + åˆå¹¶ SQLite è®°å½•

#### 5.3 ä¸€è‡´æ€§ä¿è¯

åŒå†™çš„åŸå­æ€§é—®é¢˜ï¼š

```elixir
def append(store, anchor, entry) do
  # å…ˆå†™æ–‡ä»¶ï¼ˆè¿½åŠ ï¼Œä½é£é™©ï¼‰
  :ok = write_jsonl(file_path, entry)

  # å†å†™æ•°æ®åº“ï¼ˆäº‹åŠ¡ï¼‰
  {:ok, _} = insert_index(store.db, entry_meta)

  # å¦‚æœæ•°æ®åº“å†™å…¥å¤±è´¥ï¼Œæ–‡ä»¶å¤šäº†ä¸€è¡Œä½†ç´¢å¼•æ²¡æœ‰
  # â†’ ä¸‹æ¬¡å¯åŠ¨æ—¶å¯ä»¥é€šè¿‡æ‰«ææ–‡ä»¶ä¿®å¤ç´¢å¼•ï¼ˆrebuild_indexï¼‰
end
```

æ·»åŠ  `rebuild_index/1` å‡½æ•°ï¼šæ‰«æ anchors/ ç›®å½•é‡å»º SQLite ç´¢å¼•ã€‚

### é˜¶æ®µäº”äº¤ä»˜ç‰©

- âœ… `Gong.Tape.Store` å®Œæ•´å®ç°ï¼ˆå« Entryã€FileStoreã€Index ä¸‰æ¨¡å—ï¼‰
- âœ… 34 ä¸ª Tape å­˜å‚¨ BDD æµ‹è¯•é€šè¿‡ï¼ˆJ.11 èŠ‚ï¼Œå«åŒå†™ä¸€è‡´æ€§ã€fork/mergeã€metadata å­˜å–ã€Pi bug å›å½’ï¼‰
- âœ… SQLite ç´¢å¼•æ”¯æŒ metadata å­—æ®µï¼ŒFTS5 å…¨æ–‡æœç´¢å¯ç”¨

---

## é˜¶æ®µå…­ï¼šå‹ç¼© + ZCPG é›†æˆ

**ç›®æ ‡**ï¼šä¸Šä¸‹æ–‡å‹ç¼©å¯ç”¨ï¼ŒGong æ¥å…¥ ZCPG æ›¿æ¢ OpenCodeã€‚

**å‰ç½®æ¡ä»¶**ï¼šé˜¶æ®µä¸‰ã€å››ã€äº”å®Œæˆ

### 6a. ä¸Šä¸‹æ–‡å‹ç¼© âœ… å·²å®Œæˆ

#### å®ç°å†…å®¹

æ–°å»ºæˆ–å®Œå–„ `Gong.Compaction`ï¼š

```elixir
def compact(messages, opts) do
  window = Keyword.get(opts, :window_size, 20)
  max_tokens = Keyword.get(opts, :max_tokens, 100_000)

  if estimate_tokens(messages) <= max_tokens do
    {messages, nil}
  else
    {old, recent} = Enum.split(messages, -window)
    summary = summarize(old)  # è°ƒ LLM ç”Ÿæˆæ‘˜è¦
    {[%{role: "system", content: summary} | recent], summary}
  end
end
```

æ ¸å¿ƒé€»è¾‘ï¼š
- Token ä¼°ç®—ï¼šæŒ‰å­—ç¬¦æ•°ç²—ä¼°ï¼ˆä¸­æ–‡ 1 å­— â‰ˆ 2 tokenï¼Œè‹±æ–‡ 1 word â‰ˆ 1.3 tokenï¼‰
- æ»‘åŠ¨çª—å£ï¼šä¿ç•™æœ€è¿‘ N æ¡å®Œæ•´æ¶ˆæ¯
- æ‘˜è¦ç”Ÿæˆï¼šè°ƒ LLM å¯¹æ—§æ¶ˆæ¯ç”Ÿæˆç»“æ„åŒ–æ‘˜è¦
- ç³»ç»Ÿæ¶ˆæ¯å’Œ anchor æ¶ˆæ¯ä¸å‚ä¸å‹ç¼©ï¼Œå§‹ç»ˆä¿ç•™

#### ä¸ Tape é…åˆ

å‹ç¼©è§¦å‘æ—¶ï¼ŒåŒæ—¶åœ¨ Tape ä¸­åˆ›å»ºæ–° anchorï¼š

```elixir
def compact_and_handoff(tape_store, messages, opts) do
  {compacted, summary} = compact(messages, opts)
  if summary do
    Gong.Tape.Store.handoff(tape_store, "compaction", %{summary: summary})
  end
  compacted
end
```

### 6b. ZCPG é›†æˆ â¸ï¸ æš‚ç¼“

#### å½“å‰ ZCPG æ¶æ„

ZCPG é€šè¿‡ `Zcpg.AI.AgentClient` behaviour è°ƒç”¨å¤–éƒ¨ agentï¼š

```elixir
# å½“å‰å®ç°ï¼šHTTP è°ƒ OpenCode (127.0.0.1:4096)
defmodule Zcpg.AI.Adapters.OpenCode do
  @behaviour Zcpg.AI.AgentClient

  def create_session(opts), do: ...   # POST /sessions
  def call(session, agent, input, opts), do: ...  # POST /sessions/:id/chat
  def stream(session, agent, input, callback, opts), do: ...  # SSE
  def abort(session, reason), do: ...
end
```

#### æ–°é€‚é…å™¨

åœ¨ ZCPG é¡¹ç›®ä¸­æ–°å»º `Zcpg.AI.Adapters.Gong`ï¼š

```elixir
defmodule Zcpg.AI.Adapters.Gong do
  @behaviour Zcpg.AI.AgentClient

  def create_session(opts) do
    # ä¸å† HTTPï¼Œç›´æ¥åœ¨ BEAM å†…å¯åŠ¨ Gong agent è¿›ç¨‹
    {:ok, pid} = DynamicSupervisor.start_child(
      Gong.SessionSupervisor,
      {Gong.AgentLoop, workspace: opts[:workspace]}
    )
    {:ok, %{pid: pid, session_id: inspect(pid)}}
  end

  def call(session, _agent, input, _opts) do
    Gong.AgentLoop.chat(session.pid, input)
  end

  def stream(session, _agent, input, callback, _opts) do
    Gong.AgentLoop.stream(session.pid, input, callback)
  end

  def abort(session, _reason) do
    Gong.AgentLoop.cancel(session.pid)
  end
end
```

#### é›†æˆæ­¥éª¤

1. ZCPG çš„ `mix.exs` æ·»åŠ  `{:gong, path: "../gong"}` ä¾èµ–
2. æ–°å»º `Zcpg.AI.Adapters.Gong` æ¨¡å—
3. é…ç½®åˆ‡æ¢ï¼š`config :zcpg, :agent_adapter, Zcpg.AI.Adapters.Gong`
4. ä¿ç•™ OpenCode é€‚é…å™¨ä½œä¸ºå›é€€
5. éªŒè¯ 4 ä¸ª agent åœºæ™¯ï¼škb-triageã€kb-answerã€rlm-plannerã€build

#### é…ç½®ç¤ºä¾‹

```elixir
# config/config.exs
config :zcpg, :agent_adapter, Zcpg.AI.Adapters.Gong

config :gong,
  model: "anthropic/claude-sonnet-4-5-20250929",
  api_key: System.get_env("ANTHROPIC_API_KEY")
```

### é˜¶æ®µå…­äº¤ä»˜ç‰©

**6a å·²å®Œæˆï¼š**
- âœ… `Gong.Compaction` å®Œæ•´å®ç°ï¼ˆå« Token ä¼°ç®—ã€æ»‘åŠ¨çª—å£ã€ETS é”ã€fallback æˆªæ–­ï¼‰
- âœ… 14 ä¸ªå‹ç¼©ç³»ç»Ÿ BDD æµ‹è¯•é€šè¿‡ï¼ˆJ.12 èŠ‚ï¼Œå« summarize_fn å´©æºƒã€é”éš”ç¦»ã€window è¾¹ç•Œç­‰ï¼‰

**6b æš‚ç¼“ï¼š**
- `Zcpg.AI.Adapters.Gong` é€‚é…å™¨ï¼ˆå¾…åç»­å¯åŠ¨ï¼‰
- ZCPG å¯é€šè¿‡é…ç½®åˆ‡æ¢ä½¿ç”¨ Gong æˆ– OpenCode
- ç«¯åˆ°ç«¯éªŒè¯ï¼šZCPG é¡µé¢å‘æ¶ˆæ¯ â†’ Gong agent å¤„ç† â†’ æµå¼è¿”å›

---

## é‡Œç¨‹ç¢‘æ€»ç»“

| é˜¶æ®µ | äº¤ä»˜ç‰© | ç´¯è®¡æµ‹è¯• | å¤–éƒ¨ä¾èµ– | çŠ¶æ€ |
|------|--------|----------|----------|------|
| ä¸€ | 7 ä¸ªå·¥å…· Action å®Œæ•´å®ç° | 85 | æ—  | âœ… å®Œæˆ |
| äºŒ | æˆªæ–­ç³»ç»Ÿ + å·¥å…·å¯¹æ¥ | 99 | æ—  | âœ… å®Œæˆ |
| ä¸‰ | Agent å¾ªç¯ + LLM è°ƒç”¨ | 129 | LLM API key | âœ… å®Œæˆ |
| å›› | Hook ç³»ç»Ÿ | 152 | æ—  | âœ… å®Œæˆ |
| äº” | Tape å­˜å‚¨ï¼ˆæ–‡ä»¶å¤¹ + SQLiteï¼‰ | 186 | æ—  | âœ… å®Œæˆ |
| å…­a | å‹ç¼©ç³»ç»Ÿ | 200 | æ—  | âœ… å®Œæˆ |
| ä¸ƒ | æ¶æ„ç¼ºå£è¡¥å…¨ï¼ˆ20 ä¸ªæ–° BDD åœºæ™¯ï¼‰ | ~220 | æ—  | ğŸ“‹ å¾…å®ç° |
| å…­b | ZCPG é›†æˆ | â€” | ZCPG é¡¹ç›® | â¸ï¸ æš‚ç¼“ |

### å¹¶è¡Œåº¦

```
æ—¶é—´çº¿ â†’

é˜¶æ®µä¸€ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
é˜¶æ®µäºŒ          â–ˆâ–ˆâ–ˆâ–ˆ
é˜¶æ®µä¸‰              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
é˜¶æ®µå››                          â–ˆâ–ˆâ–ˆâ–ˆ
é˜¶æ®µäº”          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â† å¯ä¸äºŒã€ä¸‰ã€å››å¹¶è¡Œ
é˜¶æ®µå…­                              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
```

é˜¶æ®µäº”ï¼ˆTape å­˜å‚¨ï¼‰æ˜¯å®Œå…¨ç‹¬ç«‹çš„æ¨¡å—ï¼Œå¯ä»¥åœ¨é˜¶æ®µäºŒå¼€å§‹åéšæ—¶å¹¶è¡Œæ¨è¿›ã€‚
é˜¶æ®µå››ï¼ˆHook ç³»ç»Ÿï¼‰ä¾èµ–é˜¶æ®µä¸‰çš„ Agent å¾ªç¯ï¼Œå› ä¸º Hook çš„é›†æˆç‚¹åœ¨å¾ªç¯ä¸­ã€‚

### é£é™©ç‚¹

1. **jido_ai çš„ ReAct ç­–ç•¥** â€” main åˆ†æ”¯æœªå‘å¸ƒåˆ° hexï¼ŒAPI å¯èƒ½å˜åŠ¨ã€‚åº”å¯¹ï¼špin commit hash
2. **Elixir ç‰ˆæœ¬** â€” jido_browser å’Œ yaml_elixir è¦æ±‚ 1.18ï¼Œå½“å‰ç³»ç»Ÿæ˜¯ 1.17.3ã€‚åº”å¯¹ï¼šå‡çº§ Elixir æˆ–æ’é™¤ jido_browser
3. **tool_call æ ¼å¼å…¼å®¹** â€” ä¸åŒ LLM æä¾›å•†çš„ tool_call æ ¼å¼æœ‰ç»†å¾®å·®å¼‚ã€‚åº”å¯¹ï¼šå…ˆé”å®š Anthropicï¼Œå…¶ä»–æä¾›å•†ç•™ä½
4. **Tape åŒå†™ä¸€è‡´æ€§** â€” æ–‡ä»¶å†™æˆåŠŸä½† SQLite å†™å¤±è´¥ã€‚åº”å¯¹ï¼šrebuild_index ä¿®å¤æœºåˆ¶

---

## æ¶æ„æ–‡æ¡£ç¼ºå£æ¸…å•ï¼ˆä» pi-mono å¯¹æ¯”å‘ç°ï¼‰

ä»¥ä¸‹ç‰¹æ€§åœ¨ `æ¶æ„è®¾è®¡.md` ä¸­æœ‰æè¿°ï¼Œä½†åœ¨ä¹‹å‰çš„å®æ–½è®¡åˆ’ä¸­é—æ¼ï¼Œå¯¼è‡´æœªå®ç°ã€‚æŒ‰ä¼˜å…ˆçº§åˆ†ç»„åˆ—å‡ºï¼Œæ¯é¡¹æ ‡æ³¨æ¶æ„æ–‡æ¡£å‡ºå¤„å’Œ BDD è¦†ç›–çŠ¶æ€ã€‚

### P0ï¼šAgent å¾ªç¯æ ¸å¿ƒèƒ½åŠ›

#### 7.1 Steering ä¸­æ–­

ç”¨æˆ·åœ¨ Agent æ‰§è¡Œå·¥å…·é“¾æœŸé—´å‘é€æ–°æ¶ˆæ¯ï¼Œåº”èƒ½æ‰“æ–­å½“å‰æ‰§è¡Œã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 2.2ï¼ˆåŒå±‚å¾ªç¯ steering æœºåˆ¶ï¼‰ã€J.9 test 1.4
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - Agent æ¯æ‰§è¡Œå®Œä¸€ä¸ª tool_call åæ£€æŸ¥ steering æ¶ˆæ¯é˜Ÿåˆ—
  - æœ‰ steering æ—¶è·³è¿‡å‰©ä½™ tool_callï¼Œæ ‡è®°ä¸º `"Skipped due to queued user message"`
  - OTP å®ç°ï¼š`GenServer.cast` æ³¨å…¥ steeringï¼Œ`check_steering/1` ä» mailbox è¯»å–
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-AGENT-031`ï¼šsteering ä¸­æ–­è·³è¿‡å‰©ä½™å·¥å…·
  - `BDD-AGENT-032`ï¼šsteering æ¶ˆæ¯åœ¨ä¸‹ä¸€è½®è¢«æ­£ç¡®å¤„ç†

#### 7.2 Auto-Retryï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰

LLM API è¿”å› 429/overloaded/server error æ—¶è‡ªåŠ¨æŒ‡æ•°é€€é¿é‡è¯•ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šJ.9 tests 4.3, 4.7, 5.1, 5.4, 5.6
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - æ£€æµ‹å¯é‡è¯•é”™è¯¯ï¼ˆ429 Too Many Requestsã€overloadedã€5xxï¼‰
  - æŒ‡æ•°é€€é¿ï¼š1s â†’ 2s â†’ 4s â†’ 8sï¼Œæœ€å¤š 3 æ¬¡
  - 429 ä¸è§¦å‘å‹ç¼©ï¼ˆPi bug #1038 å›å½’ï¼‰
  - retry åœ¨å·¥å…·æ‰§è¡Œå®Œæˆåæ‰ resolveï¼ˆPi bug #1465 å›å½’ï¼‰
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-AGENT-033`ï¼š429 è§¦å‘é‡è¯•è€Œéå‹ç¼©
  - `BDD-AGENT-034`ï¼šé‡è¯•æˆåŠŸåæ­£å¸¸ç»§ç»­
  - `BDD-AGENT-035`ï¼šé‡è¯•è€—å°½è¿”å›é”™è¯¯

#### 7.3 Auto-Compactionï¼ˆè‡ªåŠ¨å‹ç¼©ï¼‰

Agent å¯¹è¯åè‡ªåŠ¨æ£€æµ‹ä¸Šä¸‹æ–‡æº¢å‡ºå¹¶è§¦å‘å‹ç¼©ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.1ï¼ˆè§¦å‘æ¡ä»¶ï¼‰ã€J.9 tests 4.3, 4.4
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ˆå½“å‰éœ€æ‰‹åŠ¨è°ƒç”¨ `compact/2`ï¼‰ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - æ¯è½® Agent ç»“æŸåæ£€æŸ¥ï¼š`contextTokens > (contextWindow - reserveTokens)`
  - `reserveTokens` é»˜è®¤ 16384
  - å‹ç¼©æœŸé—´æ’é˜Ÿçš„ç”¨æˆ·æ¶ˆæ¯ä¸ä¸¢å¤±ï¼ˆPi bug #1312 å›å½’ï¼‰
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-AGENT-036`ï¼šä¸Šä¸‹æ–‡è¶…é™è‡ªåŠ¨è§¦å‘å‹ç¼©
  - `BDD-AGENT-037`ï¼šå‹ç¼©æœŸé—´æ’é˜Ÿæ¶ˆæ¯æ¢å¤

#### 7.4 Pi Bug å›å½’è¡¥å…¨

æ¶æ„æ–‡æ¡£ J.9 section 4 å®šä¹‰äº† 7 ä¸ª Pi Bug å›å½’æµ‹è¯•ï¼Œå…¶ä¸­ 4.3/4.4/4.7 å·²æ˜ å°„åˆ° BDD-AGENT-033~037ã€‚ä»¥ä¸‹ 4 ä¸ªå›å½’æµ‹è¯•ç¼º BDD åœºæ™¯ï¼š

- **æ¶æ„å‡ºå¤„**ï¼šJ.9 tests 4.1, 4.2, 4.5, 4.6
- **å½“å‰çŠ¶æ€**ï¼šâŒ æ—  BDD åœºæ™¯
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-AGENT-038`ï¼šå¹¶å‘ prompt ç«æ€é˜²æŠ¤ï¼ˆPi #403ï¼‰â€” Agent å¤„ç†ä¸­æ”¶åˆ°ç¬¬äºŒä¸ª prompt â†’ æ‹’ç»æˆ–æ’é˜Ÿï¼Œä¸å¹¶å‘æ‰§è¡Œ
  - `BDD-AGENT-039`ï¼šå­¤å„¿ tool_result æ¸…ç†ï¼ˆPi #1454/#1455ï¼‰â€” ä¸­æ–­çš„ tool_call é—ç•™çš„ tool_result è¢«è‡ªåŠ¨æ¸…ç†ï¼Œä¸‹ä¸€è½® API ä¸æŠ¥ 400
  - `BDD-AGENT-040`ï¼šéæ•°ç»„ content ä¸å´©æºƒï¼ˆPi #1434ï¼‰â€” LLM è¿”å› content ä¸ºçº¯å­—ç¬¦ä¸²ï¼ˆé listï¼‰ï¼ŒAgent æ­£å¸¸å¤„ç†
  - `BDD-AGENT-041`ï¼šå¤š tool_call ç»“æœä¸é”™ä½ï¼ˆPi #1446ï¼‰â€” å•è½® 3 ä¸ª tool_call (read A/B/C)ï¼Œæ¯ä¸ª tool_result ç²¾ç¡®å¯¹åº”åŸå§‹ tool_call_id

### P1ï¼šCompaction å¢å¼º

#### 7.4 Token é¢„ç®—çª—å£ï¼ˆæ›¿ä»£æ¶ˆæ¯æ•°çª—å£ï¼‰

å½“å‰æŒ‰æ¶ˆæ¯æ•°åˆ‡ï¼ˆ`window_size=20`ï¼‰ï¼Œåº”æ”¹ä¸ºæŒ‰ token é¢„ç®—åˆ‡ï¼ˆ`keepRecentTokens=20000`ï¼‰ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.1/6.2ï¼ˆkeepRecentTokensï¼‰
- **å½“å‰çŠ¶æ€**ï¼šâš ï¸ å®ç°ä¸æ¶æ„ä¸ä¸€è‡´ï¼ˆç”¨æ¶ˆæ¯æ•°ä»£æ›¿ token é¢„ç®—ï¼‰ï¼Œâœ… BDD æœ‰ max_tokens é˜ˆå€¼æµ‹è¯•ä½†çª—å£æœ¬èº«æœªæµ‹
- **å®ç°è¦ç‚¹**ï¼š
  - ä»æœ€æ–°æ¶ˆæ¯å¾€å›éå†ï¼Œç´¯åŠ  token ä¼°ç®—å€¼
  - ç´¯è®¡è¶…è¿‡ `keepRecentTokens`ï¼ˆé»˜è®¤ 20000ï¼‰æ—¶ç¡®å®šåˆ‡å‰²ç‚¹
  - åˆ‡å‰²ç‚¹å¿…é¡»åœ¨æœ‰æ•ˆè¾¹ç•Œï¼ˆè§ 7.5ï¼‰

#### 7.5 tool_call/result é…å¯¹ä¿æŠ¤

å‹ç¼©åˆ‡å‰²æ—¶ä¸èƒ½æŠŠ tool_call å’Œå¯¹åº”çš„ tool_result æ‹†å¼€ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.2 step 3-4ã€J.9 tests 4.2, 4.6
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - åˆ‡å‰²ç‚¹åªèƒ½è½åœ¨ user/assistant æ¶ˆæ¯è¾¹ç•Œ
  - ä¸èƒ½åˆ‡åœ¨ tool_result ä¸­é—´
  - å¦‚æœåˆ‡åœ¨å¸¦ tool_calls çš„ assistant æ¶ˆæ¯ä¸­é—´ï¼Œç”Ÿæˆè½¬æŠ˜æ‘˜è¦
  - å­¤å„¿ tool_result æ¸…ç†
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-COMPACT-015`ï¼šåˆ‡å‰²ç‚¹è·³è¿‡ tool_result åˆ°å‰ä¸€ä¸ª user æ¶ˆæ¯
  - `BDD-COMPACT-016`ï¼šå­¤å„¿ tool_result è¢«æ¸…ç†

#### 7.6 ç»“æ„åŒ–æ‘˜è¦ Prompt

å‹ç¼©æ‘˜è¦åº”ä½¿ç”¨ç»“æ„åŒ–æ¨¡æ¿ï¼Œè€Œééšæ„ç”Ÿæˆã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.2 step 5
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ˆå½“å‰ `summarize_fn` å§”æ‰˜å¤–éƒ¨ï¼‰ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - Compaction æ¨¡å—å†…ç½®é»˜è®¤ `summarize_fn`ï¼Œæ„å»ºç»“æ„åŒ– prompt
  - æ‘˜è¦æ¨¡æ¿åŒ…å« 6 ä¸ªåˆ†ç±»ï¼šGoalã€Constraints & Preferencesã€Progressï¼ˆDone/In Progress/Blockedï¼‰ã€Key Decisionsã€Next Stepsã€Critical Context
  - è¿½åŠ æ–‡ä»¶æ“ä½œè®°å½•ï¼ˆread/write/edit æ±‡æ€»ï¼‰
  - ä½¿ç”¨ç‹¬ç«‹ system prompt é˜²æ­¢æ¨¡å‹ç»­å†™å¯¹è¯
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-COMPACT-017`ï¼šmock summarize_fn æ•è·è¾“å…¥ï¼Œæ–­è¨€åŒ…å«ç»“æ„åŒ–å­—æ®µæ ‡è®°ï¼ˆGoalã€Progress ç­‰ï¼‰
  - `BDD-COMPACT-018`ï¼šæ‘˜è¦è¾“å…¥åŒ…å«æ–‡ä»¶æ“ä½œæ±‡æ€»

#### 7.7 è¿­ä»£æ‘˜è¦æ›´æ–°

å½“å·²æœ‰å‰æ¬¡å‹ç¼©æ‘˜è¦æ—¶ï¼Œå¢é‡æ›´æ–°è€Œéä»å¤´ç”Ÿæˆã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.2 step 7
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - æ£€æµ‹æ˜¯å¦å·²æœ‰ compaction summary æ¡ç›®
  - æœ‰ â†’ ä½¿ç”¨ UPDATE_SUMMARIZATION_PROMPT å¢é‡åˆå¹¶æ–°ä¿¡æ¯
  - æ—  â†’ ä½¿ç”¨å®Œæ•´ SUMMARIZATION_PROMPT
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-COMPACT-019`ï¼šé¦–æ¬¡å‹ç¼©ï¼Œsummarize_fn æ”¶åˆ°å®Œæ•´ SUMMARIZATION prompt
  - `BDD-COMPACT-020`ï¼šäºŒæ¬¡å‹ç¼©ï¼Œsummarize_fn æ”¶åˆ° UPDATE prompt + å‰æ¬¡æ‘˜è¦å†…å®¹

### P2ï¼šå·¥å…·å±‚è¡¥å…¨

#### 7.8 Edit BOM/CRLF å¤„ç† + Diff ç”Ÿæˆ

æ¶æ„æ–‡æ¡£ Section A è¯¦ç»†æè¿°äº† 10 æ­¥ edit æµç¨‹ï¼Œå½“å‰å®ç°ç¼ºå°‘ BOMã€CRLFã€diff ä¸‰å—ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection A steps 4-6, 9-10ï¼›J.1 tests 3.1-3.5, 5.3
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯ï¼ˆDSL æ–‡ä»¶æ³¨é‡Šå·²æ ‡"å¾…åç»­è¡¥å……"ï¼‰
- **å®ç°è¦ç‚¹**ï¼š
  - BOM æ£€æµ‹ï¼ˆ`\uFEFF`ï¼‰â†’ å‰¥ç¦» â†’ åŒ¹é…/æ›¿æ¢ â†’ æ¢å¤
  - CRLF æ£€æµ‹ â†’ ç»Ÿä¸€è½¬ LF â†’ åŒ¹é…/æ›¿æ¢ â†’ æ¢å¤åŸå§‹è¡Œå°¾
  - Diff ç”Ÿæˆï¼š4 è¡Œä¸Šä¸‹æ–‡ unified diff + `first_changed_line`
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼Œå¯¹åº” J.1 tests 3.x, 5.3ï¼‰ï¼š
  - `BDD-EDIT-017`ï¼šCRLF æ–‡ä»¶è·¨å¹³å°åŒ¹é…
  - `BDD-EDIT-018`ï¼šCRLF è¡Œå°¾ä¿ç•™
  - `BDD-EDIT-019`ï¼šLF è¡Œå°¾ä¿ç•™ï¼ˆæ—  `\r\n` æ³¨å…¥ï¼‰
  - `BDD-EDIT-020`ï¼šæ··åˆè¡Œå°¾é‡å¤æ£€æµ‹
  - `BDD-EDIT-021`ï¼šBOM + CRLF è”åˆä¿ç•™
  - `BDD-EDIT-022`ï¼šdiff è¡Œå·æ­£ç¡®æ€§ï¼ˆè¿œç¦»æ–‡ä»¶å¼€å¤´ï¼‰

#### 7.9 Find å°Šé‡ .gitignore

å½“å‰ç”¨ `Path.wildcard`ï¼Œä¸æ”¯æŒ `.gitignore`ã€‚æ¶æ„æ–‡æ¡£æŒ‡å®šç”¨ `fd` + `--ignore-file`ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection Fï¼›J.6 test 2.1
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - æ”¶é›†ç›®å½•æ ‘ä¸­æ‰€æœ‰ `.gitignore` æ–‡ä»¶
  - æ”¹ç”¨ `fd` å‘½ä»¤æˆ–æ‰‹åŠ¨è§£æ `.gitignore` è§„åˆ™
  - ç»“æœä»æŒ‰ä¿®æ”¹æ—¶é—´æ’åº
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-FIND-008`ï¼š.gitignore ä¸­çš„æ–‡ä»¶ä¸å‡ºç°åœ¨ç»“æœé‡Œ

#### 7.10 Bash å¤§è¾“å‡ºæ»šåŠ¨ç¼“å†² + ä¸´æ—¶æ–‡ä»¶

å½“å‰ bash è¾“å‡ºè¶…é™ç›´æ¥æˆªæ–­ä¸¢å¼ƒã€‚æ¶æ„æ–‡æ¡£è¦æ±‚å†™ä¸´æ—¶æ–‡ä»¶ä¿ç•™å®Œæ•´è¾“å‡ºã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection Bï¼›J.2 tests 3.1, 3.2
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - å†…å­˜ä¿ç•™æœ€è¿‘ 100KB æ»šåŠ¨ç¼“å†²åŒº
  - æ€»è¾“å‡º > 50KB æ—¶å†™ä¸´æ—¶æ–‡ä»¶ `/tmp/gong-bash-{random}.log`
  - æˆªæ–­é€šçŸ¥åŒ…å«ä¸´æ—¶æ–‡ä»¶è·¯å¾„
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-BASH-015`ï¼šå¤§è¾“å‡ºåˆ›å»ºä¸´æ—¶æ–‡ä»¶
  - `BDD-BASH-016`ï¼šæˆªæ–­é€šçŸ¥åŒ…å«æ–‡ä»¶è·¯å¾„

---

## BDD è¦†ç›–ç¼ºå£æ±‡æ€»

| ç¼ºå£ | éœ€æ–°å¢åœºæ™¯ | å¯¹åº”æ¶æ„æµ‹è¯• |
|------|-----------|-------------|
| Steering ä¸­æ–­ | BDD-AGENT-031~032 | J.9 test 1.4 |
| Auto-retry | BDD-AGENT-033~035 | J.9 tests 4.3, 4.7, 5.1 |
| Auto-compaction | BDD-AGENT-036~037 | J.9 tests 4.3, 4.4 |
| tool_call/result é…å¯¹ | BDD-COMPACT-015~016 | J.9 tests 4.2, 4.6; Section 6.2 |
| ç»“æ„åŒ–æ‘˜è¦ prompt | BDD-COMPACT-017~018 | Section 6.2 step 5 |
| è¿­ä»£æ‘˜è¦æ›´æ–° | BDD-COMPACT-019~020 | Section 6.2 step 7 |
| Edit BOM/CRLF/Diff | BDD-EDIT-017~022 | J.1 tests 3.1-3.5, 5.3 |
| Find .gitignore | BDD-FIND-008 | J.6 test 2.1 |
| Bash ä¸´æ—¶æ–‡ä»¶ | BDD-BASH-015~016 | J.2 tests 3.1, 3.2 |
| Pi Bug å›å½’è¡¥å…¨ | BDD-AGENT-038~041 | J.9 tests 4.1, 4.2, 4.5, 4.6 |
| **åˆè®¡** | **24 ä¸ªæ–°åœºæ™¯** | |

---

## é˜¶æ®µå…«ï¼šPi-mono åŠŸèƒ½å¯¹é½

**ç›®æ ‡**ï¼šè¡¥é½ä¸ pi-mono æ ¸å¿ƒåŠŸèƒ½çš„å·®è·ï¼Œä½¿ Gong å…·å¤‡äº§å“çº§ Agent å¼•æ“èƒ½åŠ›ã€‚

**å‰ç½®æ¡ä»¶**ï¼šé˜¶æ®µä¸ƒå®Œæˆï¼ˆå†…éƒ¨æ”¹è¿›åœºæ™¯å…¨éƒ¨é€šè¿‡ï¼‰

### åŠŸèƒ½å¯¹é½æ€»è¡¨

| # | åŠŸèƒ½ | ä¼˜å…ˆçº§ | pi-mono æµ‹è¯•æ•° | Gong ç°æœ‰æµ‹è¯• | éœ€æ–°å¢ BDD åœºæ™¯ |
|---|------|--------|---------------|-------------|----------------|
| 1 | æµå¼è¾“å‡º | ğŸ”´ é«˜ | 110 | 2ï¼ˆåŸºç¡€ mockï¼‰ | 8 |
| 2 | å¤šæ¨¡å‹è¿è¡Œæ—¶åˆ‡æ¢ | ğŸ”´ é«˜ | 38 | 0 | 6 |
| 3 | Session æ ‘å½¢åˆ†æ”¯ | ğŸŸ¡ ä¸­ | 13 | 8ï¼ˆçº¿æ€§ forkï¼‰ | 6 |
| 4 | Abort ä¿¡å·ä¼ æ’­ | ğŸŸ¡ ä¸­ | 21 | 2ï¼ˆsteeringï¼‰ | 5 |
| 5 | Extension åŠ è½½/å‘ç° | ğŸŸ¡ ä¸­ | 45 | 0 | 6 |
| 6 | Follow-up æ¶ˆæ¯é˜Ÿåˆ— | ğŸŸ¢ ä½ | 1 | 0 | 2 |
| 7 | Settings ç®¡ç† | ğŸŸ¢ ä½ | 10 | 1ï¼ˆconfigure_agentï¼‰ | 3 |
| 8 | Resource å‘ç° | ğŸŸ¢ ä½ | 14 | 0 | 3 |
| 9 | åˆ†æ”¯æ‘˜è¦ | ğŸŸ¢ ä½ | 32 | 0 | 2 |
| 10 | truncate å·¥å…· | ğŸŸ¢ ä½ | 6 | 14ï¼ˆç³»ç»Ÿæˆªæ–­ï¼‰ | 2 |
| 11 | edit-diff å·¥å…· | ğŸŸ¢ ä½ | 42 | 22ï¼ˆå­—ç¬¦ä¸²æ›¿æ¢ï¼‰ | 3 |
| 12 | path-utils å·¥å…· | ğŸŸ¢ ä½ | 10 | 0ï¼ˆå„å·¥å…·å†…éƒ¨å¤„ç†ï¼‰ | 2 |
| | **åˆè®¡** | | **342** | **49** | **48** |

---

### P0ï¼šæµå¼è¾“å‡ºï¼ˆ8 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection 2.4ï¼ˆæµå¼æ¶ˆæ¯ç®¡ç†ï¼‰ã€Section 9 æµå¼ LLM
**pi-mono æµ‹è¯•**ï¼š`packages/ai/test/stream.test.ts` â€” 110 ä¸ªç”¨ä¾‹ï¼ˆ1,336 è¡Œï¼‰ï¼Œè¦†ç›– text/thinking/toolcall ä¸‰ç±»æµå¼äº‹ä»¶ã€è·¨ Provider æµå¼ã€ä¸­æ–­æ¢å¤
**Gong ç°çŠ¶**ï¼š
- `agent_integration.dsl` æœ‰ BDD-AGENT-027ï¼ˆstream äº‹ä»¶åºåˆ—ï¼‰å’Œ BDD-AGENT-028ï¼ˆstream + tool callsï¼‰ï¼Œä»… mock çº§åˆ«
- `instructions_v1.ex` æœ‰ `agent_stream` æŒ‡ä»¤ä½†ä»…éªŒè¯äº‹ä»¶ç±»å‹
- **æ— çœŸå® LLM æµå¼**ï¼ŒLiveLLM ä½¿ç”¨ `ReqLLM.generate_text`ï¼ˆéæµå¼ï¼‰

**å®ç°è¦ç‚¹**ï¼š
- ReqLLM å·²æ”¯æŒ `ReqLLM.stream_text/3`ï¼Œè¿”å› `Stream` æšä¸¾
- åœ¨ LiveLLM ä¸­å¢åŠ  `stream_chat/4`ï¼Œé€ chunk æ¨é€äº‹ä»¶
- MockLLM å¢åŠ  mock stream æ”¯æŒï¼ˆæ¨¡æ‹Ÿ partial message åˆ°è¾¾ï¼‰
- æµå¼ä¸­æ–­ï¼šstream è¿‡ç¨‹ä¸­æ”¶åˆ° steering æ¶ˆæ¯ â†’ ä¸­æ­¢æµã€ä¿ç•™å·²æ¥æ”¶å†…å®¹

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-STREAM-001`ï¼šçº¯æ–‡æœ¬æµå¼ â€” mock LLM åˆ† 3 æ¬¡æ¨é€ text deltaï¼Œæœ€ç»ˆæ‹¼æ¥å®Œæ•´
- `BDD-STREAM-002`ï¼štool call æµå¼ â€” æµå¼ä¼ è¾“ tool call å‚æ•° JSON
- `BDD-STREAM-003`ï¼šæµå¼ä¸­æ–­ â€” stream è¿›è¡Œä¸­æ¨é€ steeringï¼Œå‰©ä½™ chunk ä¸¢å¼ƒ
- `BDD-STREAM-004`ï¼šç©ºå†…å®¹ä¸­æ–­ â€” stream åˆšå¼€å§‹ï¼ˆæ— å®è´¨å†…å®¹ï¼‰æ—¶ä¸­æ–­ â†’ ä¸¢å¼ƒ partial message
- `BDD-STREAM-005`ï¼šæµå¼äº‹ä»¶åºåˆ— â€” æ–­è¨€ start â†’ deltaï¼ˆå¤šæ¬¡ï¼‰â†’ end é¡ºåº
- `BDD-STREAM-006`ï¼šæµå¼ + Hook on_context â€” Hook åœ¨æµå¼å‰å˜æ¢ä¸Šä¸‹æ–‡
- `BDD-STREAM-007`ï¼šæµå¼è¶…æ—¶ â€” LLM åœæ­¢æ¨é€è¶…è¿‡é˜ˆå€¼ â†’ è¶…æ—¶é”™è¯¯
- `BDD-STREAM-008`ï¼šE2E çœŸå® LLM æµå¼ â€” ä½¿ç”¨ `stream_chat_live` è°ƒç”¨çœŸå® DeepSeek æµå¼ API

---

### P0ï¼šå¤šæ¨¡å‹è¿è¡Œæ—¶åˆ‡æ¢ï¼ˆ6 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection 1 æ¶æ„å›¾ï¼ˆAgent Session å±‚"æ¨¡å‹åˆ‡æ¢"ï¼‰
**pi-mono æµ‹è¯•**ï¼š`packages/coding-agent/test/model-registry.test.ts` â€” 38 ä¸ªç”¨ä¾‹ï¼ˆ798 è¡Œï¼‰ï¼Œè¦†ç›– BaseURL è¦†ç›–ã€è‡ªå®šä¹‰æ¨¡å‹åˆå¹¶ã€API Key ç¼“å­˜ã€åŠ¨æ€åˆ·æ–°
**Gong ç°çŠ¶**ï¼š
- `Gong.Agent` ç¡¬ç¼–ç  `model: "deepseek:deepseek-chat"`
- `Gong.Providers.DeepSeek` åªæ³¨å†Œäº† DeepSeek ä¸€ä¸ª Provider
- ReqLLM åº•å±‚å·²æ”¯æŒ 17+ Providerï¼Œä½† Gong æ— è¿è¡Œæ—¶åˆ‡æ¢æœºåˆ¶
- **æ—  BDD åœºæ™¯**

**å®ç°è¦ç‚¹**ï¼š
- æ–°å¢ `Gong.ModelRegistry` æ¨¡å—ï¼šæ³¨å†Œå¯ç”¨æ¨¡å‹ã€è¿è¡Œæ—¶æŸ¥è¯¢ã€åˆ‡æ¢
- Agent åˆå§‹åŒ–æ—¶ä» config/env è¯»å–é»˜è®¤æ¨¡å‹
- æ”¯æŒè¿è¡Œæ—¶ `switch_model/2`ï¼ˆé€šè¿‡ strategy state ä¼ é€’ï¼‰
- API Key æŒ‰ Provider ä»ç¯å¢ƒå˜é‡è¯»å–ï¼ˆ`DEEPSEEK_API_KEY`ã€`OPENAI_API_KEY` ç­‰ï¼‰

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-MODEL-001`ï¼šé»˜è®¤æ¨¡å‹é…ç½® â€” configure_agent æŒ‡å®š modelï¼Œagent ä½¿ç”¨è¯¥æ¨¡å‹
- `BDD-MODEL-002`ï¼šè¿è¡Œæ—¶åˆ‡æ¢ â€” é¦–è½®ç”¨ model Aï¼Œä¸­é€”åˆ‡æ¢åˆ° model Bï¼Œç¬¬äºŒè½®ç”¨æ–°æ¨¡å‹
- `BDD-MODEL-003`ï¼šæ— æ•ˆæ¨¡å‹å›é€€ â€” æŒ‡å®šä¸å­˜åœ¨çš„ model â†’ å›é€€åˆ°é»˜è®¤
- `BDD-MODEL-004`ï¼šAPI Key ç¼ºå¤± â€” æŒ‡å®š Provider ä½†æ— å¯¹åº” API Key â†’ å‹å¥½é”™è¯¯
- `BDD-MODEL-005`ï¼šå¤š Provider æ³¨å†Œ â€” åŒæ—¶æ³¨å†Œ DeepSeek + OpenAIï¼ŒæŒ‰åé€‰æ‹©
- `BDD-MODEL-006`ï¼šE2E çœŸå®åˆ‡æ¢ â€” ä½¿ç”¨çœŸå® API éªŒè¯æ¨¡å‹åˆ‡æ¢åå“åº”æ ¼å¼æ­£ç¡®

---

### P1ï¼šSession æ ‘å½¢åˆ†æ”¯ï¼ˆ6 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection 7ï¼ˆä¼šè¯ç®¡ç†ï¼Œ"æ”¯æŒä»ä»»æ„èŠ‚ç‚¹åˆ†æ”¯"ï¼‰ã€Tapeå­˜å‚¨é‡è®¾è®¡.md
**pi-mono æµ‹è¯•**ï¼š
- `agent-session-branching.test.ts` â€” 3 ä¸ªç”¨ä¾‹ï¼ˆ156 è¡Œï¼‰ï¼šfork å•æ¡æ¶ˆæ¯ã€å†…å­˜ forkã€ä¸­é—´ fork
- `agent-session-tree-navigation.test.ts` â€” 10 ä¸ªç”¨ä¾‹ï¼ˆ319 è¡Œï¼‰ï¼šæ ‘å¯¼èˆªå’Œåˆ†æ”¯æ“ä½œ
**Gong ç°çŠ¶**ï¼š
- Tape æœ‰ fork/mergeï¼ˆBDD-TAPE-013~016, 027, 030, 032 å…± 8 ä¸ªåœºæ™¯ï¼‰
- ä½†æ˜¯**çº¿æ€§ anchor æ¨¡å‹**ï¼Œfork æ˜¯å¤åˆ¶è€Œéæ ‘å½¢åˆ†æ”¯
- æ—  leafId æŒ‡é’ˆã€æ— åˆ†æ”¯å¯¼èˆªã€æ— åˆ†æ”¯é—´åˆ‡æ¢

**å®ç°è¦ç‚¹**ï¼š
- Tape.Store å¢åŠ  `branch_from/2`ï¼šä»æŒ‡å®š anchor åˆ›å»ºåˆ†æ”¯
- Index å¢åŠ  `parent_anchor_id` å­—æ®µæ”¯æŒæ ‘å½¢å…³ç³»
- `navigate/2`ï¼šåˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯çš„å¶èŠ‚ç‚¹
- `branches/1`ï¼šåˆ—å‡ºå½“å‰ anchor çš„æ‰€æœ‰åˆ†æ”¯
- ä¸Šä¸‹æ–‡æ„å»ºæ—¶æ²¿åˆ†æ”¯è·¯å¾„å›æº¯åˆ°æ ¹

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-SESSION-001`ï¼šä»ä¸­é—´ anchor åˆ†æ”¯ â€” ç¬¬ 3 ä¸ª anchor å¤„ branchï¼Œä¸¤æ¡è·¯å¾„ç‹¬ç«‹
- `BDD-SESSION-002`ï¼šåˆ†æ”¯å¯¼èˆª â€” åœ¨ä¸¤ä¸ªåˆ†æ”¯é—´åˆ‡æ¢ï¼Œå„è‡ªå†…å®¹æ­£ç¡®
- `BDD-SESSION-003`ï¼šåˆ†æ”¯ä¸Šä¸‹æ–‡æ„å»º â€” åœ¨åˆ†æ”¯ B ä¸Š build context åªåŒ…å«æ ¹â†’B è·¯å¾„
- `BDD-SESSION-004`ï¼šæ·±åº¦åˆ†æ”¯ â€” åˆ†æ”¯çš„åˆ†æ”¯ï¼ˆ3 å±‚æ ‘ï¼‰ï¼Œå¯¼èˆªåˆ°å¶èŠ‚ç‚¹æ­£ç¡®
- `BDD-SESSION-005`ï¼šåˆ†æ”¯åè¿½åŠ  â€” åˆ†æ”¯ååœ¨æ–°è·¯å¾„è¿½åŠ æ¶ˆæ¯ä¸å½±å“åŸè·¯å¾„
- `BDD-SESSION-006`ï¼šåˆ†æ”¯åˆ—è¡¨ â€” branches/1 è¿”å›æ‰€æœ‰ç›´æ¥å­åˆ†æ”¯

---

### P1ï¼šAbort ä¿¡å·ä¼ æ’­ï¼ˆ5 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection 2.4ï¼ˆabort ä¸­æ–­åˆ¤æ–­ï¼‰ã€Section Bï¼ˆbash abortï¼‰
**pi-mono æµ‹è¯•**ï¼š`packages/ai/test/abort.test.ts` â€” 21 ä¸ªç”¨ä¾‹ï¼ˆ260 è¡Œï¼‰ï¼Œè¦†ç›–ä¸­é€” abortã€ç«‹å³ abortã€abort åç»­å¯¹è¯ã€è·¨ Provider abort
**Gong ç°çŠ¶**ï¼š
- Steering ç³»ç»Ÿæœ‰ 2 ä¸ªåœºæ™¯ï¼ˆBDD-STEER-001~002ï¼‰ï¼Œä»…æµ‹é˜Ÿåˆ—æ“ä½œ
- OTP è¿›ç¨‹å¯ä»¥è¢«æ€ï¼Œä½†æ— ç»“æ„åŒ–çš„ abort ä¼ æ’­
- å·¥å…·æ‰§è¡Œä¸­æ—  abort æ£€æŸ¥
- LLM è°ƒç”¨ä¸­æ— ä¸­æ–­æœºåˆ¶

**å®ç°è¦ç‚¹**ï¼š
- æ–°å¢ `Gong.Abort` æ¨¡å—ï¼šåŸºäº `Process.flag(:trap_exit, true)` + ä¿¡å·
- Agent å¾ªç¯æ¯æ­¥æ£€æŸ¥ abort çŠ¶æ€ï¼ˆtool æ‰§è¡Œå‰ã€LLM è°ƒç”¨å‰ï¼‰
- Bash å·¥å…·ï¼šabort æ—¶æ€è¿›ç¨‹æ ‘ï¼ˆå·²æœ‰ `kill_process_tree`ï¼Œéœ€æŒ‚æ¥ä¿¡å·ï¼‰
- LLM æµå¼ï¼šabort æ—¶å…³é—­è¿æ¥ï¼ˆReqLLM æ”¯æŒ cancelï¼‰
- è¢« abort çš„ partial å†…å®¹ä¿ç•™ä½†æ ‡è®°ä¸º incomplete

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-ABORT-001`ï¼šå·¥å…·æ‰§è¡Œä¸­ abort â€” bash è¿è¡Œè€—æ—¶å‘½ä»¤ï¼Œå‘é€ abort â†’ è¿›ç¨‹è¢«æ€ã€è¿”å›ä¸­æ–­ç»“æœ
- `BDD-ABORT-002`ï¼šå¤šå·¥å…· abort â€” 3 ä¸ª pending toolsï¼Œç¬¬ 1 ä¸ªæ‰§è¡Œå abort â†’ å‰©ä½™ 2 ä¸ªè·³è¿‡
- `BDD-ABORT-003`ï¼šLLM ç­‰å¾…ä¸­ abort â€” ç­‰å¾… LLM å“åº”æ—¶ abort â†’ è¿”å› aborted é”™è¯¯
- `BDD-ABORT-004`ï¼šabort åæ¢å¤ â€” abort åå‘é€æ–° promptï¼Œagent æ­£å¸¸å“åº”
- `BDD-ABORT-005`ï¼špartial content ä¿ç•™ â€” LLM å·²è¿”å›éƒ¨åˆ†å†…å®¹æ—¶ abort â†’ ä¿ç•™ partial æ–‡æœ¬

---

### P1ï¼šExtension åŠ è½½/å‘ç°ï¼ˆ6 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection 10ï¼ˆåç»­æ‰©å±•"+1000 è¡Œ"ï¼‰
**pi-mono æµ‹è¯•**ï¼š
- `extensions-runner.test.ts` â€” 18 ä¸ªç”¨ä¾‹ï¼ˆ510 è¡Œï¼‰ï¼šå¿«æ·å‘½ä»¤å†²çªã€å·¥å…·æ”¶é›†ã€é”™è¯¯å¤„ç†
- `extensions-discovery.test.ts` â€” 27 ä¸ªç”¨ä¾‹ï¼ˆ463 è¡Œï¼‰ï¼š.ts/.js å‘ç°ã€å­ç›®å½• indexã€åµŒå¥—å‘ç°
**Gong ç°çŠ¶**ï¼š
- `Gong.Hook` behaviour å®šä¹‰ 6 ä¸ªå›è°ƒ â€” è¿™æ˜¯ Gong çš„"æ‹¦æˆª"æœºåˆ¶
- ä½†æ— è¿è¡Œæ—¶æ’ä»¶å‘ç°/åŠ è½½ï¼šHook æ¨¡å—å¿…é¡»åœ¨ç¼–è¯‘æ—¶æ³¨å†Œ
- Jido æœ‰ plugin systemï¼ˆ`Jido.Plugin`ï¼‰ä½† Gong æœªä½¿ç”¨
- **æ—  BDD åœºæ™¯**

**å®ç°è¦ç‚¹**ï¼š
- æ–°å¢ `Gong.Extension.Loader`ï¼šæ‰«æ `~/.gong/extensions/` å’Œ `{workspace}/.gong/extensions/`
- æ”¯æŒ `.ex` æ–‡ä»¶åŠ¨æ€ç¼–è¯‘åŠ è½½ï¼ˆ`Code.compile_file/1`ï¼‰
- Extension æ¥å£ç»§æ‰¿ `Gong.Hook` + å¢åŠ  `tools/0`ï¼ˆè‡ªå®šä¹‰å·¥å…·ï¼‰å’Œ `commands/0`ï¼ˆæ–œæ å‘½ä»¤ï¼‰
- `Gong.Extension.Runner`ï¼šç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆload â†’ init â†’ run â†’ cleanupï¼‰
- é”™è¯¯éš”ç¦»ï¼šå•ä¸ª extension å´©æºƒä¸å½±å“ Agent

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-EXTEND-001`ï¼šå‘ç° .ex æ–‡ä»¶ â€” åœ¨ extensions/ æ”¾ç½® .ex â†’ Loader å‘ç°å¹¶åŠ è½½
- `BDD-EXTEND-002`ï¼šHook å›è°ƒæ³¨å†Œ â€” åŠ è½½çš„ Extension çš„ before_tool_call ç”Ÿæ•ˆ
- `BDD-EXTEND-003`ï¼šè‡ªå®šä¹‰å·¥å…·æ³¨å†Œ â€” Extension æä¾›çš„å·¥å…·å‡ºç°åœ¨å¯ç”¨å·¥å…·åˆ—è¡¨
- `BDD-EXTEND-004`ï¼šåŠ è½½å¤±è´¥éš”ç¦» â€” æœ‰è¯­æ³•é”™è¯¯çš„ .ex æ–‡ä»¶ â†’ è·³è¿‡å¹¶è®°å½•é”™è¯¯ï¼Œå…¶ä»– Extension ä¸å—å½±å“
- `BDD-EXTEND-005`ï¼šå¤š Extension ä¼˜å…ˆçº§ â€” ä¸¤ä¸ª Extension å®šä¹‰åŒåå·¥å…· â†’ ååŠ è½½è¦†ç›–
- `BDD-EXTEND-006`ï¼šExtension ç”Ÿå‘½å‘¨æœŸ â€” åŠ è½½ â†’ init å›è°ƒ â†’ Agent è¿è¡Œ â†’ cleanup å›è°ƒ

---

### P2ï¼šFollow-up æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ2 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection 2.2ï¼ˆä¸‰ç§æ¶ˆæ¯æ³¨å…¥æœºåˆ¶ â€” follow-upï¼‰
**pi-mono æµ‹è¯•**ï¼š`agent-session-auto-compaction-queue.test.ts` â€” 1 ä¸ªç”¨ä¾‹ï¼ˆ97 è¡Œï¼‰
**Gong ç°çŠ¶**ï¼š
- ä»…æœ‰ Steering å•ä¸€é˜Ÿåˆ—
- Agent å¾ªç¯æ— å¤–å±‚ follow-up æ£€æŸ¥
- å¤šè½®å¯¹è¯é€šè¿‡å¤–éƒ¨è°ƒç”¨ `agent_chat_continue` å®ç°

**å®ç°è¦ç‚¹**ï¼š
- Steering å¢åŠ  `push_follow_up/2`ï¼šåŒºåˆ†"ä¸­æ–­æ¶ˆæ¯"å’Œ"åç»­æ¶ˆæ¯"
- Agent å¾ªç¯å®Œæˆåæ£€æŸ¥ follow-up é˜Ÿåˆ—ï¼Œæœ‰åˆ™è‡ªåŠ¨ç»§ç»­

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-FOLLOWUP-001`ï¼šAgent å®Œæˆåæœ‰ follow-up â†’ è‡ªåŠ¨å¼€å§‹ä¸‹ä¸€è½®
- `BDD-FOLLOWUP-002`ï¼šfollow-up ä¸ steering åŒæ—¶å­˜åœ¨ â†’ steering ä¼˜å…ˆä¸­æ–­å½“å‰ï¼Œfollow-up æ’é˜Ÿ

---

### P2ï¼šSettings ç®¡ç†ï¼ˆ3 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šæ— ç›´æ¥å‡ºå¤„ï¼ˆpi-mono ç‰¹æœ‰åŠŸèƒ½ï¼‰
**pi-mono æµ‹è¯•**ï¼š`settings-manager.test.ts` â€” 10 ä¸ªç”¨ä¾‹ï¼ˆ227 è¡Œï¼‰ï¼Œè¦†ç›–å¤–éƒ¨ä¿®æ”¹ä¿ç•™ã€ä¸»é¢˜åˆ‡æ¢ã€å†…å­˜è¦†ç›–
**Gong ç°çŠ¶**ï¼š
- ä½¿ç”¨ `Application.compile_env` é™æ€é…ç½®
- `configure_agent` BDD æŒ‡ä»¤ä»…åœ¨æµ‹è¯•æ—¶è®¾ç½®å‚æ•°

**å®ç°è¦ç‚¹**ï¼š
- æ–°å¢ `Gong.Settings`ï¼šETS + æ–‡ä»¶æŒä¹…åŒ–
- æ”¯æŒå…¨å±€ï¼ˆ`~/.gong/settings.json`ï¼‰+ é¡¹ç›®çº§ï¼ˆ`{workspace}/.gong/settings.json`ï¼‰
- è¿è¡Œæ—¶è¯»å†™ï¼Œé¡¹ç›®çº§è¦†ç›–å…¨å±€

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-SETTINGS-001`ï¼šè¯»å–é»˜è®¤è®¾ç½® â€” æ— é…ç½®æ–‡ä»¶æ—¶è¿”å›é»˜è®¤å€¼
- `BDD-SETTINGS-002`ï¼šé¡¹ç›®çº§è¦†ç›– â€” å…¨å±€ model=Aï¼Œé¡¹ç›®çº§ model=B â†’ ç”Ÿæ•ˆ B
- `BDD-SETTINGS-003`ï¼šè¿è¡Œæ—¶ä¿®æ”¹ â€” ä¿®æ”¹ setting åç«‹å³ç”Ÿæ•ˆ

---

### P2ï¼šResource å‘ç°ï¼ˆ3 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection 2.2ï¼ˆsystem prompt æ„å»ºä¸­æ³¨å…¥ context æ–‡ä»¶ï¼‰
**pi-mono æµ‹è¯•**ï¼š`resource-loader.test.ts` â€” 14 ä¸ªç”¨ä¾‹ï¼ˆ363 è¡Œï¼‰ï¼Œè¦†ç›– skill/prompt/theme/extension å‘ç°ã€è¦†ç›–ã€reload
**Gong ç°çŠ¶**ï¼š
- `Gong.Prompt` ç¡¬ç¼–ç ç³»ç»Ÿæç¤ºè¯æ¨¡æ¿
- æ— æ–‡ä»¶çº§ prompt æ¨¡æ¿ã€skill å®šä¹‰ã€context æ–‡ä»¶è‡ªåŠ¨å‘ç°

**å®ç°è¦ç‚¹**ï¼š
- æ–°å¢ `Gong.ResourceLoader`ï¼šæ‰«æ `~/.gong/` + `{workspace}/.gong/`
- æ”¯æŒæ–‡ä»¶ç±»å‹ï¼š`prompts/*.md`ã€`skills/*.md`ã€`context/*.md`
- system prompt æ„å»ºæ—¶è‡ªåŠ¨æ³¨å…¥å‘ç°çš„ context æ–‡ä»¶
- æ”¯æŒ reloadï¼ˆæ–‡ä»¶å˜æ›´ååˆ·æ–°ï¼‰

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-RESOURCE-001`ï¼šå‘ç° context æ–‡ä»¶ â€” workspace/.gong/context/rules.md â†’ æ³¨å…¥ system prompt
- `BDD-RESOURCE-002`ï¼šå…¨å±€ + é¡¹ç›®çº§åˆå¹¶ â€” ä¸¤çº§ç›®å½•çš„èµ„æºåˆå¹¶ï¼Œé¡¹ç›®çº§ä¼˜å…ˆ
- `BDD-RESOURCE-003`ï¼šreload åˆ·æ–° â€” ä¿®æ”¹æ–‡ä»¶åè°ƒç”¨ reload â†’ æ–°å†…å®¹ç”Ÿæ•ˆ

---

### P2ï¼šåˆ†æ”¯æ‘˜è¦ï¼ˆ2 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection 7ï¼ˆä¼šè¯ç®¡ç†ï¼Œåˆ†æ”¯æ‘˜è¦ç”Ÿæˆï¼‰
**pi-mono æµ‹è¯•**ï¼š`compaction.test.ts` ä¸­ branch summary ç›¸å…³ â€” çº¦ 5 ä¸ªç”¨ä¾‹
**Gong ç°çŠ¶**ï¼š
- Compaction æœ‰æ‘˜è¦ç”Ÿæˆï¼Œä½†æ— åˆ†æ”¯æ‘˜è¦
- éœ€è¦ Session æ ‘å½¢åˆ†æ”¯ï¼ˆP1ï¼‰å…ˆå®Œæˆ

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-BRANCHSUM-001`ï¼šåˆ‡æ¢åˆ†æ”¯æ—¶ç”Ÿæˆæ‘˜è¦ â€” ç¦»å¼€åˆ†æ”¯ A â†’ è‡ªåŠ¨ç”Ÿæˆ A çš„æ‘˜è¦
- `BDD-BRANCHSUM-002`ï¼šæ‘˜è¦å†…å®¹æ­£ç¡® â€” æ‘˜è¦åŒ…å«åˆ†æ”¯ä¸­çš„å…³é”®æ“ä½œå’Œç»“æœ

---

### P2ï¼štruncate å·¥å…·ï¼ˆ2 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šæ— ç›´æ¥å‡ºå¤„ï¼ˆpi-mono è®¾è®¡é€‰æ‹©ï¼šLLM å¯è°ƒç”¨ vs Gong ç³»ç»Ÿè‡ªåŠ¨ï¼‰
**pi-mono æµ‹è¯•**ï¼š`truncate-to-width.test.ts` â€” 6 ä¸ªç”¨ä¾‹ï¼ˆ81 è¡Œï¼‰
**Gong ç°çŠ¶**ï¼š
- `Gong.Truncate` ç³»ç»Ÿçº§è‡ªåŠ¨æˆªæ–­ï¼Œ14 ä¸ª BDD åœºæ™¯
- LLM æ— æ³•ä¸»åŠ¨è¯·æ±‚æˆªæ–­ç‰¹å®šè¾“å‡º
- è®¾è®¡å†³ç­–ï¼šæ˜¯å¦éœ€è¦æš´éœ²ç»™ LLM å¾…è®¨è®º

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-TRUNCTOOL-001`ï¼šLLM è°ƒç”¨ truncate å·¥å…· â€” ä¼ å…¥é•¿æ–‡æœ¬ + max_lines â†’ è¿”å›æˆªæ–­ç»“æœ
- `BDD-TRUNCTOOL-002`ï¼štruncate ä¸ç³»ç»Ÿæˆªæ–­çš„äº¤äº’ â€” å·¥å…·æˆªæ–­åç³»ç»Ÿä¸å†é‡å¤æˆªæ–­

---

### P2ï¼šedit-diff å·¥å…·ï¼ˆ3 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection A step 10ï¼ˆdiff ç”Ÿæˆï¼š4 è¡Œä¸Šä¸‹æ–‡ unified diffï¼‰
**pi-mono æµ‹è¯•**ï¼š`tools.test.ts` â€” 42 ä¸ªç”¨ä¾‹ï¼ˆ638 è¡Œï¼‰ä¸­ diff ç›¸å…³çº¦ 8 ä¸ª
**Gong ç°çŠ¶**ï¼š
- Edit ä½¿ç”¨å­—ç¬¦ä¸²ç²¾ç¡®åŒ¹é… + æ¨¡ç³ŠåŒ¹é…ï¼Œ22 ä¸ª BDD åœºæ™¯
- å·²æœ‰ç®€å• diff è¾“å‡ºï¼ˆåœ¨ edit ç»“æœä¸­ï¼‰
- æ—  unified diff ä½œä¸ºè¾“å…¥æ ¼å¼

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-EDITDIFF-001`ï¼šunified diff è¾“å…¥ â€” ä¼ å…¥ diff æ ¼å¼ â†’ æ­£ç¡®åº”ç”¨ä¿®æ”¹
- `BDD-EDITDIFF-002`ï¼šdiff è¡Œå·åç§» â€” ä¿®æ”¹ä½ç½®ä¸æ–‡ä»¶è¡Œå·æœ‰åç§»æ—¶ä»èƒ½æ­£ç¡®å®šä½
- `BDD-EDITDIFF-003`ï¼šdiff + å­—ç¬¦ä¸²æ›¿æ¢å…±å­˜ â€” ä¸¤ç§ edit æ¨¡å¼åœ¨åŒä¸€ agent ä¼šè¯ä¸­äº¤æ›¿ä½¿ç”¨

---

### P2ï¼špath-utils å·¥å…·ï¼ˆ2 ä¸ªåœºæ™¯ï¼‰

**æ¶æ„å‡ºå¤„**ï¼šSection Aï¼ˆè·¯å¾„æ‰©å±• macOS + NFS + Dockerï¼‰
**pi-mono æµ‹è¯•**ï¼š`path-utils.test.ts` â€” 10 ä¸ªç”¨ä¾‹ï¼ˆ147 è¡Œï¼‰ï¼Œè¦†ç›– ~ æ‰©å±•ã€Unicode ç©ºæ ¼è§„èŒƒåŒ–ã€NFC/NFDã€å¼¯å¼•å·
**Gong ç°çŠ¶**ï¼š
- å„å·¥å…·å†…éƒ¨åˆ†åˆ«å¤„ç†è·¯å¾„ï¼ˆRead/Write/Edit å„è‡ªæœ‰ `Path.expand`ï¼‰
- æ— ç»Ÿä¸€çš„è·¯å¾„è§„èŒƒåŒ–å·¥å…·
- macOS NFD å˜ä½“å¤„ç†æœªè¦†ç›–

**BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
- `BDD-PATHUTIL-001`ï¼šè·¯å¾„è§„èŒƒåŒ– â€” ~ã€ç›¸å¯¹è·¯å¾„ã€. å’Œ .. ä¸€è‡´å¤„ç†
- `BDD-PATHUTIL-002`ï¼šmacOS NFD å˜ä½“ â€” NFD ç¼–ç çš„æ–‡ä»¶å â†’ æ­£ç¡®è§£æ

---

## BDD è¦†ç›–ç¼ºå£æ±‡æ€»ï¼ˆPhase VII + Phase VIIIï¼‰

### Phase VIIï¼ˆå†…éƒ¨æ”¹è¿›ï¼‰

| ç¼ºå£ | éœ€æ–°å¢åœºæ™¯ | å¯¹åº”æ¶æ„æµ‹è¯• |
|------|-----------|-------------|
| Steering ä¸­æ–­ | BDD-AGENT-031~032 | J.9 test 1.4 |
| Auto-retry | BDD-AGENT-033~035 | J.9 tests 4.3, 4.7, 5.1 |
| Auto-compaction | BDD-AGENT-036~037 | J.9 tests 4.3, 4.4 |
| tool_call/result é…å¯¹ | BDD-COMPACT-015~016 | J.9 tests 4.2, 4.6 |
| ç»“æ„åŒ–æ‘˜è¦ prompt | BDD-COMPACT-017~018 | Section 6.2 step 5 |
| è¿­ä»£æ‘˜è¦æ›´æ–° | BDD-COMPACT-019~020 | Section 6.2 step 7 |
| Edit BOM/CRLF/Diff | BDD-EDIT-017~022 | J.1 tests 3.1-3.5, 5.3 |
| Find .gitignore | BDD-FIND-008 | J.6 test 2.1 |
| Bash ä¸´æ—¶æ–‡ä»¶ | BDD-BASH-015~016 | J.2 tests 3.1, 3.2 |
| **å°è®¡** | **20 ä¸ªæ–°åœºæ™¯** | |

### Phase VIIIï¼ˆPi-mono åŠŸèƒ½å¯¹é½ï¼‰

| ç¼ºå£ | ä¼˜å…ˆçº§ | éœ€æ–°å¢åœºæ™¯ | pi-mono å¯¹åº”æµ‹è¯•æ•° |
|------|--------|-----------|-------------------|
| æµå¼è¾“å‡º | P0 | BDD-STREAM-001~008 | 110 |
| å¤šæ¨¡å‹åˆ‡æ¢ | P0 | BDD-MODEL-001~006 | 38 |
| Session åˆ†æ”¯ | P1 | BDD-SESSION-001~006 | 13 |
| Abort ä¿¡å· | P1 | BDD-ABORT-001~005 | 21 |
| Extension ç³»ç»Ÿ | P1 | BDD-EXTEND-001~006 | 45 |
| Follow-up é˜Ÿåˆ— | P2 | BDD-FOLLOWUP-001~002 | 1 |
| Settings ç®¡ç† | P2 | BDD-SETTINGS-001~003 | 10 |
| Resource å‘ç° | P2 | BDD-RESOURCE-001~003 | 14 |
| åˆ†æ”¯æ‘˜è¦ | P2 | BDD-BRANCHSUM-001~002 | 5 |
| truncate å·¥å…· | P2 | BDD-TRUNCTOOL-001~002 | 6 |
| edit-diff å·¥å…· | P2 | BDD-EDITDIFF-001~003 | 8 |
| path-utils å·¥å…· | P2 | BDD-PATHUTIL-001~002 | 10 |
| **å°è®¡** | | **48 ä¸ªæ–°åœºæ™¯** | **281** |

### æ€»è®¡

| èŒƒå›´ | ç°æœ‰æµ‹è¯• | Phase VII | Phase VIII | æ€»è®¡ |
|------|---------|-----------|-----------|------|
| BDD åœºæ™¯æ•° | 244 | +24ï¼ˆå« 4 ä¸ª Pi Bug å›å½’ï¼‰ | +48 | **316** |
| æµ‹è¯•è¦†ç›–ç‡ | å·²å®ç°åŠŸèƒ½ 100% | å†…éƒ¨æ”¹è¿› + Bug å›å½’ | Pi-mono å¯¹é½ | â€” |

---

## å®æ–½é¡ºåºä¸æµ‹è¯•æ­¥éª¤

### ä¾èµ–å…³ç³»å›¾

```
Phase VIIï¼ˆå…ˆè¿˜æµ‹è¯•å€ºåŠ¡ï¼‰
â”‚
â”œâ”€ â‘  Pi Bug å›å½’ (038-041)
â”œâ”€ â‘¡ Steering é›†æˆ (031-032)         â† ä¾èµ– â‘ 
â”œâ”€ â‘¢ Auto-retry é›†æˆ (033-035)       â† ä¾èµ– â‘ 
â””â”€ â‘£ Auto-compaction é›†æˆ (036-037)  â† ä¾èµ– â‘ 
      â”‚
Phase VIIIï¼ˆåŠŸèƒ½å¯¹é½ï¼‰
      â”‚
â”œâ”€ P0ï¼ˆå¿…é¡»ï¼‰
â”‚   â”œâ”€ â‘¤ æµå¼è¾“å‡º (STREAM-001~008)     â† ä¾èµ– Phase VII å®Œæˆ
â”‚   â””â”€ â‘¥ å¤šæ¨¡å‹åˆ‡æ¢ (MODEL-001~006)    â† å¯ä¸ â‘¤ å¹¶è¡Œ
â”‚
â”œâ”€ P1ï¼ˆé‡è¦ï¼‰
â”‚   â”œâ”€ â‘¦ Abort ä¿¡å· (ABORT-001~005)    â† ä¾èµ– â‘¤ æµå¼
â”‚   â”œâ”€ â‘§ Session åˆ†æ”¯ (SESSION-001~006) â† ç‹¬ç«‹ï¼Œå¯ä¸ â‘¤â‘¥â‘¦ å¹¶è¡Œ
â”‚   â””â”€ â‘¨ Extension ç³»ç»Ÿ (EXTEND-001~006) â† ç‹¬ç«‹ï¼Œå¯å¹¶è¡Œ
â”‚
â””â”€ P2ï¼ˆå®Œå–„ï¼‰
    â”œâ”€ â‘© åˆ†æ”¯æ‘˜è¦ (BRANCHSUM-001~002)   â† ä¾èµ– â‘§
    â”œâ”€ â‘ª Follow-up é˜Ÿåˆ— (FOLLOWUP-001~002)
    â”œâ”€ â‘« Settings (SETTINGS-001~003)
    â”œâ”€ â‘¬ Resource å‘ç° (RESOURCE-001~003)
    â””â”€ â‘­ å·¥å…·è¡¥å…¨ (TRUNCTOOL + EDITDIFF + PATHUTIL)
```

### åˆ†æ‰¹äº¤ä»˜è®¡åˆ’

---

#### ç¬¬ä¸€æ‰¹ï¼šPhase VII æ”¶å°¾ï¼ˆ11 ä¸ªåœºæ™¯ï¼‰ âœ… å·²å®Œæˆ

åšå®Œåæ‰€æœ‰ç°æœ‰åŠŸèƒ½æœ‰å®Œæ•´çš„é›†æˆçº§ BDD è¦†ç›–ã€‚
**éªŒæ”¶ç»“æœ**ï¼š256 tests, 0 failuresï¼ˆå« 11 ä¸ªæ–°åœºæ™¯ BDD-AGENT-031~041ï¼‰

##### Step â‘  Pi Bug å›å½’ï¼ˆ4 ä¸ªåœºæ™¯ï¼‰ âœ…

ä¸éœ€è¦æ–°æ¨¡å—ï¼ŒéªŒè¯ç°æœ‰ä»£ç è¡Œä¸ºæ˜¯å¦æ­£ç¡®ã€‚

**å®ç°æ­¥éª¤**ï¼š
1. åœ¨ `docs/bdd/agent_integration.dsl` æœ«å°¾è¿½åŠ  4 ä¸ªåœºæ™¯ï¼ˆBDD-AGENT-038~041ï¼‰
2. `bddc compile` ç”Ÿæˆæµ‹è¯•
3. `mix test test/bdd_generated/agent_integration_generated_test.exs` è¿è¡Œ

**å…·ä½“å®ç°**ï¼š

`BDD-AGENT-038`ï¼ˆå¹¶å‘ç«æ€ï¼‰ï¼š
- GIVENï¼šconfigure_agent + mock_llm_responseï¼ˆæ…¢å“åº”ï¼Œsleep æ¨¡æ‹Ÿï¼‰
- WHENï¼šagent_chatï¼ˆç¬¬ä¸€è½®ï¼‰ï¼Œ**åŒæ—¶** agent_chatï¼ˆç¬¬äºŒè½®ï¼‰
- THENï¼šç¬¬äºŒä¸ªè¯·æ±‚è¢«æ‹’ç»ï¼ˆè¿”å› :busy æˆ–æ’é˜Ÿï¼‰
- **ä»£ç æ”¹åŠ¨**ï¼šMockLLM.run_chat å…¥å£åŠ é”ï¼ˆ`Process.put(:gong_agent_busy, true)`ï¼‰ï¼Œå¿™æ—¶è¿”å› `{:error, :busy, agent}`
- **å¯èƒ½éœ€è¦æ–° BDD æŒ‡ä»¤**ï¼š`agent_chat_concurrent` â€” ç”¨ `Task.async` åŒæ—¶å‘èµ·ä¸¤æ¬¡ chat

`BDD-AGENT-039`ï¼ˆå­¤å„¿ tool_resultï¼‰ï¼š
- GIVENï¼šconfigure_agent + mock ä¸¤ä¸ª tool_call å“åº” + steering åœ¨ç¬¬ä¸€ä¸ª tool åä¸­æ–­
- WHENï¼šagent_chatï¼Œç¬¬ä¸€ä¸ª tool æ‰§è¡Œå steering ä¸­æ–­è·³è¿‡ç¬¬äºŒä¸ª
- THENï¼šä¸‹ä¸€è½® agent_chat_continue ä¸æŠ¥é”™ï¼ˆå­¤å„¿ tool_result å·²æ¸…ç†ï¼‰
- **ä»£ç æ”¹åŠ¨**ï¼šMockLLM.execute_pending_tools ä¸­ï¼Œè¢«è·³è¿‡çš„ tool ç”Ÿæˆçš„ skip result è¦æ­£ç¡®å›ä¼ ç»™ ReAct ç­–ç•¥
- **ä¾èµ–**ï¼šéœ€è¦ â‘¡ Steering é›†æˆå…ˆå®Œæˆï¼Œæˆ–åŒæ—¶å®ç°

`BDD-AGENT-040`ï¼ˆéæ•°ç»„ contentï¼‰ï¼š
- GIVENï¼šconfigure_agent + mock_llm_response è¿”å› content ä¸ºçº¯å­—ç¬¦ä¸²ï¼ˆä¸æ˜¯ listï¼‰
- WHENï¼šagent_chat
- THENï¼šassert_no_crash + assert_agent_reply æ­£å¸¸
- **ä»£ç æ”¹åŠ¨**ï¼šæ£€æŸ¥ MockLLM/LiveLLM çš„ `build_llm_result_from_response` æ˜¯å¦èƒ½å¤„ç†å­—ç¬¦ä¸² content
- **å¯èƒ½æ— éœ€æ”¹ä»£ç **ï¼ŒElixir æ¨¡å¼åŒ¹é…å¤©ç„¶å…¼å®¹

`BDD-AGENT-041`ï¼ˆç»“æœä¸é”™ä½ï¼‰ï¼š
- GIVENï¼šconfigure_agent + create_temp_file a.txt/b.txt/c.txt + mock_llm_response ä¸€æ¬¡è¿”å› 3 ä¸ª tool_call
- WHENï¼šagent_chat prompt="è¯»å–ä¸‰ä¸ªæ–‡ä»¶"
- THENï¼šassert_tool_was_called tool="read_file" 3 æ¬¡ + æ¯ä¸ªç»“æœå¯¹åº”æ­£ç¡®æ–‡ä»¶å†…å®¹
- **ä»£ç æ”¹åŠ¨**ï¼šæ— ï¼ˆç°æœ‰ execute_pending_tools æŒ‰ tool_call_id å›ä¼ ï¼Œä½†éœ€è¦éªŒè¯ï¼‰
- **å¯èƒ½éœ€è¦æ–° BDD æŒ‡ä»¤**ï¼š`assert_tool_result_matches call_index=0 contains="Content A"`

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/agent_integration_generated_test.exs --trace
# é¢„æœŸï¼š30 ä¸ªæ—§åœºæ™¯ + 4 ä¸ªæ–°åœºæ™¯å…¨éƒ¨é€šè¿‡
```

##### Step â‘¡ Steering é›†æˆï¼ˆ2 ä¸ªåœºæ™¯ï¼‰ âœ…

è®© Agent å¾ªç¯åœ¨å·¥å…·æ‰§è¡ŒæœŸé—´çœŸæ­£å“åº” steering ä¸­æ–­ã€‚

**å®ç°æ­¥éª¤**ï¼š
1. ä¿®æ”¹ `test/support/mock_llm.ex` çš„ `execute_pending_tools`ï¼šæ¯ä¸ª tool æ‰§è¡Œåè°ƒç”¨ `Gong.Steering.check/1`
2. ä¿®æ”¹ `test/support/live_llm.ex` åŒæ­¥æ”¹åŠ¨
3. åœ¨ `docs/bdd/agent_integration.dsl` è¿½åŠ  2 ä¸ªåœºæ™¯
4. å¯èƒ½éœ€è¦æ–° BDD æŒ‡ä»¤ï¼š`inject_steering_during_tool` â€” åœ¨å·¥å…·æ‰§è¡Œå›è°ƒä¸­æ³¨å…¥ steering æ¶ˆæ¯

**å…·ä½“å®ç°**ï¼š

`BDD-AGENT-031`ï¼ˆä¸­æ–­è·³è¿‡å‰©ä½™å·¥å…·ï¼‰ï¼š
- GIVENï¼šconfigure_agent + mock è¿”å› 3 ä¸ª tool_call + register steering åœ¨ç¬¬ 1 ä¸ª tool åæ³¨å…¥
- WHENï¼šagent_chat
- THENï¼šç¬¬ 1 ä¸ª tool æ‰§è¡Œï¼Œç¬¬ 2ã€3 ä¸ªè¢«è·³è¿‡ï¼ˆç»“æœå« "Skipped"ï¼‰
- **ä»£ç æ”¹åŠ¨**ï¼š
  ```elixir
  # mock_llm.ex â€” execute_pending_tools
  Enum.reduce(pending, {agent, steering_queue}, fn tc, {acc_agent, queue} ->
    case Gong.Steering.check(queue) do
      {nil, queue} ->
        # æ­£å¸¸æ‰§è¡Œå·¥å…·
        ...
      {steering_msg, remaining_queue} ->
        # è·³è¿‡å½“å‰ toolï¼Œæ³¨å…¥ skip result
        skip_result = Gong.Steering.skip_result(tc.name)
        ...
    end
  end)
  ```

`BDD-AGENT-032`ï¼ˆsteering æ¶ˆæ¯ä¸‹ä¸€è½®å¤„ç†ï¼‰ï¼š
- GIVENï¼šåŒä¸Š + mock ä¸€ä¸ªåç»­ LLM å“åº”ï¼ˆæ”¶åˆ° skip ç»“æœåçš„å›å¤ï¼‰
- WHENï¼šagent_chat
- THENï¼šLLM æ”¶åˆ°è·³è¿‡é€šçŸ¥å’Œ steering æ¶ˆæ¯ï¼Œä¸‹ä¸€è½®æ­£å¸¸å“åº”

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/agent_integration_generated_test.exs --trace
# é¢„æœŸï¼š34 ä¸ªåœºæ™¯å…¨éƒ¨é€šè¿‡ï¼ˆ30 æ—§ + 4 å›å½’ + 2 æ–°ï¼‰
```

##### Step â‘¢ Auto-retry é›†æˆï¼ˆ3 ä¸ªåœºæ™¯ï¼‰ âœ…

LLM è°ƒç”¨å¤±è´¥æ—¶è‡ªåŠ¨èµ° Retry æ¨¡å—é‡è¯•ã€‚

**å®ç°æ­¥éª¤**ï¼š
1. ä¿®æ”¹ `test/support/mock_llm.ex` çš„ `drive_loop`ï¼šLLM å“åº”ä¸ºé”™è¯¯æ—¶è°ƒç”¨ `Gong.Retry.classify/1`
2. åˆ†ç±»ä¸º `:transient` â†’ é€€é¿é‡è¯•ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
3. åˆ†ç±»ä¸º `:context_overflow` â†’ è§¦å‘ compactionï¼ˆè§ â‘£ï¼‰
4. åˆ†ç±»ä¸º `:permanent` â†’ ç«‹å³å¤±è´¥
5. åŒæ­¥ä¿®æ”¹ `test/support/live_llm.ex`
6. åœ¨ `docs/bdd/agent_integration.dsl` è¿½åŠ  3 ä¸ªåœºæ™¯

**å…·ä½“å®ç°**ï¼š

`BDD-AGENT-033`ï¼ˆ429 é‡è¯•ä¸å‹ç¼©ï¼‰ï¼š
- GIVENï¼šconfigure_agent + mock ç¬¬ä¸€æ¬¡è¿”å› 429 é”™è¯¯ + ç¬¬äºŒæ¬¡è¿”å›æ­£å¸¸æ–‡æœ¬
- WHENï¼šagent_chat
- THENï¼šassert_agent_reply æ­£å¸¸ + assert_no_crash + **æ— ** compaction è¢«è§¦å‘
- **æ–° BDD æŒ‡ä»¤**ï¼š`assert_compaction_not_triggered` â€” æ£€æŸ¥ telemetry æ—  compaction äº‹ä»¶

`BDD-AGENT-034`ï¼ˆé‡è¯•æˆåŠŸåç»§ç»­ï¼‰ï¼š
- GIVENï¼šconfigure_agent + mock ç¬¬ä¸€æ¬¡è¶…æ—¶ + ç¬¬äºŒæ¬¡è¿”å› tool_call + ç¬¬ä¸‰æ¬¡è¿”å›æ–‡æœ¬
- WHENï¼šagent_chat
- THENï¼štool è¢«æ‰§è¡Œ + æœ€ç»ˆ reply æ­£ç¡®

`BDD-AGENT-035`ï¼ˆé‡è¯•è€—å°½ï¼‰ï¼š
- GIVENï¼šconfigure_agent + mock è¿ç»­ 4 æ¬¡è¿”å› 429
- WHENï¼šagent_chat
- THENï¼šassert_tool_errorï¼ˆæˆ– last_error éç©ºï¼‰+ é”™è¯¯ä¿¡æ¯å« "retry"

**ä»£ç æ”¹åŠ¨**ï¼ˆmock_llm.ex çš„ drive_loopï¼‰ï¼š
```elixir
defp drive_loop(agent, call_id, hooks, opts, responses, iteration, max_iter) do
  case pop_response(responses) do
    {:error_response, error_msg, rest} ->
      case Gong.Retry.classify(error_msg) do
        :transient ->
          retry_count = Keyword.get(opts, :retry_count, 0)
          if retry_count < 3 do
            delay = Gong.Retry.delay(retry_count)
            Process.sleep(delay)  # æµ‹è¯•ä¸­å¯ä»¥ mock ä¸º 0
            drive_loop(agent, call_id, hooks,
              Keyword.put(opts, :retry_count, retry_count + 1),
              rest, iteration, max_iter)
          else
            {:error, "é‡è¯•è€—å°½: #{error_msg}", agent}
          end
        :permanent ->
          {:error, error_msg, agent}
        :context_overflow ->
          # è§ Step â‘£
          ...
      end
    ...
  end
end
```

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/agent_integration_generated_test.exs --trace
# é¢„æœŸï¼š37 ä¸ªåœºæ™¯å…¨éƒ¨é€šè¿‡
```

##### Step â‘£ Auto-compaction é›†æˆï¼ˆ2 ä¸ªåœºæ™¯ï¼‰ âœ…

Agent å¾ªç¯è‡ªåŠ¨æ£€æµ‹ä¸Šä¸‹æ–‡æº¢å‡ºå¹¶è§¦å‘å‹ç¼©ã€‚

**å®ç°æ­¥éª¤**ï¼š
1. ä¿®æ”¹ MockLLM/LiveLLM çš„ `drive_loop`ï¼šæ¯è½®ç»“æŸåè°ƒç”¨ `Gong.AutoCompaction.maybe_compact/3`
2. `:context_overflow` é”™è¯¯åˆ†ç±»ä¹Ÿè§¦å‘ compaction
3. åœ¨ `docs/bdd/agent_integration.dsl` è¿½åŠ  2 ä¸ªåœºæ™¯

**å…·ä½“å®ç°**ï¼š

`BDD-AGENT-036`ï¼ˆä¸Šä¸‹æ–‡è¶…é™è‡ªåŠ¨å‹ç¼©ï¼‰ï¼š
- GIVENï¼šconfigure_agent with context_window=2000 + å¤§é‡ mock æ¶ˆæ¯å¡«å……ä¸Šä¸‹æ–‡
- WHENï¼šagent_chatï¼ˆè§¦å‘æº¢å‡ºæ£€æµ‹ï¼‰
- THENï¼šassert_telemetry_received event="gong.compaction.start" + å¯¹è¯ç»§ç»­ä¸å´©æºƒ

`BDD-AGENT-037`ï¼ˆå‹ç¼©æœŸé—´æ’é˜Ÿæ¶ˆæ¯æ¢å¤ï¼‰ï¼š
- GIVENï¼šåŒä¸Š + åœ¨ compaction è¿‡ç¨‹ä¸­æ³¨å…¥ steering æ¶ˆæ¯
- WHENï¼šagent_chat
- THENï¼šcompaction å®Œæˆå steering æ¶ˆæ¯è¢«å¤„ç†ï¼Œä¸ä¸¢å¤±

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/agent_integration_generated_test.exs --trace
# é¢„æœŸï¼š39 ä¸ªåœºæ™¯å…¨éƒ¨é€šè¿‡
mix test  # å…¨é‡å›å½’
# é¢„æœŸï¼š244 + 11 = 255 ä¸ªåœºæ™¯é€šè¿‡
```

**ç¬¬ä¸€æ‰¹å®Œæˆæ ‡å‡†**ï¼š
```bash
mix test --trace
# 255 tests, 0 failures (ä¸å« E2E)
mix test --include e2e --trace
# 275 tests, 0 failures (å« E2Eï¼Œéœ€ DEEPSEEK_API_KEY)
```

---

#### ç¬¬äºŒæ‰¹ï¼šæ ¸å¿ƒèƒ½åŠ›ï¼ˆ14 ä¸ªåœºæ™¯ï¼‰

åšå®Œå Gong æœ‰æµå¼è¾“å‡º + å¤šæ¨¡å‹ï¼Œå¯ä»¥å¼€å§‹åš CLI/Web å‰ç«¯ã€‚

##### Step â‘¤ æµå¼è¾“å‡ºï¼ˆ8 ä¸ªåœºæ™¯ï¼‰

**æ–°æ–‡ä»¶**ï¼š
- `lib/gong/stream.ex` â€” æµå¼äº‹ä»¶å®šä¹‰ + æ¨é€æœºåˆ¶
- `test/support/mock_stream.ex` â€” Mock æµå¼ LLM å“åº”

**å®ç°æ­¥éª¤**ï¼š
1. å®šä¹‰æµå¼äº‹ä»¶ç»“æ„ï¼š
   ```elixir
   defmodule Gong.Stream.Event do
     @type t :: %__MODULE__{
       type: :text_start | :text_delta | :text_end |
             :tool_start | :tool_delta | :tool_end |
             :thinking_start | :thinking_delta | :thinking_end |
             :error,
       data: map()
     }
   end
   ```
2. åœ¨ MockLLM ä¸­å¢åŠ  `stream_chat/4`ï¼šä» mock é˜Ÿåˆ—æŒ‰ chunk æ¨é€äº‹ä»¶
3. åœ¨ LiveLLM ä¸­å¢åŠ  `stream_chat/4`ï¼šè°ƒç”¨ `ReqLLM.stream_text/3`ï¼Œé€ chunk è½¬æ¢ä¸ºäº‹ä»¶
4. æ–°å¢ BDD æŒ‡ä»¤ï¼š
   - `mock_stream_response` â€” æ³¨å†Œåˆ†å—çš„ mock æµå¼å“åº”
   - `agent_stream_chat` â€” ä½¿ç”¨æµå¼æ¨¡å¼å¯¹è¯
   - `agent_stream_chat_live` â€” E2E æµå¼
   - `assert_stream_event` â€” æ–­è¨€æ”¶åˆ°æŒ‡å®šç±»å‹çš„æµå¼äº‹ä»¶
   - `assert_stream_sequence` â€” æ–­è¨€äº‹ä»¶åºåˆ—
5. åœ¨ `docs/bdd/` æ–°å»º `streaming.dsl`ï¼Œå†™å…¥ 8 ä¸ªåœºæ™¯
6. æ³¨å†Œæ–°æŒ‡ä»¤åˆ° `lib/gong/bdd/instruction_registries/`

**åœºæ™¯ç»†èŠ‚**ï¼š

| åœºæ™¯ | å…³é”® GIVEN | å…³é”® WHEN | å…³é”® THEN |
|------|-----------|-----------|-----------|
| STREAM-001 çº¯æ–‡æœ¬æµ | mock_stream_response chunks=["Hello"," wor","ld"] | agent_stream_chat | assert_stream_sequence types="text_start,text_delta,text_delta,text_delta,text_end" + reply="Hello world" |
| STREAM-002 tool call æµ | mock_stream_response type=tool_call chunks=[name,args_part1,args_part2] | agent_stream_chat | assert_stream_event type="tool_start" + tool è¢«æ‰§è¡Œ |
| STREAM-003 æµå¼ä¸­æ–­ | mock_stream_response slow=true + inject_steering | agent_stream_chat | æµè¢«ä¸­æ–­ + partial å†…å®¹ä¿ç•™ |
| STREAM-004 ç©ºä¸­æ–­ | mock_stream_response + ç«‹å³ steering | agent_stream_chat | partial message ä¸¢å¼ƒ |
| STREAM-005 äº‹ä»¶åºåˆ— | mock_stream_response | agent_stream_chat | assert_stream_sequence é¡ºåºæ­£ç¡® |
| STREAM-006 æµå¼+Hook | mock_stream_response + register_hook InjectContext | agent_stream_chat | Hook åœ¨æµå¼å‰ç”Ÿæ•ˆ + assert_no_crash |
| STREAM-007 æµå¼è¶…æ—¶ | mock_stream_response stall_after=2 | agent_stream_chat | assert_tool_error contains="timeout" |
| STREAM-008 E2E æµå¼ | check_e2e_provider + create_temp_file | agent_stream_chat_live | assert_stream_event type="text_delta" + reply éç©º |

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/streaming_generated_test.exs --trace
# é¢„æœŸï¼š8 ä¸ªåœºæ™¯é€šè¿‡ï¼ˆSTREAM-008 éœ€è¦ DEEPSEEK_API_KEYï¼Œæ—  key æ—¶è·³è¿‡ï¼‰
mix test  # å…¨é‡å›å½’
# é¢„æœŸï¼š263 tests, 0 failures
```

##### Step â‘¥ å¤šæ¨¡å‹è¿è¡Œæ—¶åˆ‡æ¢ï¼ˆ6 ä¸ªåœºæ™¯ï¼‰

**æ–°æ–‡ä»¶**ï¼š
- `lib/gong/model_registry.ex` â€” æ¨¡å‹æ³¨å†Œ + è¿è¡Œæ—¶åˆ‡æ¢

**å®ç°æ­¥éª¤**ï¼š
1. å®ç° `Gong.ModelRegistry`ï¼š
   ```elixir
   defmodule Gong.ModelRegistry do
     # ETS è¡¨å­˜å‚¨å¯ç”¨æ¨¡å‹
     def register(name, provider_spec)     # æ³¨å†Œæ¨¡å‹
     def switch(agent, model_name)         # è¿è¡Œæ—¶åˆ‡æ¢
     def current(agent)                    # æŸ¥è¯¢å½“å‰æ¨¡å‹
     def available()                       # åˆ—å‡ºæ‰€æœ‰å·²æ³¨å†Œæ¨¡å‹
     def resolve_api_key(provider)         # ä»ç¯å¢ƒå˜é‡è¯»å– API Key
   end
   ```
2. ä¿®æ”¹ `Gong.Agent` æ”¯æŒåŠ¨æ€ modelï¼ˆä» strategy state è¯»å–è€Œéç¡¬ç¼–ç ï¼‰
3. ä¿®æ”¹ LiveLLM çš„ `call_real_llm/1`ï¼šä» ModelRegistry è¯»å–å½“å‰æ¨¡å‹
4. æ–°å¢ BDD æŒ‡ä»¤ï¼š
   - `register_model` â€” æ³¨å†Œä¸€ä¸ªæ¨¡å‹åˆ° Registry
   - `switch_model` â€” è¿è¡Œæ—¶åˆ‡æ¢æ¨¡å‹
   - `assert_model_used` â€” æ–­è¨€ä½¿ç”¨äº†æŒ‡å®šæ¨¡å‹ï¼ˆé€šè¿‡ telemetry æˆ– mock æ•è·ï¼‰
5. åœ¨ `docs/bdd/` æ–°å»º `model_registry.dsl`ï¼Œå†™å…¥ 6 ä¸ªåœºæ™¯

**åœºæ™¯ç»†èŠ‚**ï¼š

| åœºæ™¯ | æ“ä½œ | éªŒè¯ |
|------|------|------|
| MODEL-001 é»˜è®¤é…ç½® | configure_agent model="deepseek:deepseek-chat" | agent ä½¿ç”¨è¯¥æ¨¡å‹ |
| MODEL-002 è¿è¡Œæ—¶åˆ‡æ¢ | ç¬¬ä¸€è½® model A â†’ switch_model B â†’ ç¬¬äºŒè½® | ç¬¬äºŒè½®ç”¨ B |
| MODEL-003 æ— æ•ˆæ¨¡å‹å›é€€ | configure_agent model="nonexistent" | å›é€€åˆ°é»˜è®¤æ¨¡å‹ + æ—¥å¿—è­¦å‘Š |
| MODEL-004 API Key ç¼ºå¤± | register_model ä½†ä¸è®¾ç¯å¢ƒå˜é‡ | å‹å¥½é”™è¯¯ï¼Œä¸å´©æºƒ |
| MODEL-005 å¤š Provider | register deepseek + openai | æŒ‰åé€‰æ‹©æ­£ç¡® |
| MODEL-006 E2E åˆ‡æ¢ | check_e2e_provider + agent_chat_live | çœŸå® API å“åº”æ ¼å¼æ­£ç¡® |

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/model_registry_generated_test.exs --trace
# é¢„æœŸï¼š6 ä¸ªåœºæ™¯é€šè¿‡
mix test  # å…¨é‡å›å½’
# é¢„æœŸï¼š269 tests, 0 failures
```

**ç¬¬äºŒæ‰¹å®Œæˆæ ‡å‡†**ï¼š
```bash
mix test --trace
# 269 tests, 0 failures
# æµå¼ + å¤šæ¨¡å‹åŠŸèƒ½å¯ç”¨
```

---

#### ç¬¬ä¸‰æ‰¹ï¼šäº§å“åŒ–ï¼ˆ17 ä¸ªåœºæ™¯ï¼‰

â‘¦â‘§â‘¨ å¯å¹¶è¡Œå¼€å‘ï¼ˆé™¤ â‘¦ ä¾èµ– â‘¤ çš„æµå¼ APIï¼‰ã€‚

##### Step â‘¦ Abort ä¿¡å·ä¼ æ’­ï¼ˆ5 ä¸ªåœºæ™¯ï¼‰

**æ–°æ–‡ä»¶**ï¼š
- `lib/gong/abort.ex` â€” Abort ä¿¡å·ç®¡ç†

**å®ç°æ­¥éª¤**ï¼š
1. å®ç° `Gong.Abort`ï¼š
   ```elixir
   defmodule Gong.Abort do
     # åŸºäºè¿›ç¨‹æ¶ˆæ¯çš„ abort ä¿¡å·
     def signal(agent_pid)           # å‘é€ abort
     def check!()                    # æ£€æŸ¥æ˜¯å¦ abortedï¼ˆraise if soï¼‰
     def aborted?()                  # éæŠ›å‡ºæ£€æŸ¥
   end
   ```
2. åœ¨ Agent å¾ªç¯å…³é”®ç‚¹æ’å…¥ `Abort.check!()`ï¼š
   - æ¯ä¸ª tool æ‰§è¡Œå‰
   - LLM è°ƒç”¨å‰
   - æµå¼æ¯ä¸ª chunk æ¥æ”¶æ—¶
3. Bash å·¥å…·ï¼šabort æ—¶è°ƒç”¨å·²æœ‰çš„ `kill_process_tree`
4. æµå¼ï¼šabort æ—¶å…³é—­ HTTP è¿æ¥ï¼ˆReqLLM æ”¯æŒ `cancel/1`ï¼‰
5. æ–°å¢ BDD æŒ‡ä»¤ï¼š
   - `send_abort` â€” å‘ agent å‘é€ abort ä¿¡å·
   - `send_abort_during_tool` â€” åœ¨å·¥å…·æ‰§è¡Œå›è°ƒä¸­å‘é€ abort
   - `assert_aborted` â€” æ–­è¨€ agent è¿”å› aborted çŠ¶æ€
6. åœ¨ `docs/bdd/` æ–°å»º `abort.dsl`ï¼Œå†™å…¥ 5 ä¸ªåœºæ™¯

**åœºæ™¯ç»†èŠ‚**ï¼š

| åœºæ™¯ | è§¦å‘æ—¶æœº | é¢„æœŸè¡Œä¸º |
|------|---------|---------|
| ABORT-001 å·¥å…·æ‰§è¡Œä¸­ | bash sleep 10 æ—¶ abort | è¿›ç¨‹è¢«æ€ + è¿”å› "aborted" |
| ABORT-002 å¤šå·¥å…·è·³è¿‡ | ç¬¬ 1 ä¸ª tool å abort | å‰©ä½™ 2 ä¸ªè·³è¿‡ |
| ABORT-003 LLM ç­‰å¾…ä¸­ | mock slow LLM æ—¶ abort | è¿”å› aborted é”™è¯¯ |
| ABORT-004 abort åæ¢å¤ | abort â†’ å†å‘æ–° prompt | æ­£å¸¸å“åº” |
| ABORT-005 partial ä¿ç•™ | æµå¼å·²æ”¶åˆ°éƒ¨åˆ†å†…å®¹æ—¶ abort | partial text ä¿ç•™åœ¨ä¸Šä¸‹æ–‡ä¸­ |

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/abort_generated_test.exs --trace
# é¢„æœŸï¼š5 ä¸ªåœºæ™¯é€šè¿‡
```

##### Step â‘§ Session æ ‘å½¢åˆ†æ”¯ï¼ˆ6 ä¸ªåœºæ™¯ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `lib/gong/tape/store.ex` â€” å¢åŠ åˆ†æ”¯æ“ä½œ
- `lib/gong/tape/index.ex` â€” å¢åŠ  parent_anchor_id å­—æ®µ

**å®ç°æ­¥éª¤**ï¼š
1. Index è¡¨å¢åŠ  `parent_anchor_id` åˆ—ï¼š
   ```sql
   ALTER TABLE anchors ADD COLUMN parent_anchor_id INTEGER REFERENCES anchors(seq);
   ```
2. Store å¢åŠ åˆ†æ”¯ APIï¼š
   ```elixir
   def branch_from(store, anchor_seq)    # ä»æŒ‡å®š anchor åˆ›å»ºåˆ†æ”¯
   def navigate(store, anchor_seq)       # åˆ‡æ¢åˆ°åˆ†æ”¯å¶èŠ‚ç‚¹
   def branches(store, anchor_seq)       # åˆ—å‡ºå­åˆ†æ”¯
   def build_context_path(store)         # æ²¿åˆ†æ”¯è·¯å¾„å›æº¯åˆ°æ ¹
   ```
3. ä¸Šä¸‹æ–‡æ„å»ºæ—¶ç”¨ `build_context_path` æ›¿ä»£çº¿æ€§æ‰«æ
4. æ–°å¢ BDD æŒ‡ä»¤ï¼š
   - `tape_branch_from` â€” ä» anchor åˆ›å»ºåˆ†æ”¯
   - `tape_navigate` â€” åˆ‡æ¢åˆ†æ”¯
   - `tape_list_branches` â€” æŸ¥è¯¢åˆ†æ”¯
   - `assert_branch_count` â€” æ–­è¨€åˆ†æ”¯æ•°é‡
   - `assert_context_path` â€” æ–­è¨€ä¸Šä¸‹æ–‡è·¯å¾„å†…å®¹
5. åœ¨ `docs/bdd/tape_storage.dsl` æœ«å°¾è¿½åŠ  6 ä¸ªåœºæ™¯

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/tape_storage_generated_test.exs --trace
# é¢„æœŸï¼š40 ä¸ªåœºæ™¯é€šè¿‡ï¼ˆ34 æ—§ + 6 æ–°ï¼‰
```

##### Step â‘¨ Extension åŠ è½½/å‘ç°ï¼ˆ6 ä¸ªåœºæ™¯ï¼‰

**æ–°æ–‡ä»¶**ï¼š
- `lib/gong/extension/loader.ex` â€” æ‰«æå’ŒåŠ è½½ .ex æ–‡ä»¶
- `lib/gong/extension/runner.ex` â€” Extension ç”Ÿå‘½å‘¨æœŸç®¡ç†
- `lib/gong/extension.ex` â€” Extension behaviour å®šä¹‰

**å®ç°æ­¥éª¤**ï¼š
1. å®šä¹‰ Extension behaviourï¼ˆç»§æ‰¿ Hook + å¢åŠ  tools/commandsï¼‰ï¼š
   ```elixir
   defmodule Gong.Extension do
     @callback init(config :: map()) :: {:ok, state :: term()} | {:error, term()}
     @callback tools() :: [module()]                    # å¯é€‰
     @callback commands() :: [map()]                    # å¯é€‰
     @callback cleanup(state :: term()) :: :ok          # å¯é€‰
     # ç»§æ‰¿æ‰€æœ‰ Gong.Hook å›è°ƒï¼ˆå¯é€‰å®ç°ï¼‰
   end
   ```
2. Loaderï¼šæ‰«æç›®å½• â†’ `Code.compile_file/1` â†’ éªŒè¯ behaviour â†’ è¿”å›æ¨¡å—åˆ—è¡¨
3. Runnerï¼šinit æ‰€æœ‰ Extension â†’ æ³¨å…¥ Hook åˆ—è¡¨å’Œå·¥å…·åˆ—è¡¨ â†’ Agent è¿è¡Œ â†’ cleanup
4. é”™è¯¯éš”ç¦»ï¼š`try/catch` åŒ…è£¹æ¯ä¸ª Extension æ“ä½œ
5. æ–°å¢ BDD æŒ‡ä»¤ï¼š
   - `create_extension_file` â€” åœ¨ä¸´æ—¶ç›®å½•çš„ extensions/ ä¸‹åˆ›å»º .ex æ–‡ä»¶
   - `load_extensions` â€” è§¦å‘ Loader æ‰«æåŠ è½½
   - `assert_extension_loaded` â€” æ–­è¨€ Extension è¢«å‘ç°
   - `assert_extension_tool_available` â€” æ–­è¨€è‡ªå®šä¹‰å·¥å…·å¯ç”¨
6. åœ¨ `docs/bdd/` æ–°å»º `extension.dsl`ï¼Œå†™å…¥ 6 ä¸ªåœºæ™¯

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/extension_generated_test.exs --trace
# é¢„æœŸï¼š6 ä¸ªåœºæ™¯é€šè¿‡
mix test  # å…¨é‡å›å½’
# é¢„æœŸï¼š286 tests, 0 failures
```

**ç¬¬ä¸‰æ‰¹å®Œæˆæ ‡å‡†**ï¼š
```bash
mix test --trace
# 286 tests, 0 failures
# Abort + Session åˆ†æ”¯ + Extension å…¨éƒ¨å¯ç”¨
```

---

#### ç¬¬å››æ‰¹ï¼šå®Œå–„ï¼ˆ19 ä¸ªåœºæ™¯ï¼‰

å„æ¨¡å—ç‹¬ç«‹ï¼Œæ— ä¸¥æ ¼é¡ºåºã€‚åˆ†æ”¯æ‘˜è¦ï¼ˆâ‘©ï¼‰ä¾èµ– Session åˆ†æ”¯ï¼ˆâ‘§ï¼‰ã€‚

##### Step â‘© åˆ†æ”¯æ‘˜è¦ï¼ˆ2 ä¸ªåœºæ™¯ï¼‰

**å‰ç½®**ï¼šStep â‘§ å®Œæˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š`lib/gong/tape/store.ex` + `lib/gong/compaction.ex`

**å®ç°æ­¥éª¤**ï¼š
1. Store å¢åŠ  `generate_branch_summary/2`ï¼šç¦»å¼€åˆ†æ”¯æ—¶ç”¨ LLM ç”Ÿæˆæ‘˜è¦
2. æ‘˜è¦å­˜ä¸ºç‰¹æ®Š entryï¼ˆkind: :branch_summaryï¼‰
3. æ–°å¢ BDD æŒ‡ä»¤ï¼š`tape_switch_branch`ã€`assert_branch_summary_exists`
4. åœ¨ `docs/bdd/tape_storage.dsl` è¿½åŠ  2 ä¸ªåœºæ™¯

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/tape_storage_generated_test.exs --trace
# é¢„æœŸï¼š42 ä¸ªåœºæ™¯é€šè¿‡
```

##### Step â‘ª Follow-up æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ2 ä¸ªåœºæ™¯ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š`lib/gong/steering.ex` + MockLLM/LiveLLM

**å®ç°æ­¥éª¤**ï¼š
1. Steering å¢åŠ  `:follow_up` ç±»å‹æ¶ˆæ¯ï¼Œä¸ `:steering` åŒºåˆ†
2. Agent å¾ªç¯å®Œæˆåæ£€æŸ¥ follow_up é˜Ÿåˆ—ï¼Œæœ‰åˆ™è‡ªåŠ¨ç»§ç»­ä¸‹ä¸€è½®
3. æ–°å¢ BDD æŒ‡ä»¤ï¼š`push_follow_up`ã€`assert_follow_up_processed`
4. åœ¨ `docs/bdd/steering.dsl` è¿½åŠ  2 ä¸ªåœºæ™¯

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/steering_generated_test.exs --trace
# é¢„æœŸï¼š4 ä¸ªåœºæ™¯é€šè¿‡ï¼ˆ2 æ—§ + 2 æ–°ï¼‰
```

##### Step â‘« Settings ç®¡ç†ï¼ˆ3 ä¸ªåœºæ™¯ï¼‰

**æ–°æ–‡ä»¶**ï¼š`lib/gong/settings.ex`

**å®ç°æ­¥éª¤**ï¼š
1. ETS è¡¨ + JSON æ–‡ä»¶æŒä¹…åŒ–
2. å…¨å±€ï¼ˆ`~/.gong/settings.json`ï¼‰+ é¡¹ç›®çº§ï¼ˆ`{workspace}/.gong/settings.json`ï¼‰ï¼Œé¡¹ç›®çº§è¦†ç›–å…¨å±€
3. æ–°å¢ BDD æŒ‡ä»¤ï¼š`create_settings_file`ã€`read_setting`ã€`write_setting`ã€`assert_setting_value`
4. åœ¨ `docs/bdd/` æ–°å»º `settings.dsl`ï¼Œå†™å…¥ 3 ä¸ªåœºæ™¯

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/settings_generated_test.exs --trace
# é¢„æœŸï¼š3 ä¸ªåœºæ™¯é€šè¿‡
```

##### Step â‘¬ Resource å‘ç°ï¼ˆ3 ä¸ªåœºæ™¯ï¼‰

**æ–°æ–‡ä»¶**ï¼š`lib/gong/resource_loader.ex`

**å®ç°æ­¥éª¤**ï¼š
1. æ‰«æ `~/.gong/` + `{workspace}/.gong/` ä¸‹çš„ `prompts/`ã€`skills/`ã€`context/` ç›®å½•
2. è¯»å– `.md` æ–‡ä»¶å†…å®¹ï¼Œæ³¨å…¥åˆ° system prompt
3. æ–°å¢ BDD æŒ‡ä»¤ï¼š`create_resource_file`ã€`load_resources`ã€`assert_system_prompt_contains`
4. åœ¨ `docs/bdd/` æ–°å»º `resource_loader.dsl`ï¼Œå†™å…¥ 3 ä¸ªåœºæ™¯

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test test/bdd_generated/resource_loader_generated_test.exs --trace
# é¢„æœŸï¼š3 ä¸ªåœºæ™¯é€šè¿‡
```

##### Step â‘­ å·¥å…·è¡¥å…¨ï¼ˆ7 ä¸ªåœºæ™¯ï¼‰

3 ä¸ªå­ä»»åŠ¡ï¼Œç‹¬ç«‹å®æ–½ï¼š

**â‘­a truncate å·¥å…·ï¼ˆ2 ä¸ªåœºæ™¯ï¼‰**ï¼š
- æ–°å¢ `Gong.Tools.Truncate` Action æ¨¡å—ï¼ˆæš´éœ²ç»™ LLM è°ƒç”¨ï¼‰
- å¤ç”¨ `Gong.Truncate` æ ¸å¿ƒé€»è¾‘
- åœ¨ `docs/bdd/truncate_system.dsl` è¿½åŠ  2 ä¸ªåœºæ™¯

**â‘­b edit-diff å·¥å…·ï¼ˆ3 ä¸ªåœºæ™¯ï¼‰**ï¼š
- ä¿®æ”¹ `Gong.Tools.Edit`ï¼šå¢åŠ  `mode: "diff"` å‚æ•°ï¼Œæ¥å— unified diff æ ¼å¼è¾“å…¥
- åœ¨ `docs/bdd/edit_action.dsl` è¿½åŠ  3 ä¸ªåœºæ™¯

**â‘­c path-utilsï¼ˆ2 ä¸ªåœºæ™¯ï¼‰**ï¼š
- æ–°å¢ `Gong.Tools.PathUtils` æˆ–åœ¨ç°æœ‰å·¥å…·ä¸­æŠ½å–å…±äº«çš„ `Gong.PathUtils` æ¨¡å—
- ç»Ÿä¸€ ~ã€ç›¸å¯¹è·¯å¾„ã€NFD å¤„ç†
- åœ¨ `docs/bdd/` æ–°å»º `path_utils.dsl`ï¼Œå†™å…¥ 2 ä¸ªåœºæ™¯

**æµ‹è¯•éªŒè¯**ï¼š
```bash
bddc compile
mix test --trace
# é¢„æœŸï¼š305 tests, 0 failuresï¼ˆä¸å« E2Eï¼‰
```

**ç¬¬å››æ‰¹å®Œæˆæ ‡å‡†**ï¼š
```bash
mix test --trace
# 316 tests, 0 failuresï¼ˆå…¨éƒ¨ BDD åœºæ™¯é€šè¿‡ï¼Œä¸å« E2Eï¼‰
mix test --include e2e --trace
# ~336 tests, 0 failuresï¼ˆå« E2Eï¼Œéœ€è¦ DEEPSEEK_API_KEYï¼‰
```

---

## é‡Œç¨‹ç¢‘æ£€æŸ¥æ¸…å•

| é‡Œç¨‹ç¢‘ | åœºæ™¯æ•° | æ ¸å¿ƒäº¤ä»˜ç‰© | éªŒæ”¶å‘½ä»¤ |
|--------|--------|-----------|---------|
| Phase VII å®Œæˆ | 244 + 11 = **255** | æ‰€æœ‰ç°æœ‰åŠŸèƒ½æœ‰é›†æˆçº§ BDD è¦†ç›– | `mix test` 255 pass |
| P0 å®Œæˆ | 255 + 14 = **269** | æµå¼è¾“å‡º + å¤šæ¨¡å‹åˆ‡æ¢ | `mix test` 269 pass |
| P1 å®Œæˆ | 269 + 17 = **286** | Abort + Session åˆ†æ”¯ + Extension | `mix test` 286 pass |
| P2 å®Œæˆ | 286 + 19 = **305** | å…¨éƒ¨åŠŸèƒ½å¯¹é½ï¼ˆä¸å« E2Eï¼‰ | `mix test` 305 pass |
| E2E å…¨é‡ | 305 + ~31 = **~336** | å«çœŸå® LLM E2E | `mix test --include e2e` ~336 pass |
