# Gong (å·¥) å®æ–½è®¡åˆ’

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿° Gong é¡¹ç›®ä»éª¨æ¶åˆ°å¯ç”¨çš„å®Œæ•´å®æ–½è·¯å¾„ã€‚æŒ‰ä¾èµ–å…³ç³»ä»åº•å‘ä¸Šåˆ† 6 ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µç»“æŸéƒ½æœ‰å¯éªŒè¯çš„äº¤ä»˜ç‰©ã€‚

### ä¾èµ–å…³ç³»

```
å·¥å…· Actions (é˜¶æ®µä¸€)
    â†“
æˆªæ–­ç³»ç»Ÿ (é˜¶æ®µäºŒ)            Tape å­˜å‚¨ (é˜¶æ®µäº”) â†â€” å¯ä¸é˜¶æ®µä¸‰å¹¶è¡Œ
    â†“                            â†“
Agent å¾ªç¯ (é˜¶æ®µä¸‰)  â†â€”â€”â€”â†’  å‹ç¼© (é˜¶æ®µå…­ä¸Š)
    â†“
Hook ç³»ç»Ÿ (é˜¶æ®µå››)
    â†“
ZCPG é›†æˆ (é˜¶æ®µå…­ä¸‹)
```

### æµ‹è¯•åŸºå‡†

æ–‡æ¡£ `architecture.md` ç¬¬ J èŠ‚å®šä¹‰äº† 216 ä¸ª BDD æµ‹è¯•ï¼ˆå« 20 ä¸ª Pi bug å›å½’ + 23 ä¸ª Hook ç³»ç»Ÿ + 14 ä¸ªå‹ç¼©ç³»ç»Ÿ + 34 ä¸ª Tape å­˜å‚¨ + 30 ä¸ª Agent é›†æˆï¼‰ã€‚æ¯ä¸ªé˜¶æ®µå®ç°å®Œæˆåï¼Œå¯¹åº”çš„æµ‹è¯•å¿…é¡»å…¨éƒ¨é€šè¿‡ã€‚å½“å‰å…¨éƒ¨ 200 ä¸ª ExUnit æµ‹è¯•é€šè¿‡ï¼ˆéƒ¨åˆ† DSL åœºæ™¯åˆå¹¶ä¸ºåŒä¸€æµ‹è¯•ï¼‰ã€‚

---

## é˜¶æ®µä¸€ï¼š7 ä¸ªå·¥å…· Action âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šæ‰€æœ‰å·¥å…· Action çš„ `run/2` å®ç°å®Œæ•´åŠŸèƒ½ï¼Œé€šè¿‡å¯¹åº”çš„ BDD æµ‹è¯•ã€‚

**å‰ç½®æ¡ä»¶**ï¼šæ— ï¼ˆçº¯å‡½æ•°å¼ï¼Œä¸ä¾èµ– LLM å’Œå¤–éƒ¨æœåŠ¡ï¼‰

### å®ç°é¡ºåº

æŒ‰å¤æ‚åº¦ä»ä½åˆ°é«˜æ’åˆ—ï¼Œæ¯ä¸ªå·¥å…·åšå®Œç«‹å³å†™æµ‹è¯•ï¼š

#### 1.1 readï¼ˆæ–‡ä»¶è¯»å–ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Read`
- å¯¹åº”æµ‹è¯•ï¼šJ.3 èŠ‚ï¼Œ17 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `File.stream!/1` æŒ‰è¡Œè¯»å–
  - `offset` + `limit` åˆ†é¡µ
  - è¡Œå·å‰ç¼€æ ¼å¼ï¼š`"     {n}\t{line}"`
  - é•¿è¡Œæˆªæ–­ï¼ˆè¶…è¿‡ 2000 å­—ç¬¦çš„è¡Œæˆªæ–­å¹¶æ ‡è®°ï¼‰
  - æ–‡ä»¶ä¸å­˜åœ¨è¿”å›é”™è¯¯ä¿¡æ¯è€Œéå´©æºƒ
- è¾¹ç•Œæƒ…å†µï¼š
  - ç©ºæ–‡ä»¶è¿”å›ç©ºå†…å®¹æç¤º
  - äºŒè¿›åˆ¶æ–‡ä»¶æ£€æµ‹ï¼ˆè¯»å‰ 8KB æ£€æŸ¥ `\0` å­—èŠ‚ï¼‰
  - offset è¶…å‡ºæ–‡ä»¶è¡Œæ•° â†’ è¿”å›ç©º
  - è·¯å¾„ç©¿è¶Šæ ¡éªŒï¼ˆ`../` ä¸èƒ½é€ƒå‡ºå·¥ä½œåŒºï¼‰

#### 1.2 lsï¼ˆç›®å½•åˆ—è¡¨ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Ls`
- å¯¹åº”æµ‹è¯•ï¼šJ.7 èŠ‚ï¼Œ6 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `File.ls!/1` + `File.stat/1` è·å–å…ƒä¿¡æ¯
  - è¿”å›æ–‡ä»¶åã€å¤§å°ã€ç±»å‹ï¼ˆæ–‡ä»¶/ç›®å½•/ç¬¦å·é“¾æ¥ï¼‰
  - ç»“æœæŒ‰ç±»å‹æ’åºï¼šç›®å½•ä¼˜å…ˆï¼Œæ–‡ä»¶å…¶æ¬¡
- è¾¹ç•Œæƒ…å†µï¼š
  - ç›®å½•ä¸å­˜åœ¨ â†’ é”™è¯¯ä¿¡æ¯
  - å¯¹æ–‡ä»¶è·¯å¾„è°ƒç”¨ ls â†’ é”™è¯¯ä¿¡æ¯
  - ç©ºç›®å½• â†’ ç©ºåˆ—è¡¨
  - å¤§ç›®å½•ï¼ˆ>1000 æ¡ç›®ï¼‰â†’ æˆªæ–­å¹¶æç¤º

#### 1.3 findï¼ˆæ–‡ä»¶æŸ¥æ‰¾ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Find`
- å¯¹åº”æµ‹è¯•ï¼šJ.6 èŠ‚ï¼Œ6 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `Path.wildcard/2` æ‰§è¡Œ glob åŒ¹é…
  - æ’é™¤æ¨¡å¼è¿‡æ»¤ï¼ˆé»˜è®¤æ’é™¤ `.git/`ã€`node_modules/`ã€`_build/`ã€`deps/`ï¼‰
  - ç»“æœæŒ‰ä¿®æ”¹æ—¶é—´æ’åº
  - ç»“æœæ•°é‡é™åˆ¶ï¼ˆé»˜è®¤ 200ï¼‰
- è¾¹ç•Œæƒ…å†µï¼š
  - æ— åŒ¹é… â†’ ç©ºåˆ—è¡¨ + æç¤º
  - ç¬¦å·é“¾æ¥ä¸è¿½è¸ªï¼ˆé¿å…å¾ªç¯ï¼‰

#### 1.4 grepï¼ˆå†…å®¹æœç´¢ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Grep`
- å¯¹åº”æµ‹è¯•ï¼šJ.5 èŠ‚ï¼Œ10 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `Regex.compile/2` ç¼–è¯‘æ¨¡å¼
  - éå†æ–‡ä»¶ï¼ŒæŒ‰è¡ŒåŒ¹é…
  - æ”¯æŒä¸Šä¸‹æ–‡è¡Œæ•°ï¼ˆ`-A`/`-B`/`-C` è¯­ä¹‰ï¼‰
  - è¾“å‡ºæ¨¡å¼ï¼š`content`ï¼ˆæ˜¾ç¤ºåŒ¹é…è¡Œï¼‰ã€`files_with_matches`ï¼ˆåªæ˜¾ç¤ºæ–‡ä»¶åï¼‰ã€`count`ï¼ˆæ˜¾ç¤ºè®¡æ•°ï¼‰
  - glob è¿‡æ»¤æœç´¢èŒƒå›´
- è¾¹ç•Œæƒ…å†µï¼š
  - æ— æ•ˆæ­£åˆ™ â†’ å‹å¥½é”™è¯¯ä¿¡æ¯
  - äºŒè¿›åˆ¶æ–‡ä»¶è·³è¿‡
  - ç»“æœè¿‡å¤š â†’ æˆªæ–­
  - å¤šæ–‡ä»¶åŒ¹é…æ—¶æŒ‰æ–‡ä»¶åˆ†ç»„è¾“å‡º

#### 1.5 writeï¼ˆæ–‡ä»¶å†™å…¥ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Write`
- å¯¹åº”æµ‹è¯•ï¼šJ.4 èŠ‚ï¼Œ7 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `File.mkdir_p/1` è‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½•
  - `File.write/3` è¦†ç›–å†™å…¥
  - è¿”å›å†™å…¥å­—èŠ‚æ•°
- è¾¹ç•Œæƒ…å†µï¼š
  - è·¯å¾„ç©¿è¶Šæ ¡éªŒ
  - å†™å…¥ç©ºå­—ç¬¦ä¸² â†’ åˆ›å»ºç©ºæ–‡ä»¶
  - æƒé™ä¸è¶³ â†’ é”™è¯¯ä¿¡æ¯
  - å†™å…¥åˆ°åªè¯»è·¯å¾„ â†’ é”™è¯¯ä¿¡æ¯

#### 1.6 editï¼ˆæ–‡ä»¶ç¼–è¾‘ï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Edit`
- å¯¹åº”æµ‹è¯•ï¼šJ.1 èŠ‚ï¼Œ23 ä¸ªç”¨ä¾‹ï¼ˆæœ€å¤šï¼‰
- æ ¸å¿ƒé€»è¾‘ï¼š
  - è¯»æ–‡ä»¶ â†’ æŸ¥æ‰¾ `old_string` â†’ æ›¿æ¢ â†’ å†™å›
  - **å”¯ä¸€æ€§æ ¡éªŒ**ï¼š`old_string` åœ¨æ–‡ä»¶ä¸­å¿…é¡»æ°å¥½å‡ºç°ä¸€æ¬¡ï¼ˆé™¤é `replace_all: true`ï¼‰
  - å¤šæ¬¡åŒ¹é…æ—¶æŠ¥é”™å¹¶æ˜¾ç¤ºå„åŒ¹é…çš„è¡Œå·
  - é›¶åŒ¹é…æ—¶æŠ¥é”™å¹¶æä¾›æ¨¡ç³ŠåŒ¹é…å»ºè®®
  - ä¿æŒåŸå§‹æ¢è¡Œç¬¦ï¼ˆCRLF æˆ– LFï¼‰
- è¾¹ç•Œæƒ…å†µï¼š
  - `old_string == new_string` â†’ æŠ¥é”™ï¼Œä¸åšæ— æ„ä¹‰æ›¿æ¢
  - BOM å¤´å¤„ç†ï¼ˆUTF-8 BOM 0xEF 0xBB 0xBFï¼‰
  - åŒ…å«æ­£åˆ™ç‰¹æ®Šå­—ç¬¦çš„å­—ç¬¦ä¸² â†’ ç²¾ç¡®åŒ¹é…ï¼Œä¸åšæ­£åˆ™
  - è·¯å¾„ç©¿è¶Šæ ¡éªŒ
  - `replace_all: true` æ—¶è¿”å›æ›¿æ¢æ¬¡æ•°

#### 1.7 bashï¼ˆå‘½ä»¤æ‰§è¡Œï¼‰

- å¯¹åº”æ¨¡å—ï¼š`Gong.Tools.Bash`
- å¯¹åº”æµ‹è¯•ï¼šJ.2 èŠ‚ï¼Œ14 ä¸ªç”¨ä¾‹
- æ ¸å¿ƒé€»è¾‘ï¼š
  - `System.cmd("bash", ["-c", command], opts)` æ‰§è¡Œå‘½ä»¤
  - æˆ–ç”¨ `Port.open/2` åšæ›´ç»†ç²’åº¦æ§åˆ¶
  - è¶…æ—¶æ§åˆ¶ï¼š`Task.async` + `Task.yield` + `Task.shutdown`
  - stdout å’Œ stderr åˆ†ç¦»æ•è·
  - è¾“å‡ºè¶…é•¿æ—¶è‡ªåŠ¨è°ƒç”¨ `Gong.Truncate`
  - å·¥ä½œç›®å½•è®¾ç½®ï¼ˆ`cd: working_dir`ï¼‰
- è¾¹ç•Œæƒ…å†µï¼š
  - å‘½ä»¤ä¸å­˜åœ¨ â†’ exit_code 127 + é”™è¯¯ä¿¡æ¯
  - è¶…æ—¶ â†’ æ€è¿›ç¨‹ + è¶…æ—¶æç¤º
  - å‘½ä»¤è¢«ä¿¡å·ç»ˆæ­¢ â†’ æŠ¥å‘Šä¿¡å·ç±»å‹
  - ç¯å¢ƒå˜é‡ç»§æ‰¿å½“å‰è¿›ç¨‹ç¯å¢ƒ
  - ç©ºå‘½ä»¤ â†’ æŠ¥é”™

### é˜¶æ®µä¸€äº¤ä»˜ç‰©

- âœ… 7 ä¸ª Action æ¨¡å—å…¨éƒ¨å®ç°
- âœ… 85 ä¸ª BDD æµ‹è¯•é€šè¿‡ï¼ˆJ.1 åˆ° J.7ï¼Œå« Pi bug å›å½’ + å‚æ•°æ ¡éªŒä¸å®‰å…¨ï¼‰
- âœ… æ¯ä¸ª Action å¯ä»¥ç‹¬ç«‹é€šè¿‡ `Jido.Action.run/2` è°ƒç”¨

---

## é˜¶æ®µäºŒï¼šæˆªæ–­ç³»ç»Ÿ âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šå®Œå–„ `Gong.Truncate`ï¼Œè¿”å›ç»“æ„åŒ–å…ƒæ•°æ®ï¼Œä¸å·¥å…·è¾“å‡ºå¯¹æ¥ã€‚

**å‰ç½®æ¡ä»¶**ï¼šé˜¶æ®µä¸€å®Œæˆï¼ˆæˆªæ–­è¦å¯¹æ¥å·¥å…·è¾“å‡ºï¼‰

### å®ç°å†…å®¹

#### 2.1 Result ç»“æ„ä½“ + åŒé™åˆ¶

é‡æ„ `Gong.Truncate`ï¼Œè¿”å› `%Gong.Truncate.Result{}` æ›¿ä»£æ—§çš„ `{text, boolean}` å…ƒç»„ï¼š

```elixir
defmodule Gong.Truncate.Result do
  defstruct content: "",
            truncated: false,
            truncated_by: nil,        # :lines | :bytes | :chars | nil
            total_lines: 0,
            total_bytes: 0,
            output_lines: 0,
            output_bytes: 0,
            last_line_partial: false,
            first_line_exceeds_limit: false,
            max_lines: nil,
            max_bytes: nil
end
```

- `truncate_head`ï¼šé€è¡Œç´¯åŠ ï¼Œ`max_lines` + `max_bytes` å…ˆè§¦å‘è€…ç”Ÿæ•ˆ
- `truncate_tail`ï¼šä»æœ«å°¾é€è¡Œæ”¶é›†ï¼Œè¾¹ç•Œè¡Œéƒ¨åˆ†åŒ…å«ï¼ˆUTF-8 å®‰å…¨ï¼‰
- `truncate_line`ï¼šæ–°å¢å•è¡Œæˆªæ–­ï¼ˆç”¨äº grep å•è¡Œé™åˆ¶ï¼‰ï¼Œè¶… `max_chars` åˆ™æˆªæ–­

#### 2.2 å·¥å…·è¾“å‡ºå¯¹æ¥

ä¸‰å¤„è°ƒç”¨æ”¹ä¸ºè§£æ„ `%Result{}`ï¼š

- **read.ex**ï¼šå­—èŠ‚æˆªæ–­åè¿½åŠ  `"Use offset=N to continue reading"` ç»­è¯»æç¤º
- **bash.ex**ï¼šæˆªæ–­åè¿½åŠ  `"åŸå§‹ N å­—èŠ‚"` åŸå§‹å¤§å°ä¿¡æ¯
- **grep.ex**ï¼šç®€å•è§£æ„ `%Result{content: truncated}`

#### 2.3 BDD æµ‹è¯•

æ–°å¢æŒ‡ä»¤ï¼š
- **GIVEN**: `set_var`ã€`generate_content`ï¼ˆå†…å­˜æ•°æ®å‡†å¤‡ï¼Œä¸ä¾èµ–æ–‡ä»¶ç³»ç»Ÿï¼‰
- **WHEN**: `truncate_head`ã€`truncate_tail`ã€`truncate_line`ï¼ˆç›´æ¥è°ƒç”¨æˆªæ–­æ¨¡å—ï¼‰
- **THEN**: `assert_truncation_result`ã€`assert_truncation_notification`ï¼ˆç»“æ„åŒ–æ–­è¨€ï¼‰

DSL æ–‡ä»¶ï¼š`docs/bdd/truncate_system.dsl`ï¼Œ14 ä¸ªåœºæ™¯ï¼ˆBDD-TRC-001 ~ 014ï¼‰

### é˜¶æ®µäºŒäº¤ä»˜ç‰©

- âœ… æˆªæ–­ç³»ç»Ÿ 14 ä¸ªæµ‹è¯•é€šè¿‡ï¼ˆJ.8 èŠ‚ï¼Œå« 2 ä¸ª Pi bug å›å½’ï¼‰
- âœ… é˜¶æ®µä¸€ 85 ä¸ªæµ‹è¯•æ— å›å½’
- âœ… å·¥å…· + æˆªæ–­åˆè®¡ **99 ä¸ªæµ‹è¯•é€šè¿‡**
- âœ… `mix compile --warnings-as-errors` æ— è­¦å‘Š

---

## é˜¶æ®µä¸‰ï¼šAgent å¾ªç¯ âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šLLM è°ƒç”¨ + å·¥å…·æ‰§è¡Œå½¢æˆå®Œæ•´çš„ agent loopã€‚

**å‰ç½®æ¡ä»¶**ï¼šé˜¶æ®µä¸€ã€äºŒå®Œæˆ

**å¤–éƒ¨ä¾èµ–**ï¼šéœ€è¦ LLM API keyï¼ˆAnthropic æˆ– OpenAIï¼‰

### å®ç°å†…å®¹

#### 3.1 å·¥å…·æ³¨å†Œä¸ schema è½¬æ¢

jido_ai çš„ `ToolAdapter` è‡ªåŠ¨æŠŠ Jido Action è½¬æˆ LLM çš„ tool schemaï¼š

```elixir
# Jido Action çš„ schema å®šä¹‰
schema: [
  file_path: [type: :string, required: true, doc: "æ–‡ä»¶ç»å¯¹è·¯å¾„"],
  offset: [type: :non_neg_integer, default: 0, doc: "èµ·å§‹è¡Œå·"]
]

# â†“ è‡ªåŠ¨è½¬æ¢ä¸º â†“

# LLM tool_call çš„ JSON Schema
%{
  "name" => "read_file",
  "description" => "è¯»å–æ–‡ä»¶å†…å®¹ï¼Œæ”¯æŒåˆ†é¡µ",
  "input_schema" => %{
    "type" => "object",
    "properties" => %{
      "file_path" => %{"type" => "string", "description" => "æ–‡ä»¶ç»å¯¹è·¯å¾„"},
      "offset" => %{"type" => "integer", "description" => "èµ·å§‹è¡Œå·"}
    },
    "required" => ["file_path"]
  }
}
```

éœ€è¦éªŒè¯ 7 ä¸ª Action çš„ schema éƒ½èƒ½æ­£ç¡®è½¬æ¢ã€‚

#### 3.2 Agent å¾ªç¯å®ç°

æ–°å»º `Gong.AgentLoop` æ¨¡å—ï¼Œæ ¸å¿ƒæµç¨‹ï¼š

```
ç”¨æˆ·æ¶ˆæ¯ â†’ æ‹¼è£…ä¸Šä¸‹æ–‡ï¼ˆç³»ç»Ÿæç¤º + å†å² + å·¥å…·åˆ—è¡¨ï¼‰
    â†’ è°ƒ LLMï¼ˆReqLLMï¼‰
    â†’ è§£æå“åº”
    â†’ å¦‚æœæœ‰ tool_call â†’ æ‰§è¡Œå¯¹åº” Action â†’ ç»“æœå›ä¼  â†’ ç»§ç»­å¾ªç¯
    â†’ å¦‚æœæ˜¯çº¯æ–‡æœ¬ â†’ è¿”å›ç»™ç”¨æˆ·
    â†’ å¦‚æœè¯·æ±‚ç»“æŸ â†’ é€€å‡ºå¾ªç¯
```

åˆ©ç”¨ jido_ai çš„ `ReAct` ç­–ç•¥ï¼Œä¸éœ€è¦æ‰‹å†™å¾ªç¯çŠ¶æ€æœºï¼š

```elixir
# jido_ai å·²ç»å°è£…äº† ReAct å¾ªç¯
Jido.AI.Agent.run(agent, signal, strategy: :react)
```

éœ€è¦ç¡®è®¤ `ReAct` ç­–ç•¥çš„ä»¥ä¸‹è¡Œä¸ºï¼š
- æœ€å¤§å¾ªç¯æ¬¡æ•°é™åˆ¶ï¼ˆé˜²æ­¢æ— é™ tool_callï¼‰
- tool_call å¤±è´¥æ—¶çš„é”™è¯¯æ¢å¤
- å¤šä¸ª tool_call çš„å¹¶è¡Œæ‰§è¡Œï¼ˆAnthropic æ”¯æŒï¼‰

#### 3.3 ç³»ç»Ÿæç¤ºè¯

æ–°å»º `Gong.Prompt` æ¨¡å—ï¼š

```elixir
defmodule Gong.Prompt do
  def system_prompt(workspace) do
    """
    ä½ æ˜¯ä¸€ä¸ªé€šç”¨ Agentï¼Œå·¥ä½œç›®å½•æ˜¯ #{workspace}ã€‚
    ä½¿ç”¨æä¾›çš„å·¥å…·å®Œæˆç”¨æˆ·çš„ä»»åŠ¡ã€‚
    ...
    """
  end
end
```

ç³»ç»Ÿæç¤ºè¯ä» `Gong.Agent` çš„ schema ä¸­çš„ `system_prompt` å­—æ®µæ³¨å…¥ï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰è¦†ç›–ã€‚

#### 3.4 æµå¼è¾“å‡º

LLM çš„å“åº”æ”¯æŒ SSE æµå¼è¾“å‡ºï¼š

```elixir
ReqLLM.chat(model, messages, tools: tools, stream: true)
|> Stream.each(fn chunk -> send(caller, {:chunk, chunk}) end)
```

è¿™æ˜¯ ZCPG é›†æˆçš„å…³é”®â€”â€”ZCPG çš„ SSE client éœ€è¦å®æ—¶æ¥æ”¶ tokenã€‚

### é˜¶æ®µä¸‰äº¤ä»˜ç‰©

- âœ… `Gong.AgentLoop` æ¨¡å—å®ç°
- âœ… `Gong.Prompt` æ¨¡å—å®ç°
- âœ… 30 ä¸ªé›†æˆæµ‹è¯•é€šè¿‡ï¼ˆJ.9 èŠ‚ï¼Œå«æµå¼è¾“å‡ºã€Hook ç«¯åˆ°ç«¯ã€é”™è¯¯æ¢å¤ä¸å¥å£®æ€§ï¼‰
- âœ… å¯ä»¥åœ¨ IEx ä¸­æ‰‹åŠ¨è·‘å®Œæ•´çš„ agent å¯¹è¯

---

## é˜¶æ®µå››ï¼šHook ç³»ç»Ÿ âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šå®ç°äº‹ä»¶æ‹¦æˆªä¸æ•°æ®å˜æ¢åŸºç¡€è®¾æ–½ï¼Œåœ¨å·¥å…·æ‰§è¡Œã€LLM è°ƒç”¨ã€ä¼šè¯æ“ä½œç­‰å…³é”®èŠ‚ç‚¹æ’å…¥ç”¨æˆ·è‡ªå®šä¹‰é€»è¾‘ã€‚

**å‰ç½®æ¡ä»¶**ï¼šé˜¶æ®µä¸‰å®Œæˆï¼ˆHook çš„é›†æˆç‚¹åœ¨ Agent å¾ªç¯ä¸­ï¼‰

### å®ç°å†…å®¹

#### 4.1 Hook Behaviour å®šä¹‰

æ–°å»º `Gong.Hook` behaviourï¼Œå®šä¹‰ 3 ç±»å›è°ƒï¼š

```elixir
defmodule Gong.Hook do
  @doc "Gate å‹ï¼šæ‹¦æˆªæ“ä½œï¼Œè¿”å› :ok æ”¾è¡Œæˆ– {:block, reason} é˜»æ­¢"
  @callback before_tool_call(tool :: atom(), params :: map()) ::
    :ok | {:block, String.t()}
  @callback before_session_op(op :: atom(), meta :: map()) ::
    :ok | :cancel

  @doc "Pipe å‹ï¼šå˜æ¢æ•°æ®æµï¼Œè¿”å›ä¿®æ”¹åçš„æ•°æ®"
  @callback on_tool_result(tool :: atom(), result :: map()) :: map()
  @callback on_context(messages :: [map()]) :: [map()]
  @callback on_input(text :: String.t(), images :: [map()]) ::
    {:transform, String.t(), [map()]} | :passthrough | :handled

  @doc "Notify å‹ï¼šè§‚å¯Ÿäº‹ä»¶ï¼Œé€šè¿‡ :telemetry å¹¿æ’­"
  @callback on_before_agent(prompt :: String.t(), system :: String.t()) ::
    {String.t(), String.t(), [map()]}

  @optional_callbacks [before_tool_call: 2, before_session_op: 2,
    on_tool_result: 2, on_context: 1, on_input: 2, on_before_agent: 2]
end
```

#### 4.2 HookRunner å®ç°

æ–°å»º `Gong.HookRunner`ï¼Œä¸¤ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š

- **`pipe/3`**ï¼šEnum.reduce é“¾å¼è°ƒç”¨ï¼Œæ¯ä¸ª hook å˜æ¢æ•°æ®åä¼ ç»™ä¸‹ä¸€ä¸ª
- **`gate/2`**ï¼šEnum.reduce_while é“¾å¼è°ƒç”¨ï¼Œä»»ä¸€ hook è¿”å› block åˆ™ç»ˆæ­¢

é”™è¯¯éš”ç¦»ï¼šå•ä¸ª hook å¼‚å¸¸ä¸å½±å“å…¶ä»– hookï¼Œé€šè¿‡ try/rescue æ•è·å¹¶å‘ telemetry äº‹ä»¶ã€‚

#### 4.3 Agent å¾ªç¯é›†æˆ

åœ¨ `Gong.AgentLoop` çš„ 5 ä¸ªå…³é”®èŠ‚ç‚¹æ’å…¥ hook è°ƒç”¨ï¼š

1. ç”¨æˆ·è¾“å…¥è¿›å…¥å‰ â†’ `on_input`
2. æ„å»ºä¸Šä¸‹æ–‡æ—¶ â†’ `on_context`
3. è°ƒ LLM å‰ â†’ `on_before_agent`
4. å·¥å…·æ‰§è¡Œå‰ â†’ `before_tool_call`ï¼ˆgateï¼‰
5. å·¥å…·æ‰§è¡Œå â†’ `on_tool_result`ï¼ˆpipeï¼‰

#### 4.4 Telemetry äº‹ä»¶

æ³¨å†Œæ ‡å‡† telemetry äº‹ä»¶ä¾›å¤–éƒ¨ç›‘æ§ï¼š

- `[:gong, :tool, :start]` / `[:gong, :tool, :stop]`
- `[:gong, :llm, :start]` / `[:gong, :llm, :stop]`
- `[:gong, :hook, :error]`

### é˜¶æ®µå››äº¤ä»˜ç‰©

- âœ… `Gong.Hook` behaviour æ¨¡å—
- âœ… `Gong.HookRunner` å®ç°æ¨¡å—ï¼ˆå« gate å¼‚å¸¸å€¼ catch-allï¼‰
- âœ… Agent å¾ªç¯ 5 ä¸ªé›†æˆç‚¹æ”¹é€ 
- âœ… 23 ä¸ª Hook ç³»ç»Ÿ BDD æµ‹è¯•é€šè¿‡ï¼ˆJ.10 èŠ‚ï¼Œå« short-circuitã€passthroughã€telemetry åºåˆ—éªŒè¯ï¼‰

---

## é˜¶æ®µäº”ï¼šTape å­˜å‚¨ âœ… å·²å®Œæˆ

**ç›®æ ‡**ï¼šå®ç°æ–‡ä»¶å¤¹ + SQLite ç´¢å¼•çš„ä¼šè¯å­˜å‚¨ã€‚

**å‰ç½®æ¡ä»¶**ï¼šæ— ï¼ˆç‹¬ç«‹æ¨¡å—ï¼Œå¯ä¸é˜¶æ®µä¸‰å¹¶è¡Œå¼€å‘ï¼‰

### å®ç°å†…å®¹

#### 5.1 SQLite schema åˆå§‹åŒ–

```elixir
defp init_db(db_path) do
  {:ok, conn} = Exqlite.Sqlite3.open(db_path)

  Exqlite.Sqlite3.execute(conn, """
    CREATE TABLE IF NOT EXISTS entries (
      id          INTEGER PRIMARY KEY AUTOINCREMENT,
      kind        TEXT NOT NULL,
      anchor_name TEXT NOT NULL,
      anchor_seq  INTEGER NOT NULL,
      file_path   TEXT NOT NULL,
      line_offset INTEGER,
      created_at  TEXT NOT NULL,
      summary     TEXT
    )
  """)

  # å»ºç´¢å¼•...
  # å»º FTS5 è™šæ‹Ÿè¡¨...
end
```

æˆ–è€…ç”¨ Ecto + ecto_sqlite3 åš migrationï¼ˆæ›´è§„èŒƒä½†æ›´é‡ï¼‰ã€‚

**å†³ç­–ç‚¹**ï¼šç›´æ¥ç”¨ Exqlite è¿˜æ˜¯èµ° Ectoï¼Ÿ
- Exqlite ç›´æ¥ SQLï¼šè½»é‡ï¼Œé€‚åˆåµŒå…¥å¼åœºæ™¯ï¼Œä»£ç æ›´å°‘
- Ecto migrationï¼šè§„èŒƒï¼Œæœ‰ schema ç‰ˆæœ¬ç®¡ç†ï¼Œä½†å¼•å…¥ Repo æ¦‚å¿µ

å»ºè®®å…ˆç”¨ Exqlite ç›´æ¥å†™ï¼Œåç»­éœ€è¦å†æŠ½ Ectoã€‚

#### 5.2 æ ¸å¿ƒæ“ä½œå®ç°

æŒ‰é¡ºåºï¼š

1. **`init/1`** â€” åˆ›å»º `anchors/` ç›®å½• + `index.db` + é»˜è®¤ anchor `001_session-start`
2. **`append/3`** â€” å†™ JSONL æ–‡ä»¶ + INSERT SQLiteï¼Œç”¨äº‹åŠ¡åŒ…è£¹
3. **`handoff/3`** â€” åˆ›å»ºæ–° anchor ç›®å½• + INSERT anchor è®°å½•
4. **`between_anchors/3`** â€” SQL èŒƒå›´æŸ¥è¯¢ â†’ å®šä½æ–‡ä»¶ â†’ è¯» JSONL
5. **`search/2`** â€” FTS5 å…¨æ–‡æœç´¢ â†’ å®šä½æ–‡ä»¶ â†’ è¯»å®Œæ•´æ¡ç›®
6. **`fork/1`** â€” SQLite savepoint + ä¸´æ—¶ç›®å½•
7. **`merge/2`** â€” åˆå¹¶ä¸´æ—¶ç›®å½•åˆ°ä¸»ç›®å½• + åˆå¹¶ SQLite è®°å½•

#### 5.3 ä¸€è‡´æ€§ä¿è¯

åŒå†™çš„åŸå­æ€§é—®é¢˜ï¼š

```elixir
def append(store, anchor, entry) do
  # å…ˆå†™æ–‡ä»¶ï¼ˆè¿½åŠ ï¼Œä½é£é™©ï¼‰
  :ok = write_jsonl(file_path, entry)

  # å†å†™æ•°æ®åº“ï¼ˆäº‹åŠ¡ï¼‰
  {:ok, _} = insert_index(store.db, entry_meta)

  # å¦‚æœæ•°æ®åº“å†™å…¥å¤±è´¥ï¼Œæ–‡ä»¶å¤šäº†ä¸€è¡Œä½†ç´¢å¼•æ²¡æœ‰
  # â†’ ä¸‹æ¬¡å¯åŠ¨æ—¶å¯ä»¥é€šè¿‡æ‰«ææ–‡ä»¶ä¿®å¤ç´¢å¼•ï¼ˆrebuild_indexï¼‰
end
```

æ·»åŠ  `rebuild_index/1` å‡½æ•°ï¼šæ‰«æ anchors/ ç›®å½•é‡å»º SQLite ç´¢å¼•ã€‚

### é˜¶æ®µäº”äº¤ä»˜ç‰©

- âœ… `Gong.Tape.Store` å®Œæ•´å®ç°ï¼ˆå« Entryã€FileStoreã€Index ä¸‰æ¨¡å—ï¼‰
- âœ… 34 ä¸ª Tape å­˜å‚¨ BDD æµ‹è¯•é€šè¿‡ï¼ˆJ.11 èŠ‚ï¼Œå«åŒå†™ä¸€è‡´æ€§ã€fork/mergeã€metadata å­˜å–ã€Pi bug å›å½’ï¼‰
- âœ… SQLite ç´¢å¼•æ”¯æŒ metadata å­—æ®µï¼ŒFTS5 å…¨æ–‡æœç´¢å¯ç”¨

---

## é˜¶æ®µå…­ï¼šå‹ç¼© + ZCPG é›†æˆ

**ç›®æ ‡**ï¼šä¸Šä¸‹æ–‡å‹ç¼©å¯ç”¨ï¼ŒGong æ¥å…¥ ZCPG æ›¿æ¢ OpenCodeã€‚

**å‰ç½®æ¡ä»¶**ï¼šé˜¶æ®µä¸‰ã€å››ã€äº”å®Œæˆ

### 6a. ä¸Šä¸‹æ–‡å‹ç¼© âœ… å·²å®Œæˆ

#### å®ç°å†…å®¹

æ–°å»ºæˆ–å®Œå–„ `Gong.Compaction`ï¼š

```elixir
def compact(messages, opts) do
  window = Keyword.get(opts, :window_size, 20)
  max_tokens = Keyword.get(opts, :max_tokens, 100_000)

  if estimate_tokens(messages) <= max_tokens do
    {messages, nil}
  else
    {old, recent} = Enum.split(messages, -window)
    summary = summarize(old)  # è°ƒ LLM ç”Ÿæˆæ‘˜è¦
    {[%{role: "system", content: summary} | recent], summary}
  end
end
```

æ ¸å¿ƒé€»è¾‘ï¼š
- Token ä¼°ç®—ï¼šæŒ‰å­—ç¬¦æ•°ç²—ä¼°ï¼ˆä¸­æ–‡ 1 å­— â‰ˆ 2 tokenï¼Œè‹±æ–‡ 1 word â‰ˆ 1.3 tokenï¼‰
- æ»‘åŠ¨çª—å£ï¼šä¿ç•™æœ€è¿‘ N æ¡å®Œæ•´æ¶ˆæ¯
- æ‘˜è¦ç”Ÿæˆï¼šè°ƒ LLM å¯¹æ—§æ¶ˆæ¯ç”Ÿæˆç»“æ„åŒ–æ‘˜è¦
- ç³»ç»Ÿæ¶ˆæ¯å’Œ anchor æ¶ˆæ¯ä¸å‚ä¸å‹ç¼©ï¼Œå§‹ç»ˆä¿ç•™

#### ä¸ Tape é…åˆ

å‹ç¼©è§¦å‘æ—¶ï¼ŒåŒæ—¶åœ¨ Tape ä¸­åˆ›å»ºæ–° anchorï¼š

```elixir
def compact_and_handoff(tape_store, messages, opts) do
  {compacted, summary} = compact(messages, opts)
  if summary do
    Gong.Tape.Store.handoff(tape_store, "compaction", %{summary: summary})
  end
  compacted
end
```

### 6b. ZCPG é›†æˆ â¸ï¸ æš‚ç¼“

#### å½“å‰ ZCPG æ¶æ„

ZCPG é€šè¿‡ `Zcpg.AI.AgentClient` behaviour è°ƒç”¨å¤–éƒ¨ agentï¼š

```elixir
# å½“å‰å®ç°ï¼šHTTP è°ƒ OpenCode (127.0.0.1:4096)
defmodule Zcpg.AI.Adapters.OpenCode do
  @behaviour Zcpg.AI.AgentClient

  def create_session(opts), do: ...   # POST /sessions
  def call(session, agent, input, opts), do: ...  # POST /sessions/:id/chat
  def stream(session, agent, input, callback, opts), do: ...  # SSE
  def abort(session, reason), do: ...
end
```

#### æ–°é€‚é…å™¨

åœ¨ ZCPG é¡¹ç›®ä¸­æ–°å»º `Zcpg.AI.Adapters.Gong`ï¼š

```elixir
defmodule Zcpg.AI.Adapters.Gong do
  @behaviour Zcpg.AI.AgentClient

  def create_session(opts) do
    # ä¸å† HTTPï¼Œç›´æ¥åœ¨ BEAM å†…å¯åŠ¨ Gong agent è¿›ç¨‹
    {:ok, pid} = DynamicSupervisor.start_child(
      Gong.SessionSupervisor,
      {Gong.AgentLoop, workspace: opts[:workspace]}
    )
    {:ok, %{pid: pid, session_id: inspect(pid)}}
  end

  def call(session, _agent, input, _opts) do
    Gong.AgentLoop.chat(session.pid, input)
  end

  def stream(session, _agent, input, callback, _opts) do
    Gong.AgentLoop.stream(session.pid, input, callback)
  end

  def abort(session, _reason) do
    Gong.AgentLoop.cancel(session.pid)
  end
end
```

#### é›†æˆæ­¥éª¤

1. ZCPG çš„ `mix.exs` æ·»åŠ  `{:gong, path: "../gong"}` ä¾èµ–
2. æ–°å»º `Zcpg.AI.Adapters.Gong` æ¨¡å—
3. é…ç½®åˆ‡æ¢ï¼š`config :zcpg, :agent_adapter, Zcpg.AI.Adapters.Gong`
4. ä¿ç•™ OpenCode é€‚é…å™¨ä½œä¸ºå›é€€
5. éªŒè¯ 4 ä¸ª agent åœºæ™¯ï¼škb-triageã€kb-answerã€rlm-plannerã€build

#### é…ç½®ç¤ºä¾‹

```elixir
# config/config.exs
config :zcpg, :agent_adapter, Zcpg.AI.Adapters.Gong

config :gong,
  model: "anthropic/claude-sonnet-4-5-20250929",
  api_key: System.get_env("ANTHROPIC_API_KEY")
```

### é˜¶æ®µå…­äº¤ä»˜ç‰©

**6a å·²å®Œæˆï¼š**
- âœ… `Gong.Compaction` å®Œæ•´å®ç°ï¼ˆå« Token ä¼°ç®—ã€æ»‘åŠ¨çª—å£ã€ETS é”ã€fallback æˆªæ–­ï¼‰
- âœ… 14 ä¸ªå‹ç¼©ç³»ç»Ÿ BDD æµ‹è¯•é€šè¿‡ï¼ˆJ.12 èŠ‚ï¼Œå« summarize_fn å´©æºƒã€é”éš”ç¦»ã€window è¾¹ç•Œç­‰ï¼‰

**6b æš‚ç¼“ï¼š**
- `Zcpg.AI.Adapters.Gong` é€‚é…å™¨ï¼ˆå¾…åç»­å¯åŠ¨ï¼‰
- ZCPG å¯é€šè¿‡é…ç½®åˆ‡æ¢ä½¿ç”¨ Gong æˆ– OpenCode
- ç«¯åˆ°ç«¯éªŒè¯ï¼šZCPG é¡µé¢å‘æ¶ˆæ¯ â†’ Gong agent å¤„ç† â†’ æµå¼è¿”å›

---

## é‡Œç¨‹ç¢‘æ€»ç»“

| é˜¶æ®µ | äº¤ä»˜ç‰© | ç´¯è®¡æµ‹è¯• | å¤–éƒ¨ä¾èµ– | çŠ¶æ€ |
|------|--------|----------|----------|------|
| ä¸€ | 7 ä¸ªå·¥å…· Action å®Œæ•´å®ç° | 85 | æ—  | âœ… å®Œæˆ |
| äºŒ | æˆªæ–­ç³»ç»Ÿ + å·¥å…·å¯¹æ¥ | 99 | æ—  | âœ… å®Œæˆ |
| ä¸‰ | Agent å¾ªç¯ + LLM è°ƒç”¨ | 129 | LLM API key | âœ… å®Œæˆ |
| å›› | Hook ç³»ç»Ÿ | 152 | æ—  | âœ… å®Œæˆ |
| äº” | Tape å­˜å‚¨ï¼ˆæ–‡ä»¶å¤¹ + SQLiteï¼‰ | 186 | æ—  | âœ… å®Œæˆ |
| å…­a | å‹ç¼©ç³»ç»Ÿ | 200 | æ—  | âœ… å®Œæˆ |
| ä¸ƒ | æ¶æ„ç¼ºå£è¡¥å…¨ï¼ˆ20 ä¸ªæ–° BDD åœºæ™¯ï¼‰ | ~220 | æ—  | ğŸ“‹ å¾…å®ç° |
| å…­b | ZCPG é›†æˆ | â€” | ZCPG é¡¹ç›® | â¸ï¸ æš‚ç¼“ |

### å¹¶è¡Œåº¦

```
æ—¶é—´çº¿ â†’

é˜¶æ®µä¸€ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
é˜¶æ®µäºŒ          â–ˆâ–ˆâ–ˆâ–ˆ
é˜¶æ®µä¸‰              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
é˜¶æ®µå››                          â–ˆâ–ˆâ–ˆâ–ˆ
é˜¶æ®µäº”          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â† å¯ä¸äºŒã€ä¸‰ã€å››å¹¶è¡Œ
é˜¶æ®µå…­                              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
```

é˜¶æ®µäº”ï¼ˆTape å­˜å‚¨ï¼‰æ˜¯å®Œå…¨ç‹¬ç«‹çš„æ¨¡å—ï¼Œå¯ä»¥åœ¨é˜¶æ®µäºŒå¼€å§‹åéšæ—¶å¹¶è¡Œæ¨è¿›ã€‚
é˜¶æ®µå››ï¼ˆHook ç³»ç»Ÿï¼‰ä¾èµ–é˜¶æ®µä¸‰çš„ Agent å¾ªç¯ï¼Œå› ä¸º Hook çš„é›†æˆç‚¹åœ¨å¾ªç¯ä¸­ã€‚

### é£é™©ç‚¹

1. **jido_ai çš„ ReAct ç­–ç•¥** â€” main åˆ†æ”¯æœªå‘å¸ƒåˆ° hexï¼ŒAPI å¯èƒ½å˜åŠ¨ã€‚åº”å¯¹ï¼špin commit hash
2. **Elixir ç‰ˆæœ¬** â€” jido_browser å’Œ yaml_elixir è¦æ±‚ 1.18ï¼Œå½“å‰ç³»ç»Ÿæ˜¯ 1.17.3ã€‚åº”å¯¹ï¼šå‡çº§ Elixir æˆ–æ’é™¤ jido_browser
3. **tool_call æ ¼å¼å…¼å®¹** â€” ä¸åŒ LLM æä¾›å•†çš„ tool_call æ ¼å¼æœ‰ç»†å¾®å·®å¼‚ã€‚åº”å¯¹ï¼šå…ˆé”å®š Anthropicï¼Œå…¶ä»–æä¾›å•†ç•™ä½
4. **Tape åŒå†™ä¸€è‡´æ€§** â€” æ–‡ä»¶å†™æˆåŠŸä½† SQLite å†™å¤±è´¥ã€‚åº”å¯¹ï¼šrebuild_index ä¿®å¤æœºåˆ¶

---

## æ¶æ„æ–‡æ¡£ç¼ºå£æ¸…å•ï¼ˆä» pi-mono å¯¹æ¯”å‘ç°ï¼‰

ä»¥ä¸‹ç‰¹æ€§åœ¨ `æ¶æ„è®¾è®¡.md` ä¸­æœ‰æè¿°ï¼Œä½†åœ¨ä¹‹å‰çš„å®æ–½è®¡åˆ’ä¸­é—æ¼ï¼Œå¯¼è‡´æœªå®ç°ã€‚æŒ‰ä¼˜å…ˆçº§åˆ†ç»„åˆ—å‡ºï¼Œæ¯é¡¹æ ‡æ³¨æ¶æ„æ–‡æ¡£å‡ºå¤„å’Œ BDD è¦†ç›–çŠ¶æ€ã€‚

### P0ï¼šAgent å¾ªç¯æ ¸å¿ƒèƒ½åŠ›

#### 7.1 Steering ä¸­æ–­

ç”¨æˆ·åœ¨ Agent æ‰§è¡Œå·¥å…·é“¾æœŸé—´å‘é€æ–°æ¶ˆæ¯ï¼Œåº”èƒ½æ‰“æ–­å½“å‰æ‰§è¡Œã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 2.2ï¼ˆåŒå±‚å¾ªç¯ steering æœºåˆ¶ï¼‰ã€J.9 test 1.4
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - Agent æ¯æ‰§è¡Œå®Œä¸€ä¸ª tool_call åæ£€æŸ¥ steering æ¶ˆæ¯é˜Ÿåˆ—
  - æœ‰ steering æ—¶è·³è¿‡å‰©ä½™ tool_callï¼Œæ ‡è®°ä¸º `"Skipped due to queued user message"`
  - OTP å®ç°ï¼š`GenServer.cast` æ³¨å…¥ steeringï¼Œ`check_steering/1` ä» mailbox è¯»å–
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-AGENT-031`ï¼šsteering ä¸­æ–­è·³è¿‡å‰©ä½™å·¥å…·
  - `BDD-AGENT-032`ï¼šsteering æ¶ˆæ¯åœ¨ä¸‹ä¸€è½®è¢«æ­£ç¡®å¤„ç†

#### 7.2 Auto-Retryï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰

LLM API è¿”å› 429/overloaded/server error æ—¶è‡ªåŠ¨æŒ‡æ•°é€€é¿é‡è¯•ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šJ.9 tests 4.3, 4.7, 5.1, 5.4, 5.6
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - æ£€æµ‹å¯é‡è¯•é”™è¯¯ï¼ˆ429 Too Many Requestsã€overloadedã€5xxï¼‰
  - æŒ‡æ•°é€€é¿ï¼š1s â†’ 2s â†’ 4s â†’ 8sï¼Œæœ€å¤š 3 æ¬¡
  - 429 ä¸è§¦å‘å‹ç¼©ï¼ˆPi bug #1038 å›å½’ï¼‰
  - retry åœ¨å·¥å…·æ‰§è¡Œå®Œæˆåæ‰ resolveï¼ˆPi bug #1465 å›å½’ï¼‰
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-AGENT-033`ï¼š429 è§¦å‘é‡è¯•è€Œéå‹ç¼©
  - `BDD-AGENT-034`ï¼šé‡è¯•æˆåŠŸåæ­£å¸¸ç»§ç»­
  - `BDD-AGENT-035`ï¼šé‡è¯•è€—å°½è¿”å›é”™è¯¯

#### 7.3 Auto-Compactionï¼ˆè‡ªåŠ¨å‹ç¼©ï¼‰

Agent å¯¹è¯åè‡ªåŠ¨æ£€æµ‹ä¸Šä¸‹æ–‡æº¢å‡ºå¹¶è§¦å‘å‹ç¼©ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.1ï¼ˆè§¦å‘æ¡ä»¶ï¼‰ã€J.9 tests 4.3, 4.4
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ˆå½“å‰éœ€æ‰‹åŠ¨è°ƒç”¨ `compact/2`ï¼‰ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - æ¯è½® Agent ç»“æŸåæ£€æŸ¥ï¼š`contextTokens > (contextWindow - reserveTokens)`
  - `reserveTokens` é»˜è®¤ 16384
  - å‹ç¼©æœŸé—´æ’é˜Ÿçš„ç”¨æˆ·æ¶ˆæ¯ä¸ä¸¢å¤±ï¼ˆPi bug #1312 å›å½’ï¼‰
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-AGENT-036`ï¼šä¸Šä¸‹æ–‡è¶…é™è‡ªåŠ¨è§¦å‘å‹ç¼©
  - `BDD-AGENT-037`ï¼šå‹ç¼©æœŸé—´æ’é˜Ÿæ¶ˆæ¯æ¢å¤

### P1ï¼šCompaction å¢å¼º

#### 7.4 Token é¢„ç®—çª—å£ï¼ˆæ›¿ä»£æ¶ˆæ¯æ•°çª—å£ï¼‰

å½“å‰æŒ‰æ¶ˆæ¯æ•°åˆ‡ï¼ˆ`window_size=20`ï¼‰ï¼Œåº”æ”¹ä¸ºæŒ‰ token é¢„ç®—åˆ‡ï¼ˆ`keepRecentTokens=20000`ï¼‰ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.1/6.2ï¼ˆkeepRecentTokensï¼‰
- **å½“å‰çŠ¶æ€**ï¼šâš ï¸ å®ç°ä¸æ¶æ„ä¸ä¸€è‡´ï¼ˆç”¨æ¶ˆæ¯æ•°ä»£æ›¿ token é¢„ç®—ï¼‰ï¼Œâœ… BDD æœ‰ max_tokens é˜ˆå€¼æµ‹è¯•ä½†çª—å£æœ¬èº«æœªæµ‹
- **å®ç°è¦ç‚¹**ï¼š
  - ä»æœ€æ–°æ¶ˆæ¯å¾€å›éå†ï¼Œç´¯åŠ  token ä¼°ç®—å€¼
  - ç´¯è®¡è¶…è¿‡ `keepRecentTokens`ï¼ˆé»˜è®¤ 20000ï¼‰æ—¶ç¡®å®šåˆ‡å‰²ç‚¹
  - åˆ‡å‰²ç‚¹å¿…é¡»åœ¨æœ‰æ•ˆè¾¹ç•Œï¼ˆè§ 7.5ï¼‰

#### 7.5 tool_call/result é…å¯¹ä¿æŠ¤

å‹ç¼©åˆ‡å‰²æ—¶ä¸èƒ½æŠŠ tool_call å’Œå¯¹åº”çš„ tool_result æ‹†å¼€ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.2 step 3-4ã€J.9 tests 4.2, 4.6
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - åˆ‡å‰²ç‚¹åªèƒ½è½åœ¨ user/assistant æ¶ˆæ¯è¾¹ç•Œ
  - ä¸èƒ½åˆ‡åœ¨ tool_result ä¸­é—´
  - å¦‚æœåˆ‡åœ¨å¸¦ tool_calls çš„ assistant æ¶ˆæ¯ä¸­é—´ï¼Œç”Ÿæˆè½¬æŠ˜æ‘˜è¦
  - å­¤å„¿ tool_result æ¸…ç†
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-COMPACT-015`ï¼šåˆ‡å‰²ç‚¹è·³è¿‡ tool_result åˆ°å‰ä¸€ä¸ª user æ¶ˆæ¯
  - `BDD-COMPACT-016`ï¼šå­¤å„¿ tool_result è¢«æ¸…ç†

#### 7.6 ç»“æ„åŒ–æ‘˜è¦ Prompt

å‹ç¼©æ‘˜è¦åº”ä½¿ç”¨ç»“æ„åŒ–æ¨¡æ¿ï¼Œè€Œééšæ„ç”Ÿæˆã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.2 step 5
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ˆå½“å‰ `summarize_fn` å§”æ‰˜å¤–éƒ¨ï¼‰ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - Compaction æ¨¡å—å†…ç½®é»˜è®¤ `summarize_fn`ï¼Œæ„å»ºç»“æ„åŒ– prompt
  - æ‘˜è¦æ¨¡æ¿åŒ…å« 6 ä¸ªåˆ†ç±»ï¼šGoalã€Constraints & Preferencesã€Progressï¼ˆDone/In Progress/Blockedï¼‰ã€Key Decisionsã€Next Stepsã€Critical Context
  - è¿½åŠ æ–‡ä»¶æ“ä½œè®°å½•ï¼ˆread/write/edit æ±‡æ€»ï¼‰
  - ä½¿ç”¨ç‹¬ç«‹ system prompt é˜²æ­¢æ¨¡å‹ç»­å†™å¯¹è¯
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-COMPACT-017`ï¼šmock summarize_fn æ•è·è¾“å…¥ï¼Œæ–­è¨€åŒ…å«ç»“æ„åŒ–å­—æ®µæ ‡è®°ï¼ˆGoalã€Progress ç­‰ï¼‰
  - `BDD-COMPACT-018`ï¼šæ‘˜è¦è¾“å…¥åŒ…å«æ–‡ä»¶æ“ä½œæ±‡æ€»

#### 7.7 è¿­ä»£æ‘˜è¦æ›´æ–°

å½“å·²æœ‰å‰æ¬¡å‹ç¼©æ‘˜è¦æ—¶ï¼Œå¢é‡æ›´æ–°è€Œéä»å¤´ç”Ÿæˆã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection 6.2 step 7
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - æ£€æµ‹æ˜¯å¦å·²æœ‰ compaction summary æ¡ç›®
  - æœ‰ â†’ ä½¿ç”¨ UPDATE_SUMMARIZATION_PROMPT å¢é‡åˆå¹¶æ–°ä¿¡æ¯
  - æ—  â†’ ä½¿ç”¨å®Œæ•´ SUMMARIZATION_PROMPT
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-COMPACT-019`ï¼šé¦–æ¬¡å‹ç¼©ï¼Œsummarize_fn æ”¶åˆ°å®Œæ•´ SUMMARIZATION prompt
  - `BDD-COMPACT-020`ï¼šäºŒæ¬¡å‹ç¼©ï¼Œsummarize_fn æ”¶åˆ° UPDATE prompt + å‰æ¬¡æ‘˜è¦å†…å®¹

### P2ï¼šå·¥å…·å±‚è¡¥å…¨

#### 7.8 Edit BOM/CRLF å¤„ç† + Diff ç”Ÿæˆ

æ¶æ„æ–‡æ¡£ Section A è¯¦ç»†æè¿°äº† 10 æ­¥ edit æµç¨‹ï¼Œå½“å‰å®ç°ç¼ºå°‘ BOMã€CRLFã€diff ä¸‰å—ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection A steps 4-6, 9-10ï¼›J.1 tests 3.1-3.5, 5.3
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯ï¼ˆDSL æ–‡ä»¶æ³¨é‡Šå·²æ ‡"å¾…åç»­è¡¥å……"ï¼‰
- **å®ç°è¦ç‚¹**ï¼š
  - BOM æ£€æµ‹ï¼ˆ`\uFEFF`ï¼‰â†’ å‰¥ç¦» â†’ åŒ¹é…/æ›¿æ¢ â†’ æ¢å¤
  - CRLF æ£€æµ‹ â†’ ç»Ÿä¸€è½¬ LF â†’ åŒ¹é…/æ›¿æ¢ â†’ æ¢å¤åŸå§‹è¡Œå°¾
  - Diff ç”Ÿæˆï¼š4 è¡Œä¸Šä¸‹æ–‡ unified diff + `first_changed_line`
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼Œå¯¹åº” J.1 tests 3.x, 5.3ï¼‰ï¼š
  - `BDD-EDIT-017`ï¼šCRLF æ–‡ä»¶è·¨å¹³å°åŒ¹é…
  - `BDD-EDIT-018`ï¼šCRLF è¡Œå°¾ä¿ç•™
  - `BDD-EDIT-019`ï¼šLF è¡Œå°¾ä¿ç•™ï¼ˆæ—  `\r\n` æ³¨å…¥ï¼‰
  - `BDD-EDIT-020`ï¼šæ··åˆè¡Œå°¾é‡å¤æ£€æµ‹
  - `BDD-EDIT-021`ï¼šBOM + CRLF è”åˆä¿ç•™
  - `BDD-EDIT-022`ï¼šdiff è¡Œå·æ­£ç¡®æ€§ï¼ˆè¿œç¦»æ–‡ä»¶å¼€å¤´ï¼‰

#### 7.9 Find å°Šé‡ .gitignore

å½“å‰ç”¨ `Path.wildcard`ï¼Œä¸æ”¯æŒ `.gitignore`ã€‚æ¶æ„æ–‡æ¡£æŒ‡å®šç”¨ `fd` + `--ignore-file`ã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection Fï¼›J.6 test 2.1
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - æ”¶é›†ç›®å½•æ ‘ä¸­æ‰€æœ‰ `.gitignore` æ–‡ä»¶
  - æ”¹ç”¨ `fd` å‘½ä»¤æˆ–æ‰‹åŠ¨è§£æ `.gitignore` è§„åˆ™
  - ç»“æœä»æŒ‰ä¿®æ”¹æ—¶é—´æ’åº
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-FIND-008`ï¼š.gitignore ä¸­çš„æ–‡ä»¶ä¸å‡ºç°åœ¨ç»“æœé‡Œ

#### 7.10 Bash å¤§è¾“å‡ºæ»šåŠ¨ç¼“å†² + ä¸´æ—¶æ–‡ä»¶

å½“å‰ bash è¾“å‡ºè¶…é™ç›´æ¥æˆªæ–­ä¸¢å¼ƒã€‚æ¶æ„æ–‡æ¡£è¦æ±‚å†™ä¸´æ—¶æ–‡ä»¶ä¿ç•™å®Œæ•´è¾“å‡ºã€‚

- **æ¶æ„å‡ºå¤„**ï¼šSection Bï¼›J.2 tests 3.1, 3.2
- **å½“å‰çŠ¶æ€**ï¼šâŒ æœªå®ç°ï¼ŒâŒ æ—  BDD åœºæ™¯
- **å®ç°è¦ç‚¹**ï¼š
  - å†…å­˜ä¿ç•™æœ€è¿‘ 100KB æ»šåŠ¨ç¼“å†²åŒº
  - æ€»è¾“å‡º > 50KB æ—¶å†™ä¸´æ—¶æ–‡ä»¶ `/tmp/gong-bash-{random}.log`
  - æˆªæ–­é€šçŸ¥åŒ…å«ä¸´æ—¶æ–‡ä»¶è·¯å¾„
- **BDD åœºæ™¯**ï¼ˆéœ€æ–°å¢ï¼‰ï¼š
  - `BDD-BASH-015`ï¼šå¤§è¾“å‡ºåˆ›å»ºä¸´æ—¶æ–‡ä»¶
  - `BDD-BASH-016`ï¼šæˆªæ–­é€šçŸ¥åŒ…å«æ–‡ä»¶è·¯å¾„

---

## BDD è¦†ç›–ç¼ºå£æ±‡æ€»

| ç¼ºå£ | éœ€æ–°å¢åœºæ™¯ | å¯¹åº”æ¶æ„æµ‹è¯• |
|------|-----------|-------------|
| Steering ä¸­æ–­ | BDD-AGENT-031~032 | J.9 test 1.4 |
| Auto-retry | BDD-AGENT-033~035 | J.9 tests 4.3, 4.7, 5.1 |
| Auto-compaction | BDD-AGENT-036~037 | J.9 tests 4.3, 4.4 |
| tool_call/result é…å¯¹ | BDD-COMPACT-015~016 | J.9 tests 4.2, 4.6; Section 6.2 |
| ç»“æ„åŒ–æ‘˜è¦ prompt | BDD-COMPACT-017~018 | Section 6.2 step 5 |
| è¿­ä»£æ‘˜è¦æ›´æ–° | BDD-COMPACT-019~020 | Section 6.2 step 7 |
| Edit BOM/CRLF/Diff | BDD-EDIT-017~022 | J.1 tests 3.1-3.5, 5.3 |
| Find .gitignore | BDD-FIND-008 | J.6 test 2.1 |
| Bash ä¸´æ—¶æ–‡ä»¶ | BDD-BASH-015~016 | J.2 tests 3.1, 3.2 |
| **åˆè®¡** | **20 ä¸ªæ–°åœºæ™¯** | |
