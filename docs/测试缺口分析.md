# 测试缺口分析 — 基于 pi-mono 3041 commits / 333 个后端 bugfix

来源：pi-mono 项目 767 个 fix 提交中筛选出 333 个后端相关 bugfix，
对照 Gong 现有 465 个 BDD 场景，找出覆盖缺口。

分析范围：`fix(ai|agent|coding-agent)` 258 个 + `fix(hooks|tools|plan-mode|session|...)` 48 个 + 无前缀后端 fix 27 个。
排除范围：`fix(tui)` 68、`fix(mom)` 6、`fix(pi-dosbox)` 3、`fix(ci|build)` 5、web-ui/docs/theme 等。

---

## 1. 厂商兼容性（pi 修了 52+ 个 bug）

**Gong 现状：** 依赖 ReqLLM 库，自身 providers/ 只有 13 行。基本没测厂商边界。

**pi 踩过的坑：**
- Google 不支持流式工具调用、`parametersJsonSchema` vs 替代字段
- Anthropic 需要 `dangerous-direct-browser-access` header、敏感 `stop_reason` 值
- OpenAI Responses API 不支持多轮、`arguments.done` 事件未处理
- Bedrock 的 auth 跳过标志在错误作用域、非 Anthropic 模型缺签名支持
- DeepSeek 不支持 `developer` 角色，需按 URL 检测后禁用
- Codex 的 `baseUrl` 不尊重、`encrypted_content` 丢失
- Claude via Google APIs 需要 tool call ID（`7a41975e`）
- Gatewayz provider 消息格式不兼容（`732d4612`）
- Chutes AI 400 错误（`bd1731c9`）
- Google Vertex 未认证时仍显示模型（`c9a85342`）
- GitHub Copilot X-Initiator header 逻辑错误（`575dcb26`）
- GPT-5 无推理模式没有真正的关闭开关（`f55985f6`）
- Z.ai thinking/reasoning 参数格式与 OpenAI 不同（`09d409cc`）
- Google provider block indexing 错误（`9e860793`）
- Gemini multimodal tool results 需要嵌套在 functionResponse.parts 内（`bf51dd41`）
- Provider feature detection 用 baseUrl 而非 model.provider（`f900eb59`）

**建议补充场景：**
- [ ] PROVIDER-ERR-001: 厂商返回非标准 stop_reason 时不崩溃
- [ ] PROVIDER-ERR-002: 厂商不支持的字段自动剥离（如 `store`、`developer` 角色）
- [ ] PROVIDER-ERR-003: 上下文窗口大小按模型动态适配
- [ ] PROVIDER-ERR-004: Provider 超时选项正确透传到 HTTP 客户端
- [ ] PROVIDER-ERR-005: 流中断/abort 后令牌统计仍保留已收到的部分数据
- [ ] PROVIDER-ERR-006: 跨网关路由 Claude 模型时包含必需的 provider 特定字段

---

## 2. 工具调用边界（pi 修了 19+ 个 bug）

**Gong 现状：** 141 个工具场景，覆盖功能充分，但缺少参数异常边界。

**pi 踩过的坑：**
- 工具参数为 `undefined`/`null` 而非 `{}`，下游崩溃
- 字符串数字 `"42"` 需强转为 number
- 工具名大小写不匹配（模型返回 `Read` 而非 `read`）
- 孤儿 tool_result：前一个 assistant 消息出错后，tool_result 失去父消息
- 工具调用 ID 含管道符等特殊字符，部分厂商拒绝
- 工具返回异常抛出而非错误内容块（`f147109d`）
- 未知 subagent 名称的错误消息缺少可用选项提示（`dae2eb5b`）
- 工具注册表只包含激活工具而非全部内置工具（`2849623a`、`31438fdf`）
- Tool mapping 错误（`0138eee6`）
- SDK 工具未尊重配置的 cwd 选项（`face745f`）

**建议补充场景：**
- [ ] TOOL-EDGE-001: 工具参数为 nil/空 map 时返回合理错误
- [ ] TOOL-EDGE-002: 工具名大小写不敏感匹配
- [ ] TOOL-EDGE-003: 工具调用 ID 含特殊字符时正常处理
- [ ] TOOL-EDGE-004: 孤儿 tool_result 不导致循环崩溃
- [ ] TOOL-EDGE-005: 工具错误返回 ToolResult(is_error: true) 而非抛出异常
- [ ] TOOL-EDGE-006: 错误消息包含可操作提示（如列出可用工具名）供 LLM 自纠正
- [ ] TOOL-EDGE-007: 空/null content 的 assistant 消息在发送前被过滤

---

## 3. 上下文切换（pi 修了 14+ 个 bug）

**Gong 现状：** 9 个场景，基本对等。

**pi 踩过的坑：**
- 跨厂商时 tool_call ID 格式不兼容（管道分隔符）
- `<thinking>` 标签泄露到不支持的厂商
- 同厂商不同模型切换时消息格式也不兼容
- 按模型名而非 API 类型做兼容性检查，误判
- 跨 provider 切换到 Anthropic/Copilot 时 tool call ID 规范化失败（`3c60ffa6`）
- 孤儿 tool calls 需插入合成空结果（`fb1fdb60`）
- Agent 事件排序：state 更新前就发射事件，handler 看到旧状态（`2b0aa5ed`）
- Bash 执行与 tool calls 交错：流式期间消息插入导致损坏（`2c014c1b`）

**建议补充场景：**
- [ ] CROSS-ERR-001: thinking 内容跨厂商转换为纯文本
- [ ] CROSS-ERR-002: 同厂商不同模型切换不丢消息
- [ ] CROSS-ERR-003: 带错误状态的 assistant 消息在转换时被过滤
- [ ] CROSS-ERR-004: 事件/状态一致性 — 事件 handler 观察到的 state 已包含最新消息
- [ ] CROSS-ERR-005: 流式期间 tool result 到达时被缓冲，不与 streaming turn 交错

---

## 4. 流式解析（pi 修了 11+ 个 bug）

**Gong 现状：** 13 个场景，缺中途中断和增量 JSON 边界。

**pi 踩过的坑：**
- `arguments.done` 事件未处理，工具调用参数不完整
- 流中途中断时部分结果丢失
- 增量 JSON 解析器在特定截断位置崩溃
- Z.ai 流式 tool call streaming 报告增量字符串 delta 而非部分 JSON 对象（`98a876f3`）
- `[DONE:id]` 模式跨多个流式 chunk 被拆分，需缓冲（`e27a2c22`）
- Hook/slash command 在流式期间执行的并发问题（`e9cf3c18`）

**建议补充场景：**
- [ ] STREAM-ERR-001: 流中途中断返回部分结果而非崩溃
- [ ] STREAM-ERR-002: 增量 JSON 在 key 截断位置的容错
- [ ] STREAM-ERR-003: 工具调用流式参数在 done 事件后完整组装
- [ ] STREAM-ERR-004: Hook/命令在活跃流式期间执行的并发安全

---

## 5. 令牌/成本/窗口（pi 修了 16+ 个 bug）

**Gong 现状：** 7 个场景，缺限流和窗口溢出处理。

**pi 踩过的坑：**
- 429 限流错误误触发自动压缩，丢失对话历史（最严重的 bug 之一）
- `context_length_exceeded` 错误未检测，无法触发压缩
- 模型上下文窗口大小配错，过早截断或溢出
- 流中断时令牌计数丢失
- Compaction 的 cut point 向前扫描越过 session header（`251fea75`）
- 分支摘要用 messagesToText 丢失 tool calls（`2ba69878`）
- Common ancestor 查找方向错误：正向找到 root 而非反向找最深共享节点（`92947a3d`）
- 切换模型后旧模型的 overflow 错误误触发新模型的压缩（`615ed0ae`）
- Compaction turn prefix 摘要逻辑错误（`72e29bce`）

**建议补充场景：**
- [ ] COST-ERR-001: 429 限流错误不触发压缩
- [ ] COST-ERR-002: context_length_exceeded 正确识别并触发压缩
- [ ] COST-ERR-003: 流中断时保留已收到的令牌计数
- [ ] COST-ERR-004: Compaction cut point 不越过 session header 边界
- [ ] COST-ERR-005: 分支摘要保留工具调用结构（不仅是文本）
- [ ] COST-ERR-006: 切换模型后旧模型的 overflow 错误不误触发新模型压缩

---

## 6. 认证/安全（pi 修了 16+ 个 bug）

**Gong 现状：** 9 个场景，缺锁文件损坏和代理穿透。

**pi 踩过的坑：**
- 认证锁文件损坏导致硬崩溃
- OAuth 刷新不走 HTTP 代理，企业环境失败
- 全局删除 `ANTHROPIC_API_KEY` 环境变量影响其他进程
- 登出后 scoped model 引用残留
- 长时间运行的 agent loop 中 OAuth token 过期（`1167e844`）
- Google Cloud Code Assist OAuth 处理错误（`c7bac758`、`c39250d0`）

**建议补充场景：**
- [ ] AUTH-ERR-001: 认证锁文件损坏时优雅恢复
- [ ] AUTH-ERR-002: API key 环境变量不被全局修改
- [ ] AUTH-ERR-003: 登出后清理模型引用
- [ ] AUTH-ERR-004: 长时间运行时 OAuth token 自动刷新

---

## 7. Thinking/Reasoning（pi 修了 17+ 个 bug）

**Gong 现状：** 10 个场景，缺跨厂商格式转换。

**pi 踩过的坑：**
- Codex 的 `encrypted_content` 丢失
- Google 的 `thoughtSignature`/`textSignature` 未识别为 thinking
- `maxTokens` 小于 `thinkingBudget` 导致 API 错误
- thinking 级别默认值不持久化
- Thinking tag 泄露：未签名的 thinking block 泄露为原始文本（`29379ea0`）
- 中止的 thinking block 缺少签名导致重提交时 400 错误（`433e7a2e`）
- Chutes provider 重复 thinking tokens（`36e77428`）
- Gemini 3 Flash Preview thinking level 处理错误（`d6903105`）
- GPT-5 no-reasoning 模式没有真正的关闭开关（`f55985f6`）
- Thinking 级别恢复时 off 状态丢失（`a3b38491`）

**建议补充场景：**
- [ ] THINK-ERR-001: maxTokens 自动调整为不小于 thinkingBudget
- [ ] THINK-ERR-002: 各厂商 thinking 标记统一识别
- [ ] THINK-ERR-003: thinking 级别持久化到会话（含 off 状态）

---

## 8. 会话/存储（pi 修了 22+ 个 bug）

**Gong 现状：** 6 个场景，覆盖偏薄。

**pi 踩过的坑：**
- fork 写入父会话文件而非新文件，损坏父会话
- fork 后用户消息丢失
- 恢复会话时资源和消息顺序错乱
- 中止/错误的 assistant 消息在会话树中隐藏
- 会话持久化：缓冲条目在首个 assistant 消息前未 flush（`184c6483`）
- --session 标志未加载消息和恢复 model/thinking（`75c2eea1`）
- Session UUID 跨项目查找静默失败（`48b43241`）
- 会话模型存储格式 provider+modelId 合并导致恢复失败（`f93da0b9`）
- 分支摘要中止处理：抛异常而非返回结果对象（`01dae9eb`）
- 待处理消息在 session 切换时未清理（`be330fdd`）
- SessionEntry 类型包含 SessionHeader 导致类型混乱（`9478a3c1`）
- 会话管理器简化引入的回归（`0faadfcd`）

**建议补充场景：**
- [ ] SESSION-ERR-001: fork 后父会话内容不变
- [ ] SESSION-ERR-002: fork 后用户消息保留
- [ ] SESSION-ERR-003: 恢复会话时消息顺序正确
- [ ] SESSION-ERR-004: 错误/中止的消息在会话树中可见
- [ ] SESSION-ERR-005: 待处理消息在 session 切换时被清理
- [ ] SESSION-ERR-006: 异步事件 handler 错误被正确传播而非静默吞掉

---

## 9. Bash/命令执行（pi 修了 15+ 个 bug）

**Gong 现状：** 23 个场景，但缺 UTF-8 编码和输出截断边界。

**pi 踩过的坑：**
- UTF-8 编码损坏（本地和远程，出现 3 次）
- 输出截断的 "earlier lines" 计数 off-by-one
- ANSI 转义码破坏 HTML 导出的缩进
- Bash abort 只杀父 shell，子进程继续运行（`6e9fa8dd`）
- 二进制输出中的 Unicode Format 字符和 lone surrogate 导致崩溃（`ad42ebf5`）

**建议补充场景：**
- [ ] BASH-ERR-001: 二进制/非 UTF-8 输出不崩溃
- [ ] BASH-ERR-002: 输出截断行数计算精确
- [ ] BASH-ERR-003: 含 ANSI 转义码的输出正确处理
- [ ] BASH-ERR-004: Abort 时清理整个进程组（不留孤儿子进程）

---

## 10. 编辑/文件操作（pi 修了 8+ 个 bug）

**Gong 现状：** 26 个 edit 场景 + 23 个 read 场景，覆盖较好。

**pi 踩过的坑：**
- macOS 弯引号文件名 + NFD Unicode 规范化
- 图片 MIME 检测靠扩展名而非 magic bytes
- write 工具错误被静默吞掉
- CRLF 行尾导致 edit 失败 — LLM 发送 LF-only 的 oldText（`8c43a9fb`）
- UTF-8 BOM 导致 edit 失败 — LLM 不包含不可见 BOM（`d9adf659`）

**Gong 已覆盖：** edit 的弯引号规范化、read 的 magic bytes 检测。
**可补充：**
- [ ] FILE-ERR-001: NFD/NFC Unicode 路径规范化
- [ ] FILE-ERR-002: CRLF 行尾文件编辑时自动规范化匹配
- [ ] FILE-ERR-003: UTF-8 BOM 文件编辑时自动剥离 BOM 再匹配

---

## 11. 扩展/Hook（pi 修了 47+ 个 bug）

**Gong 现状：** Hook 系统有完整测试（崩溃容错、超时保护）。Extension 有基础测试。

**pi 踩过的坑：**
- 扩展加载错误被静默吞掉
- 多个扩展的 tool_result 补丁不链式应用
- 多文件扩展包发现失败
- 符号链接不被发现
- 扩展冲突无过滤
- Hook 错误缺少 stack trace（`6390ff87`）
- Context event 的 messages 未深拷贝传给 hooks（`ddf8bfce`）
- Hook tool_result event 工具出错时不发射（`02d0d6e1`）
- `--no-extensions` 标志未阻止扩展发现（`3326b8f5`）
- 扩展自定义编辑器持有过期的 onEscape 引用（`828c40cf`）
- messageTransformer 未规范化 HookMessage string content 为数组（`574f1cba`）
- 模块脚本验证和扩展上下文检测问题（`372be186`）
- Custom tool subpath import 的 jiti alias 解析错误（`66d19ac9`）

**建议补充场景：**
- [ ] EXT-ERR-001: 多扩展 hook 链式执行
- [ ] EXT-ERR-002: 符号链接扩展能被发现
- [ ] EXT-ERR-003: 扩展冲突时有明确错误提示
- [ ] EXT-ERR-004: Hook 接收的 messages 是深拷贝，hook 修改不影响原始数据
- [ ] EXT-ERR-005: 扩展禁用标志（--no-extensions）在所有代码路径生效
- [ ] EXT-ERR-006: Custom tool 的子路径 import 正确解析

---

## 12. 配置/注册表（pi 修了 22+ 个 bug）

**Gong 现状：** 5 个模型注册表场景，缺配置合并边界。

**pi 踩过的坑：**
- 模型覆盖合并不健壮，缺失字段崩溃
- models.json 字段全必填，新增可选字段时全线崩溃
- 全局设置修改后不重新加载
- `--no-skills` 标志未阻止 skills 加载（`af2d8509`）
- Skills preamble 缺少路径解析指引（`3c687b42`）
- 自定义系统提示词缺少 context/skills/date/cwd（`fbfdeb2c`）
- Reasoning 默认对所有 provider 禁用（`fbda78bf`）
- API key 优先级错误：OAUTH_TOKEN 应优先于 API_KEY（`251fea75`）
- Settings.json 中的 API key 在模型选择器中不可见（`ac5f4a77`）

**建议补充场景：**
- [ ] CONFIG-ERR-001: 模型覆盖部分字段缺失时用默认值
- [ ] CONFIG-ERR-002: 配置热重载
- [ ] CONFIG-ERR-003: 空数组配置的语义正确（空 = 阻止全部 vs 不过滤）
- [ ] CONFIG-ERR-004: 系统提示词组装完整（包含 context、skills、时间、cwd）

---

## 优先级排序

按影响面和 Gong 当前缺口排序：

| 优先级 | 领域 | Gong 缺口 | 建议场景数 |
|--------|------|-----------|-----------|
| P0 | 令牌/成本/窗口 | 429 误触压缩、切割点越界、跨模型误触发 | 6 |
| P0 | 会话/存储 | fork 损坏、消息丢失、session 切换泄漏 | 6 |
| P1 | 工具调用边界 | 空参数、孤儿 result、异常 vs 错误返回 | 7 |
| P1 | Bash 编码 | UTF-8 损坏、截断精度、进程组清理 | 4 |
| P1 | Thinking | 跨厂商格式、budget 约束、级别持久化 | 3 |
| P1 | 上下文切换 | thinking 泄露、事件排序、流式交错 | 5 |
| P2 | 流式解析 | 中途中断、增量 JSON、流式并发 | 4 |
| P2 | 认证 | 锁文件损坏、key 污染、OAuth 过期 | 4 |
| P2 | 扩展/Hook | 链式执行、深拷贝、禁用标志绕过 | 6 |
| P2 | 配置/注册表 | 合并健壮性、热重载、系统提示完整性 | 4 |
| P3 | 厂商兼容性 | ReqLLM 挡了大部分，但需防御 | 6 |
| P3 | 文件操作 | Unicode 路径、CRLF/BOM 编辑 | 3 |

**总计建议新增：58 个 BDD 场景**（原始 36 + 第二轮 14 + 第三轮 8）

---

## 分析方法

- **第 1 轮**：筛选 `fix(ai|agent|coding-agent)` 提交 → 258 个
- **第 2 轮**：补充 `fix(hooks|tools|plan-mode|session|subagent|skills|diff)` + 部分无前缀 → +48 个
- **第 3 轮**：扫描全部剩余无前缀 fix + `fix(sdk|gitlab-duo)` → +27 个
- **排除**：`fix(tui)` 68、`fix(mom)` 6、`fix(pi-dosbox)` 3、`fix(ci|build)` 5、web-ui/docs/theme 等非后端提交
- **总计**：767 个 fix 提交中 333 个后端相关，434 个非后端
