# 测试缺口分析 — 基于 pi-mono 2930 commits / 258 个后端 bugfix

来源：pi-mono 项目 258 个 `fix(ai|agent|coding-agent)` 提交的分类分析，
对照 Gong 现有 465 个 BDD 场景，找出覆盖缺口。

---

## 1. 厂商兼容性（pi 修了 42 个 bug）

**Gong 现状：** 依赖 ReqLLM 库，自身 providers/ 只有 13 行。基本没测厂商边界。

**pi 踩过的坑：**
- Google 不支持流式工具调用、`parametersJsonSchema` vs 替代字段
- Anthropic 需要 `dangerous-direct-browser-access` header、敏感 `stop_reason` 值
- OpenAI Responses API 不支持多轮、`arguments.done` 事件未处理
- Bedrock 的 auth 跳过标志在错误作用域、非 Anthropic 模型缺签名支持
- DeepSeek 不支持 `developer` 角色，需按 URL 检测后禁用
- Codex 的 `baseUrl` 不尊重、`encrypted_content` 丢失

**建议补充场景：**
- [ ] PROVIDER-ERR-001: 厂商返回非标准 stop_reason 时不崩溃
- [ ] PROVIDER-ERR-002: 厂商不支持的字段自动剥离（如 `store`、`developer` 角色）
- [ ] PROVIDER-ERR-003: 上下文窗口大小按模型动态适配

---

## 2. 工具调用边界（pi 修了 15 个 bug）

**Gong 现状：** 141 个工具场景，覆盖功能充分，但缺少参数异常边界。

**pi 踩过的坑：**
- 工具参数为 `undefined`/`null` 而非 `{}`，下游崩溃
- 字符串数字 `"42"` 需强转为 number
- 工具名大小写不匹配（模型返回 `Read` 而非 `read`）
- 孤儿 tool_result：前一个 assistant 消息出错后，tool_result 失去父消息
- 工具调用 ID 含管道符等特殊字符，部分厂商拒绝

**建议补充场景：**
- [ ] TOOL-EDGE-001: 工具参数为 nil/空 map 时返回合理错误
- [ ] TOOL-EDGE-002: 工具名大小写不敏感匹配
- [ ] TOOL-EDGE-003: 工具调用 ID 含特殊字符时正常处理
- [ ] TOOL-EDGE-004: 孤儿 tool_result 不导致循环崩溃

---

## 3. 上下文切换（pi 修了 10 个 bug）

**Gong 现状：** 9 个场景，基本对等。

**pi 踩过的坑：**
- 跨厂商时 tool_call ID 格式不兼容（管道分隔符）
- `<thinking>` 标签泄露到不支持的厂商
- 同厂商不同模型切换时消息格式也不兼容
- 按模型名而非 API 类型做兼容性检查，误判

**建议补充场景：**
- [ ] CROSS-ERR-001: thinking 内容跨厂商转换为纯文本
- [ ] CROSS-ERR-002: 同厂商不同模型切换不丢消息
- [ ] CROSS-ERR-003: 带错误状态的 assistant 消息在转换时被过滤

---

## 4. 流式解析（pi 修了 8 个 bug）

**Gong 现状：** 13 个场景，缺中途中断和增量 JSON 边界。

**pi 踩过的坑：**
- `arguments.done` 事件未处理，工具调用参数不完整
- 流中途中断时部分结果丢失
- 增量 JSON 解析器在特定截断位置崩溃

**建议补充场景：**
- [ ] STREAM-ERR-001: 流中途中断返回部分结果而非崩溃
- [ ] STREAM-ERR-002: 增量 JSON 在 key 截断位置的容错
- [ ] STREAM-ERR-003: 工具调用流式参数在 done 事件后完整组装

---

## 5. 令牌/成本/窗口（pi 修了 10 个 bug）

**Gong 现状：** 7 个场景，缺限流和窗口溢出处理。

**pi 踩过的坑：**
- 429 限流错误误触发自动压缩，丢失对话历史（最严重的 bug 之一）
- `context_length_exceeded` 错误未检测，无法触发压缩
- 模型上下文窗口大小配错，过早截断或溢出
- 流中断时令牌计数丢失

**建议补充场景：**
- [ ] COST-ERR-001: 429 限流错误不触发压缩
- [ ] COST-ERR-002: context_length_exceeded 正确识别并触发压缩
- [ ] COST-ERR-003: 流中断时保留已收到的令牌计数

---

## 6. 认证/安全（pi 修了 14 个 bug）

**Gong 现状：** 9 个场景，缺锁文件损坏和代理穿透。

**pi 踩过的坑：**
- 认证锁文件损坏导致硬崩溃
- OAuth 刷新不走 HTTP 代理，企业环境失败
- 全局删除 `ANTHROPIC_API_KEY` 环境变量影响其他进程
- 登出后 scoped model 引用残留

**建议补充场景：**
- [ ] AUTH-ERR-001: 认证锁文件损坏时优雅恢复
- [ ] AUTH-ERR-002: API key 环境变量不被全局修改
- [ ] AUTH-ERR-003: 登出后清理模型引用

---

## 7. Thinking/Reasoning（pi 修了 14 个 bug）

**Gong 现状：** 10 个场景，缺跨厂商格式转换。

**pi 踩过的坑：**
- Codex 的 `encrypted_content` 丢失
- Google 的 `thoughtSignature`/`textSignature` 未识别为 thinking
- `maxTokens` 小于 `thinkingBudget` 导致 API 错误
- thinking 级别默认值不持久化

**建议补充场景：**
- [ ] THINK-ERR-001: maxTokens 自动调整为不小于 thinkingBudget
- [ ] THINK-ERR-002: 各厂商 thinking 标记统一识别
- [ ] THINK-ERR-003: thinking 级别持久化到会话

---

## 8. 会话/存储（pi 修了 16 个 bug）

**Gong 现状：** 6 个场景，覆盖偏薄。

**pi 踩过的坑：**
- fork 写入父会话文件而非新文件，损坏父会话
- fork 后用户消息丢失
- 恢复会话时资源和消息顺序错乱
- 中止/错误的 assistant 消息在会话树中隐藏

**建议补充场景：**
- [ ] SESSION-ERR-001: fork 后父会话内容不变
- [ ] SESSION-ERR-002: fork 后用户消息保留
- [ ] SESSION-ERR-003: 恢复会话时消息顺序正确
- [ ] SESSION-ERR-004: 错误/中止的消息在会话树中可见

---

## 9. Bash/命令执行（pi 修了 13 个 bug）

**Gong 现状：** 23 个场景，但缺 UTF-8 编码和输出截断边界。

**pi 踩过的坑：**
- UTF-8 编码损坏（本地和远程，出现 3 次）
- 输出截断的 "earlier lines" 计数 off-by-one
- ANSI 转义码破坏 HTML 导出的缩进

**建议补充场景：**
- [ ] BASH-ERR-001: 二进制/非 UTF-8 输出不崩溃
- [ ] BASH-ERR-002: 输出截断行数计算精确
- [ ] BASH-ERR-003: 含 ANSI 转义码的输出正确处理

---

## 10. 编辑/文件操作（pi 修了 6 个 bug）

**Gong 现状：** 26 个 edit 场景 + 23 个 read 场景，覆盖较好。

**pi 踩过的坑：**
- macOS 弯引号文件名 + NFD Unicode 规范化
- 图片 MIME 检测靠扩展名而非 magic bytes
- write 工具错误被静默吞掉

**Gong 已覆盖：** edit 的弯引号规范化、read 的 magic bytes 检测。
**可补充：**
- [ ] FILE-ERR-001: NFD/NFC Unicode 路径规范化

---

## 11. 扩展/Hook（pi 修了 38+ 个 bug）

**Gong 现状：** Hook 系统有完整测试（崩溃容错、超时保护）。Extension 有基础测试。

**pi 踩过的坑：**
- 扩展加载错误被静默吞掉
- 多个扩展的 tool_result 补丁不链式应用
- 多文件扩展包发现失败
- 符号链接不被发现
- 扩展冲突无过滤

**建议补充场景：**
- [ ] EXT-ERR-001: 多扩展 hook 链式执行
- [ ] EXT-ERR-002: 符号链接扩展能被发现
- [ ] EXT-ERR-003: 扩展冲突时有明确错误提示

---

## 12. 配置/注册表（pi 修了 18 个 bug）

**Gong 现状：** 5 个模型注册表场景，缺配置合并边界。

**pi 踩过的坑：**
- 模型覆盖合并不健壮，缺失字段崩溃
- models.json 字段全必填，新增可选字段时全线崩溃
- 全局设置修改后不重新加载

**建议补充场景：**
- [ ] CONFIG-ERR-001: 模型覆盖部分字段缺失时用默认值
- [ ] CONFIG-ERR-002: 配置热重载
- [ ] CONFIG-ERR-003: 空数组配置的语义正确（空 = 阻止全部 vs 不过滤）

---

## 优先级排序

按影响面和 Gong 当前缺口排序：

| 优先级 | 领域 | Gong 缺口 | 建议场景数 |
|--------|------|-----------|-----------|
| P0 | 令牌/成本/窗口 | 429 误触压缩、窗口溢出 | 3 |
| P0 | 会话/存储 | fork 损坏、消息丢失 | 4 |
| P1 | 工具调用边界 | 空参数、孤儿 result | 4 |
| P1 | Bash 编码 | UTF-8 损坏、截断精度 | 3 |
| P1 | Thinking | 跨厂商格式、budget 约束 | 3 |
| P2 | 上下文切换 | thinking 泄露、错误消息过滤 | 3 |
| P2 | 流式解析 | 中途中断、增量 JSON 边界 | 3 |
| P2 | 认证 | 锁文件损坏、key 污染 | 3 |
| P2 | 配置/注册表 | 合并健壮性、热重载 | 3 |
| P3 | 厂商兼容性 | ReqLLM 挡了大部分，但需防御 | 3 |
| P3 | 扩展/Hook | 链式执行、符号链接 | 3 |
| P3 | 文件操作 | Unicode 路径 | 1 |

**总计建议新增：~36 个 BDD 场景**
