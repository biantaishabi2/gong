# Generated by bdd_compiler from /home/wangbo/document/gong/docs/bdd/e2e_llm.dsl. DO NOT EDIT.

defmodule Gong.BDD.Generated.E2eLlmTest do
  use ExUnit.Case, async: false

  @moduletag :bdd_generated

  # Source: BDD-E2E-001
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-001] DeepSeek 简单问答" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-001"}
    # line 10: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 10, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 10)
    # line 11: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 11, raw: "GIVEN create_temp_dir"}, 11)
    # line 12: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 12, raw: "GIVEN configure_agent"}, 12)
    # line 13: WHEN agent_chat prompt="1+1等于几？请只回答数字"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "1+1等于几？请只回答数字"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 13, raw: "WHEN agent_chat prompt=\"1+1等于几？请只回答数字\""}, 13)
    # line 14: THEN assert_agent_reply contains="2"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "2"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 14, raw: "THEN assert_agent_reply contains=\"2\""}, 14)
    # line 15: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 15, raw: "THEN assert_no_crash"}, 15)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-002
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-002] 数学推理" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-002"}
    # line 18: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 18, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 18)
    # line 19: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 19, raw: "GIVEN create_temp_dir"}, 19)
    # line 20: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 20, raw: "GIVEN configure_agent"}, 20)
    # line 21: WHEN agent_chat prompt="一个长方形长5cm宽3cm，面积是多少平方厘米？请只回答数字"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "一个长方形长5cm宽3cm，面积是多少平方厘米？请只回答数字"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 21, raw: "WHEN agent_chat prompt=\"一个长方形长5cm宽3cm，面积是多少平方厘米？请只回答数字\""}, 21)
    # line 22: THEN assert_agent_reply contains="15"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "15"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 22, raw: "THEN assert_agent_reply contains=\"15\""}, 22)
    # line 23: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 23, raw: "THEN assert_no_crash"}, 23)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-003
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-003] 中文理解" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-003"}
    # line 26: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 26, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 26)
    # line 27: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 27, raw: "GIVEN create_temp_dir"}, 27)
    # line 28: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 28, raw: "GIVEN configure_agent"}, 28)
    # line 29: WHEN agent_chat prompt="请用一个成语形容非常开心，只回答成语本身"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "请用一个成语形容非常开心，只回答成语本身"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 29, raw: "WHEN agent_chat prompt=\"请用一个成语形容非常开心，只回答成语本身\""}, 29)
    # line 30: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 30, raw: "THEN assert_no_crash"}, 30)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-004
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-004] LLM 自主选择读文件工具" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-004"}
    # line 37: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 37, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 37)
    # line 38: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 38, raw: "GIVEN create_temp_dir"}, 38)
    # line 39: GIVEN create_temp_file path="info.txt" content="Gong版本号是v0.42"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "Gong版本号是v0.42", path: "info.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 39, raw: "GIVEN create_temp_file path=\"info.txt\" content=\"Gong版本号是v0.42\""}, 39)
    # line 40: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 40, raw: "GIVEN configure_agent"}, 40)
    # line 41: WHEN agent_chat prompt="读取 info.txt 的内容，告诉我版本号"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读取 info.txt 的内容，告诉我版本号"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 41, raw: "WHEN agent_chat prompt=\"读取 info.txt 的内容，告诉我版本号\""}, 41)
    # line 42: THEN assert_tool_was_called tool="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_tool_was_called, %{tool: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 42, raw: "THEN assert_tool_was_called tool=\"read_file\""}, 42)
    # line 43: THEN assert_agent_reply contains="0.42"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "0.42"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 43, raw: "THEN assert_agent_reply contains=\"0.42\""}, 43)
    # line 44: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 44, raw: "THEN assert_no_crash"}, 44)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-005
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-005] LLM 自主选择写文件工具" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-005"}
    # line 47: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 47, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 47)
    # line 48: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 48, raw: "GIVEN create_temp_dir"}, 48)
    # line 49: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 49, raw: "GIVEN configure_agent"}, 49)
    # line 50: WHEN agent_chat prompt="在当前目录创建 greeting.txt，内容写 hello e2e test"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "在当前目录创建 greeting.txt，内容写 hello e2e test"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 50, raw: "WHEN agent_chat prompt=\"在当前目录创建 greeting.txt，内容写 hello e2e test\""}, 50)
    # line 51: THEN assert_tool_was_called tool="write_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_tool_was_called, %{tool: "write_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 51, raw: "THEN assert_tool_was_called tool=\"write_file\""}, 51)
    # line 52: THEN assert_file_exists path="greeting.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_file_exists, %{path: "greeting.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 52, raw: "THEN assert_file_exists path=\"greeting.txt\""}, 52)
    # line 53: THEN assert_file_content path="greeting.txt" expected="hello e2e test"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_file_content, %{expected: "hello e2e test", path: "greeting.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 53, raw: "THEN assert_file_content path=\"greeting.txt\" expected=\"hello e2e test\""}, 53)
    # line 54: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 54, raw: "THEN assert_no_crash"}, 54)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-006
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-006] LLM 链式调用多个工具" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-006"}
    # line 57: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 57, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 57)
    # line 58: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 58, raw: "GIVEN create_temp_dir"}, 58)
    # line 59: GIVEN create_temp_file path="source.txt" content="alpha beta gamma"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "alpha beta gamma", path: "source.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 59, raw: "GIVEN create_temp_file path=\"source.txt\" content=\"alpha beta gamma\""}, 59)
    # line 60: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 60, raw: "GIVEN configure_agent"}, 60)
    # line 61: WHEN agent_chat prompt="先读 source.txt，然后把 beta 替换成 BETA，最后读取修改后的文件确认结果"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "先读 source.txt，然后把 beta 替换成 BETA，最后读取修改后的文件确认结果"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 61, raw: "WHEN agent_chat prompt=\"先读 source.txt，然后把 beta 替换成 BETA，最后读取修改后的文件确认结果\""}, 61)
    # line 62: THEN assert_tool_was_called tool="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_tool_was_called, %{tool: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 62, raw: "THEN assert_tool_was_called tool=\"read_file\""}, 62)
    # line 63: THEN assert_file_content path="source.txt" expected="alpha BETA gamma"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_file_content, %{expected: "alpha BETA gamma", path: "source.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 63, raw: "THEN assert_file_content path=\"source.txt\" expected=\"alpha BETA gamma\""}, 63)
    # line 64: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 64, raw: "THEN assert_no_crash"}, 64)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-007
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-007] 两轮对话上下文保持" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-007"}
    # line 71: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 71, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 71)
    # line 72: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 72, raw: "GIVEN create_temp_dir"}, 72)
    # line 73: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 73, raw: "GIVEN configure_agent"}, 73)
    # line 74: WHEN agent_chat prompt="请记住这个数字：7749"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "请记住这个数字：7749"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 74, raw: "WHEN agent_chat prompt=\"请记住这个数字：7749\""}, 74)
    # line 75: WHEN agent_chat_continue prompt="我刚才让你记住的数字是什么？请只回答数字"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_continue, %{prompt: "我刚才让你记住的数字是什么？请只回答数字"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 75, raw: "WHEN agent_chat_continue prompt=\"我刚才让你记住的数字是什么？请只回答数字\""}, 75)
    # line 76: THEN assert_agent_reply contains="7749"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "7749"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 76, raw: "THEN assert_agent_reply contains=\"7749\""}, 76)
    # line 77: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 77, raw: "THEN assert_no_crash"}, 77)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-008
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-008] 三轮渐进任务" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-008"}
    # line 80: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 80, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 80)
    # line 81: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 81, raw: "GIVEN create_temp_dir"}, 81)
    # line 82: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 82, raw: "GIVEN configure_agent"}, 82)
    # line 83: WHEN agent_chat prompt="在当前目录创建 todo.txt，内容写 buy milk"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "在当前目录创建 todo.txt，内容写 buy milk"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 83, raw: "WHEN agent_chat prompt=\"在当前目录创建 todo.txt，内容写 buy milk\""}, 83)
    # line 84: THEN assert_file_exists path="todo.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_file_exists, %{path: "todo.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 84, raw: "THEN assert_file_exists path=\"todo.txt\""}, 84)
    # line 85: WHEN agent_chat_continue prompt="读一下 todo.txt 的内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_continue, %{prompt: "读一下 todo.txt 的内容"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 85, raw: "WHEN agent_chat_continue prompt=\"读一下 todo.txt 的内容\""}, 85)
    # line 86: THEN assert_agent_reply contains="buy milk"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "buy milk"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 86, raw: "THEN assert_agent_reply contains=\"buy milk\""}, 86)
    # line 87: WHEN agent_chat_continue prompt="把 todo.txt 里的 milk 改成 coffee"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_continue, %{prompt: "把 todo.txt 里的 milk 改成 coffee"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 87, raw: "WHEN agent_chat_continue prompt=\"把 todo.txt 里的 milk 改成 coffee\""}, 87)
    # line 88: THEN assert_file_content path="todo.txt" expected="buy coffee"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_file_content, %{expected: "buy coffee", path: "todo.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 88, raw: "THEN assert_file_content path=\"todo.txt\" expected=\"buy coffee\""}, 88)
    # line 89: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 89, raw: "THEN assert_no_crash"}, 89)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-009
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-009] LLM 工具调用失败后自行恢复" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-009"}
    # line 96: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 96, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 96)
    # line 97: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 97, raw: "GIVEN create_temp_dir"}, 97)
    # line 98: GIVEN create_temp_file path="real.txt" content="recovery success"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "recovery success", path: "real.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 98, raw: "GIVEN create_temp_file path=\"real.txt\" content=\"recovery success\""}, 98)
    # line 99: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 99, raw: "GIVEN configure_agent"}, 99)
    # line 100: WHEN agent_chat prompt="先尝试读取 nonexistent.txt，如果失败就读取 real.txt，告诉我最终读到的内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "先尝试读取 nonexistent.txt，如果失败就读取 real.txt，告诉我最终读到的内容"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 100, raw: "WHEN agent_chat prompt=\"先尝试读取 nonexistent.txt，如果失败就读取 real.txt，告诉我最终读到的内容\""}, 100)
    # line 101: THEN assert_agent_reply contains="recovery success"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "recovery success"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 101, raw: "THEN assert_agent_reply contains=\"recovery success\""}, 101)
    # line 102: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 102, raw: "THEN assert_no_crash"}, 102)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-010
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-010] 不存在文件的错误处理" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-010"}
    # line 105: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 105, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 105)
    # line 106: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 106, raw: "GIVEN create_temp_dir"}, 106)
    # line 107: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 107, raw: "GIVEN configure_agent"}, 107)
    # line 108: WHEN agent_chat prompt="读取 does_not_exist.txt 的内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读取 does_not_exist.txt 的内容"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 108, raw: "WHEN agent_chat prompt=\"读取 does_not_exist.txt 的内容\""}, 108)
    # line 109: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 109, raw: "THEN assert_no_crash"}, 109)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-011
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-011] 大文件读取" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-011"}
    # line 116: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 116, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 116)
    # line 117: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 117, raw: "GIVEN create_temp_dir"}, 117)
    # line 118: GIVEN create_large_file lines=500 path="big.txt" line_length=80
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_large_file, %{line_length: 80, lines: 500, path: "big.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 118, raw: "GIVEN create_large_file lines=500 path=\"big.txt\" line_length=80"}, 118)
    # line 119: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 119, raw: "GIVEN configure_agent"}, 119)
    # line 120: WHEN agent_chat prompt="读取 big.txt 的内容，告诉我大概有多少行"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读取 big.txt 的内容，告诉我大概有多少行"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 120, raw: "WHEN agent_chat prompt=\"读取 big.txt 的内容，告诉我大概有多少行\""}, 120)
    # line 121: THEN assert_tool_was_called tool="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_tool_was_called, %{tool: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 121, raw: "THEN assert_tool_was_called tool=\"read_file\""}, 121)
    # line 122: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 122, raw: "THEN assert_no_crash"}, 122)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-012
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-012] 长 prompt 处理" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-012"}
    # line 125: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 125, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 125)
    # line 126: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 126, raw: "GIVEN create_temp_dir"}, 126)
    # line 127: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 127, raw: "GIVEN configure_agent"}, 127)
    # line 128: WHEN agent_chat prompt="请分析以下需求并给出简短回答：我们需要构建一个分布式消息队列系统，支持发布订阅模式、消息持久化、消息确认机制、死信队列、延迟消息、消息优先级、消息路由、消息过滤、消息回溯、消息追踪。请只回答：收到，已了解需求。"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "请分析以下需求并给出简短回答：我们需要构建一个分布式消息队列系统，支持发布订阅模式、消息持久化、消息确认机制、死信队列、延迟消息、消息优先级、消息路由、消息过滤、消息回溯、消息追踪。请只回答：收到，已了解需求。"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 128, raw: "WHEN agent_chat prompt=\"请分析以下需求并给出简短回答：我们需要构建一个分布式消息队列系统，支持发布订阅模式、消息持久化、消息确认机制、死信队列、延迟消息、消息优先级、消息路由、消息过滤、消息回溯、消息追踪。请只回答：收到，已了解需求。\""}, 128)
    # line 129: THEN assert_agent_reply contains="收到"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "收到"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 129, raw: "THEN assert_agent_reply contains=\"收到\""}, 129)
    # line 130: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 130, raw: "THEN assert_no_crash"}, 130)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-013
  @tag :agent
  @tag :e2e
  test "[BDD-E2E-013] 多轮对话后检查 Compaction 可触发性" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-013"}
    # line 137: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 137, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 137)
    # line 138: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 138, raw: "GIVEN create_temp_dir"}, 138)
    # line 139: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 139, raw: "GIVEN configure_agent"}, 139)
    # line 140: WHEN agent_chat prompt="创建 a.txt 内容为 hello"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "创建 a.txt 内容为 hello"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 140, raw: "WHEN agent_chat prompt=\"创建 a.txt 内容为 hello\""}, 140)
    # line 141: WHEN agent_chat_continue prompt="创建 b.txt 内容为 world"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_continue, %{prompt: "创建 b.txt 内容为 world"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 141, raw: "WHEN agent_chat_continue prompt=\"创建 b.txt 内容为 world\""}, 141)
    # line 142: WHEN agent_chat_continue prompt="创建 c.txt 内容为 test"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_continue, %{prompt: "创建 c.txt 内容为 test"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 142, raw: "WHEN agent_chat_continue prompt=\"创建 c.txt 内容为 test\""}, 142)
    # line 143: THEN assert_file_exists path="a.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_file_exists, %{path: "a.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 143, raw: "THEN assert_file_exists path=\"a.txt\""}, 143)
    # line 144: THEN assert_file_exists path="b.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_file_exists, %{path: "b.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 144, raw: "THEN assert_file_exists path=\"b.txt\""}, 144)
    # line 145: THEN assert_file_exists path="c.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_file_exists, %{path: "c.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 145, raw: "THEN assert_file_exists path=\"c.txt\""}, 145)
    # line 146: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 146, raw: "THEN assert_no_crash"}, 146)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-014
  @tag :agent
  @tag :e2e
  @tag :hook
  test "[BDD-E2E-014] Hook 拦截 bash — BlockBash hook 阻止 bash 工具" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-014"}
    # line 153: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 153, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 153)
    # line 154: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 154, raw: "GIVEN create_temp_dir"}, 154)
    # line 155: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 155, raw: "GIVEN configure_agent"}, 155)
    # line 156: GIVEN register_hook module="BlockBash"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "BlockBash"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 156, raw: "GIVEN register_hook module=\"BlockBash\""}, 156)
    # line 157: WHEN agent_chat_live prompt="用 bash 执行 echo hello 并告诉我结果"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_live, %{prompt: "用 bash 执行 echo hello 并告诉我结果"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 157, raw: "WHEN agent_chat_live prompt=\"用 bash 执行 echo hello 并告诉我结果\""}, 157)
    # line 158: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 158, raw: "THEN assert_no_crash"}, 158)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-015
  @tag :agent
  @tag :e2e
  @tag :hook
  test "[BDD-E2E-015] Hook 脱敏 — RedactApiKey 替换工具结果中的密钥" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-015"}
    # line 161: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 161, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 161)
    # line 162: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 162, raw: "GIVEN create_temp_dir"}, 162)
    # line 163: GIVEN create_temp_file path="secret.txt" content="api_key=sk_test_AbCdEfGhIjKlMnOpQrStUvWxYz123456"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "api_key=sk_test_AbCdEfGhIjKlMnOpQrStUvWxYz123456", path: "secret.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 163, raw: "GIVEN create_temp_file path=\"secret.txt\" content=\"api_key=sk_test_AbCdEfGhIjKlMnOpQrStUvWxYz123456\""}, 163)
    # line 164: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 164, raw: "GIVEN configure_agent"}, 164)
    # line 165: GIVEN register_hook module="RedactApiKey"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "RedactApiKey"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 165, raw: "GIVEN register_hook module=\"RedactApiKey\""}, 165)
    # line 166: WHEN agent_chat_live prompt="读取 secret.txt 的内容，告诉我 api_key 的值"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_live, %{prompt: "读取 secret.txt 的内容，告诉我 api_key 的值"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 166, raw: "WHEN agent_chat_live prompt=\"读取 secret.txt 的内容，告诉我 api_key 的值\""}, 166)
    # line 167: THEN assert_agent_reply contains="REDACTED"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "REDACTED"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 167, raw: "THEN assert_agent_reply contains=\"REDACTED\""}, 167)
    # line 168: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 168, raw: "THEN assert_no_crash"}, 168)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-016
  @tag :agent
  @tag :e2e
  @tag :hook
  test "[BDD-E2E-016] Hook 崩溃不影响 — CrashHook 抛异常但循环继续" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-016"}
    # line 171: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 171, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 171)
    # line 172: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 172, raw: "GIVEN create_temp_dir"}, 172)
    # line 173: GIVEN create_temp_file path="safe.txt" content="hook crash test ok"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "hook crash test ok", path: "safe.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 173, raw: "GIVEN create_temp_file path=\"safe.txt\" content=\"hook crash test ok\""}, 173)
    # line 174: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 174, raw: "GIVEN configure_agent"}, 174)
    # line 175: GIVEN register_hook module="CrashHook"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "CrashHook"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 175, raw: "GIVEN register_hook module=\"CrashHook\""}, 175)
    # line 176: WHEN agent_chat_live prompt="读取 safe.txt 的内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_live, %{prompt: "读取 safe.txt 的内容"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 176, raw: "WHEN agent_chat_live prompt=\"读取 safe.txt 的内容\""}, 176)
    # line 177: THEN assert_agent_reply contains="hook crash test ok"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "hook crash test ok"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 177, raw: "THEN assert_agent_reply contains=\"hook crash test ok\""}, 177)
    # line 178: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 178, raw: "THEN assert_no_crash"}, 178)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-017
  @tag :agent
  @tag :e2e
  @tag :hook
  test "[BDD-E2E-017] on_context 注入 — InjectContext hook 注入安全策略" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-017"}
    # line 185: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 185, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 185)
    # line 186: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 186, raw: "GIVEN create_temp_dir"}, 186)
    # line 187: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 187, raw: "GIVEN configure_agent"}, 187)
    # line 188: GIVEN register_hook module="InjectContext"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "InjectContext"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 188, raw: "GIVEN register_hook module=\"InjectContext\""}, 188)
    # line 189: WHEN agent_chat_live prompt="你的系统消息里有什么安全相关的内容？"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_live, %{prompt: "你的系统消息里有什么安全相关的内容？"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 189, raw: "WHEN agent_chat_live prompt=\"你的系统消息里有什么安全相关的内容？\""}, 189)
    # line 190: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 190, raw: "THEN assert_no_crash"}, 190)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-018
  @tag :agent
  @tag :e2e
  @tag :hook
  test "[BDD-E2E-018]" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-018"}
    # line 193: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 193, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 193)
    # line 194: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 194, raw: "GIVEN create_temp_dir"}, 194)
    # line 195: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 195, raw: "GIVEN configure_agent"}, 195)
    # line 196: GIVEN register_hook module="TransformInput"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "TransformInput"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 196, raw: "GIVEN register_hook module=\"TransformInput\""}, 196)
    # line 197: WHEN agent_chat_live prompt="请回复收到"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_live, %{prompt: "请回复收到"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 197, raw: "WHEN agent_chat_live prompt=\"请回复收到\""}, 197)
    # line 198: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 198, raw: "THEN assert_no_crash"}, 198)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-019
  @tag :agent
  @tag :e2e
  @tag :hook
  test "[BDD-E2E-019] Hook 在多轮对话中持续生效" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-019"}
    # line 205: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 205, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 205)
    # line 206: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 206, raw: "GIVEN create_temp_dir"}, 206)
    # line 207: GIVEN create_temp_file path="key1.txt" content="secret=sk_live_RealKeyHere123456789012"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "secret=sk_live_RealKeyHere123456789012", path: "key1.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 207, raw: "GIVEN create_temp_file path=\"key1.txt\" content=\"secret=sk_live_RealKeyHere123456789012\""}, 207)
    # line 208: GIVEN create_temp_file path="key2.txt" content="token=sk_test_AnotherKey9876543210AB"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "token=sk_test_AnotherKey9876543210AB", path: "key2.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 208, raw: "GIVEN create_temp_file path=\"key2.txt\" content=\"token=sk_test_AnotherKey9876543210AB\""}, 208)
    # line 209: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 209, raw: "GIVEN configure_agent"}, 209)
    # line 210: GIVEN register_hook module="RedactApiKey"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "RedactApiKey"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 210, raw: "GIVEN register_hook module=\"RedactApiKey\""}, 210)
    # line 211: WHEN agent_chat_live prompt="读取 key1.txt 的内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_live, %{prompt: "读取 key1.txt 的内容"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 211, raw: "WHEN agent_chat_live prompt=\"读取 key1.txt 的内容\""}, 211)
    # line 212: THEN assert_agent_reply contains="REDACTED"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "REDACTED"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 212, raw: "THEN assert_agent_reply contains=\"REDACTED\""}, 212)
    # line 213: WHEN agent_chat_live prompt="读取 key2.txt 的内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_live, %{prompt: "读取 key2.txt 的内容"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 213, raw: "WHEN agent_chat_live prompt=\"读取 key2.txt 的内容\""}, 213)
    # line 214: THEN assert_agent_reply contains="REDACTED"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "REDACTED"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 214, raw: "THEN assert_agent_reply contains=\"REDACTED\""}, 214)
    # line 215: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 215, raw: "THEN assert_no_crash"}, 215)
    _ctx = ctx
    :ok
  end

  # Source: BDD-E2E-020
  @tag :agent
  @tag :e2e
  @tag :telemetry
  test "[BDD-E2E-020] 真实调用下 telemetry 事件序列正确" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-E2E-020"}
    # line 222: GIVEN check_e2e_provider provider="deepseek"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :check_e2e_provider, %{provider: "deepseek"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 222, raw: "GIVEN check_e2e_provider provider=\"deepseek\""}, 222)
    # line 223: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 223, raw: "GIVEN create_temp_dir"}, 223)
    # line 224: GIVEN create_temp_file path="tel.txt" content="telemetry test"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "telemetry test", path: "tel.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 224, raw: "GIVEN create_temp_file path=\"tel.txt\" content=\"telemetry test\""}, 224)
    # line 225: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 225, raw: "GIVEN configure_agent"}, 225)
    # line 226: GIVEN attach_telemetry_handler event="gong.agent.start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.agent.start"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 226, raw: "GIVEN attach_telemetry_handler event=\"gong.agent.start\""}, 226)
    # line 227: GIVEN attach_telemetry_handler event="gong.tool.start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.tool.start"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 227, raw: "GIVEN attach_telemetry_handler event=\"gong.tool.start\""}, 227)
    # line 228: GIVEN attach_telemetry_handler event="gong.tool.stop"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.tool.stop"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 228, raw: "GIVEN attach_telemetry_handler event=\"gong.tool.stop\""}, 228)
    # line 229: GIVEN attach_telemetry_handler event="gong.agent.end"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.agent.end"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 229, raw: "GIVEN attach_telemetry_handler event=\"gong.agent.end\""}, 229)
    # line 230: WHEN agent_chat_live prompt="读取 tel.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat_live, %{prompt: "读取 tel.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 230, raw: "WHEN agent_chat_live prompt=\"读取 tel.txt\""}, 230)
    # line 231: THEN assert_telemetry_received event="gong.agent.start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.agent.start"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 231, raw: "THEN assert_telemetry_received event=\"gong.agent.start\""}, 231)
    # line 232: THEN assert_telemetry_received event="gong.tool.start" metadata_contains="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.tool.start", metadata_contains: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 232, raw: "THEN assert_telemetry_received event=\"gong.tool.start\" metadata_contains=\"read_file\""}, 232)
    # line 233: THEN assert_telemetry_received event="gong.tool.stop" metadata_contains="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.tool.stop", metadata_contains: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 233, raw: "THEN assert_telemetry_received event=\"gong.tool.stop\" metadata_contains=\"read_file\""}, 233)
    # line 234: THEN assert_telemetry_received event="gong.agent.end"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.agent.end"}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 234, raw: "THEN assert_telemetry_received event=\"gong.agent.end\""}, 234)
    # line 235: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/e2e_llm.dsl", line: 235, raw: "THEN assert_no_crash"}, 235)
    _ctx = ctx
    :ok
  end

end
