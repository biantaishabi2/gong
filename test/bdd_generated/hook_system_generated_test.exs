# Generated by bdd_compiler from /home/wangbo/document/gong/docs/bdd/hook_system.dsl. DO NOT EDIT.

defmodule Gong.BDD.Generated.HookSystemTest do
  use ExUnit.Case, async: false

  @moduletag :bdd_generated

  # Source: BDD-HOOK-001
  @tag :hook
  @tag :telemetry
  test "[BDD-HOOK-001] 工具执行发 telemetry" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-001"}
    # line 10: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 10, raw: "GIVEN create_temp_dir"}, 10)
    # line 11: GIVEN create_temp_file path="hello.txt" content="Hello"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "Hello", path: "hello.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 11, raw: "GIVEN create_temp_file path=\"hello.txt\" content=\"Hello\""}, 11)
    # line 12: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 12, raw: "GIVEN configure_agent"}, 12)
    # line 13: GIVEN attach_telemetry_handler event="gong.tool.start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.tool.start"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 13, raw: "GIVEN attach_telemetry_handler event=\"gong.tool.start\""}, 13)
    # line 14: GIVEN attach_telemetry_handler event="gong.tool.stop"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.tool.stop"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 14, raw: "GIVEN attach_telemetry_handler event=\"gong.tool.stop\""}, 14)
    # line 15: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/hello.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/hello.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 15, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/hello.txt\""}, 15)
    # line 16: GIVEN mock_llm_response response_type="text" content="读完了"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "读完了", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 16, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"读完了\""}, 16)
    # line 17: WHEN agent_chat prompt="读文件"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读文件"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 17, raw: "WHEN agent_chat prompt=\"读文件\""}, 17)
    # line 18: THEN assert_telemetry_received event="gong.tool.start" metadata_contains="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.tool.start", metadata_contains: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 18, raw: "THEN assert_telemetry_received event=\"gong.tool.start\" metadata_contains=\"read_file\""}, 18)
    # line 19: THEN assert_telemetry_received event="gong.tool.stop" metadata_contains="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.tool.stop", metadata_contains: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 19, raw: "THEN assert_telemetry_received event=\"gong.tool.stop\" metadata_contains=\"read_file\""}, 19)
    # line 20: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 20, raw: "THEN assert_no_crash"}, 20)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-002
  @tag :hook
  @tag :telemetry
  test "[BDD-HOOK-002] Agent 循环生命周期 telemetry" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-002"}
    # line 23: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 23, raw: "GIVEN create_temp_dir"}, 23)
    # line 24: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 24, raw: "GIVEN configure_agent"}, 24)
    # line 25: GIVEN attach_telemetry_handler event="gong.agent.start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.agent.start"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 25, raw: "GIVEN attach_telemetry_handler event=\"gong.agent.start\""}, 25)
    # line 26: GIVEN attach_telemetry_handler event="gong.agent.end"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.agent.end"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 26, raw: "GIVEN attach_telemetry_handler event=\"gong.agent.end\""}, 26)
    # line 27: GIVEN mock_llm_response response_type="text" content="你好"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "你好", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 27, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"你好\""}, 27)
    # line 28: WHEN agent_chat prompt="你好"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "你好"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 28, raw: "WHEN agent_chat prompt=\"你好\""}, 28)
    # line 29: THEN assert_telemetry_received event="gong.agent.start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.agent.start"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 29, raw: "THEN assert_telemetry_received event=\"gong.agent.start\""}, 29)
    # line 30: THEN assert_telemetry_received event="gong.agent.end"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.agent.end"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 30, raw: "THEN assert_telemetry_received event=\"gong.agent.end\""}, 30)
    # line 31: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 31, raw: "THEN assert_no_crash"}, 31)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-003
  @tag :hook
  @tag :telemetry
  test "[BDD-HOOK-003] turn 事件含 tool_calls" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-003"}
    # line 34: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 34, raw: "GIVEN create_temp_dir"}, 34)
    # line 35: GIVEN create_temp_file path="data.txt" content="数据"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "数据", path: "data.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 35, raw: "GIVEN create_temp_file path=\"data.txt\" content=\"数据\""}, 35)
    # line 36: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 36, raw: "GIVEN configure_agent"}, 36)
    # line 37: GIVEN attach_telemetry_handler event="gong.turn.end"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.turn.end"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 37, raw: "GIVEN attach_telemetry_handler event=\"gong.turn.end\""}, 37)
    # line 38: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/data.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/data.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 38, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/data.txt\""}, 38)
    # line 39: GIVEN mock_llm_response response_type="text" content="完成"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "完成", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 39, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"完成\""}, 39)
    # line 40: WHEN agent_chat prompt="读一下"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读一下"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 40, raw: "WHEN agent_chat prompt=\"读一下\""}, 40)
    # line 41: THEN assert_telemetry_received event="gong.turn.end" metadata_contains="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.turn.end", metadata_contains: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 41, raw: "THEN assert_telemetry_received event=\"gong.turn.end\" metadata_contains=\"read_file\""}, 41)
    # line 42: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 42, raw: "THEN assert_no_crash"}, 42)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-004
  @tag :gate
  @tag :hook
  test "[BDD-HOOK-004] before_tool_call 放行" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-004"}
    # line 49: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 49, raw: "GIVEN create_temp_dir"}, 49)
    # line 50: GIVEN create_temp_file path="test.txt" content="内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "内容", path: "test.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 50, raw: "GIVEN create_temp_file path=\"test.txt\" content=\"内容\""}, 50)
    # line 51: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 51, raw: "GIVEN configure_agent"}, 51)
    # line 52: GIVEN register_hook module="AllowAll"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "AllowAll"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 52, raw: "GIVEN register_hook module=\"AllowAll\""}, 52)
    # line 53: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/test.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/test.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 53, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/test.txt\""}, 53)
    # line 54: GIVEN mock_llm_response response_type="text" content="读到了内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "读到了内容", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 54, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"读到了内容\""}, 54)
    # line 55: WHEN agent_chat prompt="读文件"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读文件"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 55, raw: "WHEN agent_chat prompt=\"读文件\""}, 55)
    # line 56: THEN assert_agent_reply contains="读到了内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "读到了内容"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 56, raw: "THEN assert_agent_reply contains=\"读到了内容\""}, 56)
    # line 57: THEN assert_tool_was_called tool="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_tool_was_called, %{tool: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 57, raw: "THEN assert_tool_was_called tool=\"read_file\""}, 57)
    # line 58: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 58, raw: "THEN assert_no_crash"}, 58)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-005
  @tag :gate
  @tag :hook
  test "[BDD-HOOK-005] before_tool_call 阻止" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-005"}
    # line 61: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 61, raw: "GIVEN create_temp_dir"}, 61)
    # line 62: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 62, raw: "GIVEN configure_agent"}, 62)
    # line 63: GIVEN register_hook module="BlockBash"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "BlockBash"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 63, raw: "GIVEN register_hook module=\"BlockBash\""}, 63)
    # line 64: GIVEN mock_llm_response response_type="tool_call" tool="bash" tool_args="command=echo hacked"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "bash", tool_args: "command=echo hacked"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 64, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"bash\" tool_args=\"command=echo hacked\""}, 64)
    # line 65: GIVEN mock_llm_response response_type="text" content="被阻止了"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "被阻止了", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 65, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"被阻止了\""}, 65)
    # line 66: WHEN agent_chat prompt="执行命令"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "执行命令"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 66, raw: "WHEN agent_chat prompt=\"执行命令\""}, 66)
    # line 67: THEN assert_agent_reply contains="被阻止了"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "被阻止了"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 67, raw: "THEN assert_agent_reply contains=\"被阻止了\""}, 67)
    # line 68: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 68, raw: "THEN assert_no_crash"}, 68)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-006
  @tag :gate
  @tag :hook
  test "[BDD-HOOK-006] 多 hook 拦截链" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-006"}
    # line 71: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 71, raw: "GIVEN create_temp_dir"}, 71)
    # line 72: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 72, raw: "GIVEN configure_agent"}, 72)
    # line 73: GIVEN register_hook module="AllowAll"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "AllowAll"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 73, raw: "GIVEN register_hook module=\"AllowAll\""}, 73)
    # line 74: GIVEN register_hook module="BlockBash"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "BlockBash"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 74, raw: "GIVEN register_hook module=\"BlockBash\""}, 74)
    # line 75: GIVEN mock_llm_response response_type="tool_call" tool="bash" tool_args="command=echo test"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "bash", tool_args: "command=echo test"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 75, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"bash\" tool_args=\"command=echo test\""}, 75)
    # line 76: GIVEN mock_llm_response response_type="text" content="链式拦截"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "链式拦截", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 76, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"链式拦截\""}, 76)
    # line 77: WHEN agent_chat prompt="执行"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "执行"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 77, raw: "WHEN agent_chat prompt=\"执行\""}, 77)
    # line 78: THEN assert_agent_reply contains="链式拦截"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "链式拦截"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 78, raw: "THEN assert_agent_reply contains=\"链式拦截\""}, 78)
    # line 79: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 79, raw: "THEN assert_no_crash"}, 79)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-007
  @tag :gate
  @tag :hook
  test "[BDD-HOOK-007] before_session_op 取消 compaction" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-007"}
    # line 82: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 82, raw: "GIVEN create_temp_dir"}, 82)
    # line 83: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 83, raw: "GIVEN configure_agent"}, 83)
    # line 84: GIVEN register_hook module="CancelCompact"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "CancelCompact"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 84, raw: "GIVEN register_hook module=\"CancelCompact\""}, 84)
    # line 85: WHEN trigger_compaction
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :trigger_compaction, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 85, raw: "WHEN trigger_compaction"}, 85)
    # line 86: THEN assert_hook_blocked reason_contains="Blocked by hook"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_hook_blocked, %{reason_contains: "Blocked by hook"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 86, raw: "THEN assert_hook_blocked reason_contains=\"Blocked by hook\""}, 86)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-008
  @tag :hook
  @tag :transform
  test "[BDD-HOOK-008] on_tool_result 脱敏" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-008"}
    # line 93: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 93, raw: "GIVEN create_temp_dir"}, 93)
    # line 94: GIVEN create_temp_file path="secret.txt" content="api_key=sk_test_AbCdEfGhIjKlMnOpQrStUvWxYz123456"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "api_key=sk_test_AbCdEfGhIjKlMnOpQrStUvWxYz123456", path: "secret.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 94, raw: "GIVEN create_temp_file path=\"secret.txt\" content=\"api_key=sk_test_AbCdEfGhIjKlMnOpQrStUvWxYz123456\""}, 94)
    # line 95: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 95, raw: "GIVEN configure_agent"}, 95)
    # line 96: GIVEN register_hook module="RedactApiKey"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "RedactApiKey"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 96, raw: "GIVEN register_hook module=\"RedactApiKey\""}, 96)
    # line 97: GIVEN attach_telemetry_handler event="gong.tool.stop"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.tool.stop"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 97, raw: "GIVEN attach_telemetry_handler event=\"gong.tool.stop\""}, 97)
    # line 98: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/secret.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/secret.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 98, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/secret.txt\""}, 98)
    # line 99: GIVEN mock_llm_response response_type="text" content="已脱敏"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "已脱敏", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 99, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"已脱敏\""}, 99)
    # line 100: WHEN agent_chat prompt="读取密钥文件"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读取密钥文件"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 100, raw: "WHEN agent_chat prompt=\"读取密钥文件\""}, 100)
    # line 101: THEN assert_agent_reply contains="已脱敏"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "已脱敏"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 101, raw: "THEN assert_agent_reply contains=\"已脱敏\""}, 101)
    # line 102: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 102, raw: "THEN assert_no_crash"}, 102)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-009
  @tag :hook
  @tag :transform
  test "[BDD-HOOK-009] on_tool_result 多 hook 串联" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-009"}
    # line 105: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 105, raw: "GIVEN create_temp_dir"}, 105)
    # line 106: GIVEN create_temp_file path="base.txt" content="base"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "base", path: "base.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 106, raw: "GIVEN create_temp_file path=\"base.txt\" content=\"base\""}, 106)
    # line 107: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 107, raw: "GIVEN configure_agent"}, 107)
    # line 108: GIVEN configure_hooks hooks="Gong.TestHooks.PartialModify"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_hooks, %{hooks: "Gong.TestHooks.PartialModify"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 108, raw: "GIVEN configure_hooks hooks=\"Gong.TestHooks.PartialModify\""}, 108)
    # line 109: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/base.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/base.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 109, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/base.txt\""}, 109)
    # line 110: GIVEN mock_llm_response response_type="text" content="串联完成"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "串联完成", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 110, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"串联完成\""}, 110)
    # line 111: WHEN agent_chat prompt="读取"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读取"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 111, raw: "WHEN agent_chat prompt=\"读取\""}, 111)
    # line 112: THEN assert_agent_reply contains="串联完成"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "串联完成"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 112, raw: "THEN assert_agent_reply contains=\"串联完成\""}, 112)
    # line 113: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 113, raw: "THEN assert_no_crash"}, 113)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-010
  @tag :hook
  @tag :transform
  test "[BDD-HOOK-010] on_tool_result 部分修改" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-010"}
    # line 116: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 116, raw: "GIVEN create_temp_dir"}, 116)
    # line 117: GIVEN create_temp_file path="info.txt" content="some info"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "some info", path: "info.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 117, raw: "GIVEN create_temp_file path=\"info.txt\" content=\"some info\""}, 117)
    # line 118: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 118, raw: "GIVEN configure_agent"}, 118)
    # line 119: GIVEN register_hook module="PartialModify"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "PartialModify"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 119, raw: "GIVEN register_hook module=\"PartialModify\""}, 119)
    # line 120: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/info.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/info.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 120, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/info.txt\""}, 120)
    # line 121: GIVEN mock_llm_response response_type="text" content="部分修改完成"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "部分修改完成", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 121, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"部分修改完成\""}, 121)
    # line 122: WHEN agent_chat prompt="读取信息"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读取信息"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 122, raw: "WHEN agent_chat prompt=\"读取信息\""}, 122)
    # line 123: THEN assert_agent_reply contains="部分修改完成"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "部分修改完成"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 123, raw: "THEN assert_agent_reply contains=\"部分修改完成\""}, 123)
    # line 124: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 124, raw: "THEN assert_no_crash"}, 124)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-011
  @tag :hook
  @tag :transform
  test "[BDD-HOOK-011] on_context 注入系统消息" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-011"}
    # line 127: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 127, raw: "GIVEN create_temp_dir"}, 127)
    # line 128: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 128, raw: "GIVEN configure_agent"}, 128)
    # line 129: GIVEN register_hook module="InjectContext"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "InjectContext"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 129, raw: "GIVEN register_hook module=\"InjectContext\""}, 129)
    # line 130: GIVEN attach_telemetry_handler event="gong.hook.on_context.applied"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.hook.on_context.applied"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 130, raw: "GIVEN attach_telemetry_handler event=\"gong.hook.on_context.applied\""}, 130)
    # line 131: GIVEN mock_llm_response response_type="text" content="上下文已注入"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "上下文已注入", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 131, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"上下文已注入\""}, 131)
    # line 132: WHEN agent_chat prompt="测试上下文"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "测试上下文"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 132, raw: "WHEN agent_chat prompt=\"测试上下文\""}, 132)
    # line 133: THEN assert_agent_reply contains="上下文已注入"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "上下文已注入"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 133, raw: "THEN assert_agent_reply contains=\"上下文已注入\""}, 133)
    # line 134: THEN assert_telemetry_received event="gong.hook.on_context.applied"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.hook.on_context.applied"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 134, raw: "THEN assert_telemetry_received event=\"gong.hook.on_context.applied\""}, 134)
    # line 135: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 135, raw: "THEN assert_no_crash"}, 135)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-012
  @tag :hook
  @tag :transform
  test "[BDD-HOOK-012] on_input 变换输入" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-012"}
    # line 138: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 138, raw: "GIVEN create_temp_dir"}, 138)
    # line 139: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 139, raw: "GIVEN configure_agent"}, 139)
    # line 140: GIVEN register_hook module="TransformInput"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "TransformInput"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 140, raw: "GIVEN register_hook module=\"TransformInput\""}, 140)
    # line 141: GIVEN mock_llm_response response_type="text" content="输入已变换"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "输入已变换", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 141, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"输入已变换\""}, 141)
    # line 142: WHEN agent_chat prompt="原始输入"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "原始输入"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 142, raw: "WHEN agent_chat prompt=\"原始输入\""}, 142)
    # line 143: THEN assert_agent_reply contains="输入已变换"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "输入已变换"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 143, raw: "THEN assert_agent_reply contains=\"输入已变换\""}, 143)
    # line 144: THEN assert_conversation_contains text="[filtered]"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_conversation_contains, %{text: "[filtered]"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 144, raw: "THEN assert_conversation_contains text=\"[filtered]\""}, 144)
    # line 145: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 145, raw: "THEN assert_no_crash"}, 145)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-013
  @tag :hook
  @tag :transform
  test "[BDD-HOOK-013] on_input 短路" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-013"}
    # line 148: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 148, raw: "GIVEN create_temp_dir"}, 148)
    # line 149: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 149, raw: "GIVEN configure_agent"}, 149)
    # line 150: GIVEN register_hook module="HandleInput"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "HandleInput"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 150, raw: "GIVEN register_hook module=\"HandleInput\""}, 150)
    # line 151: GIVEN mock_llm_response response_type="text" content="不应到达"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "不应到达", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 151, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"不应到达\""}, 151)
    # line 152: WHEN agent_chat prompt="被拦截的输入"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "被拦截的输入"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 152, raw: "WHEN agent_chat prompt=\"被拦截的输入\""}, 152)
    # line 153: THEN assert_result_content_not_contains text="不应到达"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_result_content_not_contains, %{text: "不应到达"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 153, raw: "THEN assert_result_content_not_contains text=\"不应到达\""}, 153)
    # line 154: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 154, raw: "THEN assert_no_crash"}, 154)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-014
  @tag :hook
  @tag :transform
  test "[BDD-HOOK-014] on_before_agent 注入消息" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-014"}
    # line 157: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 157, raw: "GIVEN create_temp_dir"}, 157)
    # line 158: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 158, raw: "GIVEN configure_agent"}, 158)
    # line 159: GIVEN register_hook module="InjectBeforeAgent"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "InjectBeforeAgent"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 159, raw: "GIVEN register_hook module=\"InjectBeforeAgent\""}, 159)
    # line 160: GIVEN attach_telemetry_handler event="gong.hook.on_before_agent.applied"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.hook.on_before_agent.applied"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 160, raw: "GIVEN attach_telemetry_handler event=\"gong.hook.on_before_agent.applied\""}, 160)
    # line 161: GIVEN mock_llm_response response_type="text" content="注入完成"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "注入完成", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 161, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"注入完成\""}, 161)
    # line 162: WHEN agent_chat prompt="测试注入"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "测试注入"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 162, raw: "WHEN agent_chat prompt=\"测试注入\""}, 162)
    # line 163: THEN assert_agent_reply contains="注入完成"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "注入完成"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 163, raw: "THEN assert_agent_reply contains=\"注入完成\""}, 163)
    # line 164: THEN assert_telemetry_received event="gong.hook.on_before_agent.applied"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_telemetry_received, %{event: "gong.hook.on_before_agent.applied"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 164, raw: "THEN assert_telemetry_received event=\"gong.hook.on_before_agent.applied\""}, 164)
    # line 165: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 165, raw: "THEN assert_no_crash"}, 165)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-015
  @tag :error
  @tag :hook
  test "[BDD-HOOK-015] hook 异常不影响后续执行" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-015"}
    # line 172: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 172, raw: "GIVEN create_temp_dir"}, 172)
    # line 173: GIVEN create_temp_file path="safe.txt" content="安全内容"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "安全内容", path: "safe.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 173, raw: "GIVEN create_temp_file path=\"safe.txt\" content=\"安全内容\""}, 173)
    # line 174: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 174, raw: "GIVEN configure_agent"}, 174)
    # line 175: GIVEN register_hook module="CrashHook"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "CrashHook"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 175, raw: "GIVEN register_hook module=\"CrashHook\""}, 175)
    # line 176: GIVEN attach_telemetry_handler event="gong.hook.error"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.hook.error"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 176, raw: "GIVEN attach_telemetry_handler event=\"gong.hook.error\""}, 176)
    # line 177: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/safe.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/safe.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 177, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/safe.txt\""}, 177)
    # line 178: GIVEN mock_llm_response response_type="text" content="继续执行"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "继续执行", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 178, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"继续执行\""}, 178)
    # line 179: WHEN agent_chat prompt="读取安全文件"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读取安全文件"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 179, raw: "WHEN agent_chat prompt=\"读取安全文件\""}, 179)
    # line 180: THEN assert_agent_reply contains="继续执行"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "继续执行"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 180, raw: "THEN assert_agent_reply contains=\"继续执行\""}, 180)
    # line 181: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 181, raw: "THEN assert_no_crash"}, 181)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-016
  @tag :error
  @tag :hook
  test "[BDD-HOOK-016] hook 异常有堆栈" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-016"}
    # line 184: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 184, raw: "GIVEN create_temp_dir"}, 184)
    # line 185: GIVEN create_temp_file path="crash.txt" content="崩溃测试"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "崩溃测试", path: "crash.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 185, raw: "GIVEN create_temp_file path=\"crash.txt\" content=\"崩溃测试\""}, 185)
    # line 186: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 186, raw: "GIVEN configure_agent"}, 186)
    # line 187: GIVEN register_hook module="CrashHook"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "CrashHook"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 187, raw: "GIVEN register_hook module=\"CrashHook\""}, 187)
    # line 188: GIVEN attach_telemetry_handler event="gong.hook.error"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.hook.error"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 188, raw: "GIVEN attach_telemetry_handler event=\"gong.hook.error\""}, 188)
    # line 189: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/crash.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/crash.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 189, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/crash.txt\""}, 189)
    # line 190: GIVEN mock_llm_response response_type="text" content="有堆栈"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "有堆栈", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 190, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"有堆栈\""}, 190)
    # line 191: WHEN agent_chat prompt="读取"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读取"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 191, raw: "WHEN agent_chat prompt=\"读取\""}, 191)
    # line 192: THEN assert_hook_error_logged hook="CrashHook" has_stacktrace=true
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_hook_error_logged, %{has_stacktrace: true, hook: "CrashHook"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 192, raw: "THEN assert_hook_error_logged hook=\"CrashHook\" has_stacktrace=true"}, 192)
    # line 193: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 193, raw: "THEN assert_no_crash"}, 193)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-017
  @tag :error
  @tag :hook
  test "[BDD-HOOK-017] hook 超时不阻塞" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-017"}
    # line 196: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 196, raw: "GIVEN create_temp_dir"}, 196)
    # line 197: GIVEN create_temp_file path="slow.txt" content="慢操作"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "慢操作", path: "slow.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 197, raw: "GIVEN create_temp_file path=\"slow.txt\" content=\"慢操作\""}, 197)
    # line 198: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 198, raw: "GIVEN configure_agent"}, 198)
    # line 199: GIVEN register_hook module="SlowHook"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "SlowHook"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 199, raw: "GIVEN register_hook module=\"SlowHook\""}, 199)
    # line 200: GIVEN attach_telemetry_handler event="gong.hook.error"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.hook.error"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 200, raw: "GIVEN attach_telemetry_handler event=\"gong.hook.error\""}, 200)
    # line 201: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/slow.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/slow.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 201, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/slow.txt\""}, 201)
    # line 202: GIVEN mock_llm_response response_type="text" content="超时后继续"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "超时后继续", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 202, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"超时后继续\""}, 202)
    # line 203: WHEN agent_chat prompt="读取慢文件"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "读取慢文件"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 203, raw: "WHEN agent_chat prompt=\"读取慢文件\""}, 203)
    # line 204: THEN assert_agent_reply contains="超时后继续"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "超时后继续"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 204, raw: "THEN assert_agent_reply contains=\"超时后继续\""}, 204)
    # line 205: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 205, raw: "THEN assert_no_crash"}, 205)
    _ctx = ctx
    :ok
  end

  # Source: BDD-HOOK-018
  @tag :hook
  @tag :register
  test "[BDD-HOOK-018] hook 注册后回调被调用" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-HOOK-018"}
    # line 212: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 212, raw: "GIVEN create_temp_dir"}, 212)
    # line 213: GIVEN create_temp_file path="reg.txt" content="注册测试"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_file, %{content: "注册测试", path: "reg.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 213, raw: "GIVEN create_temp_file path=\"reg.txt\" content=\"注册测试\""}, 213)
    # line 214: GIVEN configure_agent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :configure_agent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 214, raw: "GIVEN configure_agent"}, 214)
    # line 215: GIVEN register_hook module="AllowAll"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :register_hook, %{module: "AllowAll"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 215, raw: "GIVEN register_hook module=\"AllowAll\""}, 215)
    # line 216: GIVEN attach_telemetry_handler event="gong.tool.start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :attach_telemetry_handler, %{event: "gong.tool.start"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 216, raw: "GIVEN attach_telemetry_handler event=\"gong.tool.start\""}, 216)
    # line 217: GIVEN mock_llm_response response_type="tool_call" tool="read_file" tool_args="file_path={{workspace}}/reg.txt"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{response_type: "tool_call", tool: "read_file", tool_args: "file_path={{workspace}}/reg.txt"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 217, raw: "GIVEN mock_llm_response response_type=\"tool_call\" tool=\"read_file\" tool_args=\"file_path={{workspace}}/reg.txt\""}, 217)
    # line 218: GIVEN mock_llm_response response_type="text" content="回调已触发"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :mock_llm_response, %{content: "回调已触发", response_type: "text"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 218, raw: "GIVEN mock_llm_response response_type=\"text\" content=\"回调已触发\""}, 218)
    # line 219: WHEN agent_chat prompt="测试注册"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :agent_chat, %{prompt: "测试注册"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 219, raw: "WHEN agent_chat prompt=\"测试注册\""}, 219)
    # line 220: THEN assert_hook_fired event="gong.tool.start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_hook_fired, %{event: "gong.tool.start"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 220, raw: "THEN assert_hook_fired event=\"gong.tool.start\""}, 220)
    # line 221: THEN assert_agent_reply contains="回调已触发"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_agent_reply, %{contains: "回调已触发"}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 221, raw: "THEN assert_agent_reply contains=\"回调已触发\""}, 221)
    # line 222: THEN assert_no_crash
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_no_crash, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/hook_system.dsl", line: 222, raw: "THEN assert_no_crash"}, 222)
    _ctx = ctx
    :ok
  end

end
