# Generated by bdd_compiler from /home/wangbo/document/gong/docs/bdd/tape_storage.dsl. DO NOT EDIT.

defmodule Gong.BDD.Generated.TapeStorageTest do
  use ExUnit.Case, async: false

  @moduletag :bdd_generated

  # Source: BDD-TAPE-001
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-001] å·¥ä½œåŒºåˆå§‹åŒ–" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-001"}
    # line 9: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 9, raw: "GIVEN create_temp_dir"}, 9)
    # line 10: WHEN when_tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 10, raw: "WHEN when_tape_init"}, 10)
    # line 11: THEN assert_dir_exists path="anchors/001_session-start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_dir_exists, %{path: "anchors/001_session-start"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 11, raw: "THEN assert_dir_exists path=\"anchors/001_session-start\""}, 11)
    # line 12: THEN assert_db_exists
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_db_exists, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 12, raw: "THEN assert_db_exists"}, 12)
    # line 13: THEN assert_anchor_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_anchor_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 13, raw: "THEN assert_anchor_count expected=1"}, 13)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-002
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-002] é‡å¤åˆå§‹åŒ–å¹‚ç­‰" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-002"}
    # line 16: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 16, raw: "GIVEN create_temp_dir"}, 16)
    # line 17: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 17, raw: "GIVEN tape_init"}, 17)
    # line 18: WHEN when_tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 18, raw: "WHEN when_tape_init"}, 18)
    # line 19: THEN assert_anchor_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_anchor_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 19, raw: "THEN assert_anchor_count expected=1"}, 19)
    # line 20: THEN assert_db_exists
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_db_exists, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 20, raw: "THEN assert_db_exists"}, 20)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-003
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-003] è¿½åŠ æ¶ˆæ¯æ¡ç›®" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-003"}
    # line 27: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 27, raw: "GIVEN create_temp_dir"}, 27)
    # line 28: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 28, raw: "GIVEN tape_init"}, 28)
    # line 29: WHEN when_tape_append kind="message" content="hello world"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_append, %{content: "hello world", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 29, raw: "WHEN when_tape_append kind=\"message\" content=\"hello world\""}, 29)
    # line 30: THEN assert_jsonl_contains path="anchors/001_session-start/messages.jsonl" text="hello world"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/messages.jsonl", text: "hello world"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 30, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/messages.jsonl\" text=\"hello world\""}, 30)
    # line 31: THEN assert_entry_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 31, raw: "THEN assert_entry_count expected=1"}, 31)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-004
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-004] è¿½åŠ å·¥å…·è°ƒç”¨æ¡ç›®" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-004"}
    # line 34: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 34, raw: "GIVEN create_temp_dir"}, 34)
    # line 35: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 35, raw: "GIVEN tape_init"}, 35)
    # line 36: WHEN when_tape_append kind="tool_call" content="read_file /tmp/test"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_append, %{content: "read_file /tmp/test", kind: "tool_call"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 36, raw: "WHEN when_tape_append kind=\"tool_call\" content=\"read_file /tmp/test\""}, 36)
    # line 37: THEN assert_jsonl_contains path="anchors/001_session-start/tool_calls.jsonl" text="read_file"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/tool_calls.jsonl", text: "read_file"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 37, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/tool_calls.jsonl\" text=\"read_file\""}, 37)
    # line 38: THEN assert_entry_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 38, raw: "THEN assert_entry_count expected=1"}, 38)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-005
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-005] åŒå†™ä¸€è‡´æ€§ â€” DB å¯ä»æ–‡ä»¶é‡å»º" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-005"}
    # line 41: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 41, raw: "GIVEN create_temp_dir"}, 41)
    # line 42: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 42, raw: "GIVEN tape_init"}, 42)
    # line 43: GIVEN tape_append kind="message" content="msg1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "msg1", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 43, raw: "GIVEN tape_append kind=\"message\" content=\"msg1\""}, 43)
    # line 44: GIVEN tape_append kind="message" content="msg2"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "msg2", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 44, raw: "GIVEN tape_append kind=\"message\" content=\"msg2\""}, 44)
    # line 45: GIVEN tape_append kind="message" content="msg3"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "msg3", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 45, raw: "GIVEN tape_append kind=\"message\" content=\"msg3\""}, 45)
    # line 46: GIVEN delete_file path="index.db"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :delete_file, %{path: "index.db"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 46, raw: "GIVEN delete_file path=\"index.db\""}, 46)
    # line 47: WHEN when_tape_rebuild_index
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_rebuild_index, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 47, raw: "WHEN when_tape_rebuild_index"}, 47)
    # line 48: THEN assert_entry_count expected=3
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 3}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 48, raw: "THEN assert_entry_count expected=3"}, 48)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-006
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-006] è¿½åŠ åˆ°ä¸å­˜åœ¨çš„ anchor" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-006"}
    # line 51: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 51, raw: "GIVEN create_temp_dir"}, 51)
    # line 52: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 52, raw: "GIVEN tape_init"}, 52)
    # line 53: WHEN when_tape_append anchor="nonexistent" kind="message" content="fail"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_append, %{anchor: "nonexistent", content: "fail", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 53, raw: "WHEN when_tape_append anchor=\"nonexistent\" kind=\"message\" content=\"fail\""}, 53)
    # line 54: THEN assert_tape_error error_contains="anchor not found"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_tape_error, %{error_contains: "anchor not found"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 54, raw: "THEN assert_tape_error error_contains=\"anchor not found\""}, 54)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-007
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-007] åˆ›å»ºæ–°é”šç‚¹" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-007"}
    # line 61: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 61, raw: "GIVEN create_temp_dir"}, 61)
    # line 62: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 62, raw: "GIVEN tape_init"}, 62)
    # line 63: WHEN when_tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 63, raw: "WHEN when_tape_handoff name=\"phase-1\""}, 63)
    # line 64: THEN assert_dir_exists path="anchors/002_phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_dir_exists, %{path: "anchors/002_phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 64, raw: "THEN assert_dir_exists path=\"anchors/002_phase-1\""}, 64)
    # line 65: THEN assert_anchor_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_anchor_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 65, raw: "THEN assert_anchor_count expected=2"}, 65)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-008
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-008] é”šç‚¹é¡ºåºç¼–å·" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-008"}
    # line 68: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 68, raw: "GIVEN create_temp_dir"}, 68)
    # line 69: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 69, raw: "GIVEN tape_init"}, 69)
    # line 70: GIVEN tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 70, raw: "GIVEN tape_handoff name=\"phase-1\""}, 70)
    # line 71: WHEN when_tape_handoff name="phase-2"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_handoff, %{name: "phase-2"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 71, raw: "WHEN when_tape_handoff name=\"phase-2\""}, 71)
    # line 72: THEN assert_dir_exists path="anchors/002_phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_dir_exists, %{path: "anchors/002_phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 72, raw: "THEN assert_dir_exists path=\"anchors/002_phase-1\""}, 72)
    # line 73: THEN assert_dir_exists path="anchors/003_phase-2"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_dir_exists, %{path: "anchors/003_phase-2"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 73, raw: "THEN assert_dir_exists path=\"anchors/003_phase-2\""}, 73)
    # line 74: THEN assert_anchor_count expected=3
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_anchor_count, %{expected: 3}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 74, raw: "THEN assert_anchor_count expected=3"}, 74)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-009
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-009] handoff åè¿½åŠ å†™å…¥æ–°é”šç‚¹" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-009"}
    # line 77: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 77, raw: "GIVEN create_temp_dir"}, 77)
    # line 78: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 78, raw: "GIVEN tape_init"}, 78)
    # line 79: GIVEN tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 79, raw: "GIVEN tape_handoff name=\"phase-1\""}, 79)
    # line 80: WHEN when_tape_append kind="message" content="phase1 msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_append, %{content: "phase1 msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 80, raw: "WHEN when_tape_append kind=\"message\" content=\"phase1 msg\""}, 80)
    # line 81: THEN assert_jsonl_contains path="anchors/002_phase-1/messages.jsonl" text="phase1 msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/002_phase-1/messages.jsonl", text: "phase1 msg"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 81, raw: "THEN assert_jsonl_contains path=\"anchors/002_phase-1/messages.jsonl\" text=\"phase1 msg\""}, 81)
    # line 82: THEN assert_jsonl_not_contains path="anchors/001_session-start/messages.jsonl" text="phase1 msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_not_contains, %{path: "anchors/001_session-start/messages.jsonl", text: "phase1 msg"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 82, raw: "THEN assert_jsonl_not_contains path=\"anchors/001_session-start/messages.jsonl\" text=\"phase1 msg\""}, 82)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-010
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-010] æŒ‰é”šç‚¹èŒƒå›´æŸ¥è¯¢" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-010"}
    # line 89: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 89, raw: "GIVEN create_temp_dir"}, 89)
    # line 90: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 90, raw: "GIVEN tape_init"}, 90)
    # line 91: GIVEN tape_append anchor="session-start" kind="message" content="start msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "session-start", content: "start msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 91, raw: "GIVEN tape_append anchor=\"session-start\" kind=\"message\" content=\"start msg\""}, 91)
    # line 92: GIVEN tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 92, raw: "GIVEN tape_handoff name=\"phase-1\""}, 92)
    # line 93: GIVEN tape_append anchor="phase-1" kind="message" content="phase1 msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "phase-1", content: "phase1 msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 93, raw: "GIVEN tape_append anchor=\"phase-1\" kind=\"message\" content=\"phase1 msg\""}, 93)
    # line 94: WHEN when_tape_between_anchors start="session-start" end="session-start"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_between_anchors, %{end: "session-start", start: "session-start"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 94, raw: "WHEN when_tape_between_anchors start=\"session-start\" end=\"session-start\""}, 94)
    # line 95: THEN assert_query_results count=1 contains="start msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_query_results, %{contains: "start msg", count: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 95, raw: "THEN assert_query_results count=1 contains=\"start msg\""}, 95)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-011
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-011] å…¨æ–‡æœç´¢å‘½ä¸­" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-011"}
    # line 98: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 98, raw: "GIVEN create_temp_dir"}, 98)
    # line 99: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 99, raw: "GIVEN tape_init"}, 99)
    # line 100: GIVEN tape_append kind="message" content="å‘ç”Ÿäº†é”™è¯¯ä¿¡æ¯"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "å‘ç”Ÿäº†é”™è¯¯ä¿¡æ¯", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 100, raw: "GIVEN tape_append kind=\"message\" content=\"å‘ç”Ÿäº†é”™è¯¯ä¿¡æ¯\""}, 100)
    # line 101: WHEN when_tape_search query="é”™è¯¯"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_search, %{query: "é”™è¯¯"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 101, raw: "WHEN when_tape_search query=\"é”™è¯¯\""}, 101)
    # line 102: THEN assert_search_results count=1 contains="é”™è¯¯ä¿¡æ¯"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_search_results, %{contains: "é”™è¯¯ä¿¡æ¯", count: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 102, raw: "THEN assert_search_results count=1 contains=\"é”™è¯¯ä¿¡æ¯\""}, 102)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-012
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-012] å…¨æ–‡æœç´¢æ— ç»“æœ" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-012"}
    # line 105: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 105, raw: "GIVEN create_temp_dir"}, 105)
    # line 106: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 106, raw: "GIVEN tape_init"}, 106)
    # line 107: GIVEN tape_append kind="message" content="normal message"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "normal message", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 107, raw: "GIVEN tape_append kind=\"message\" content=\"normal message\""}, 107)
    # line 108: WHEN when_tape_search query="ä¸å­˜åœ¨çš„å…³é”®è¯"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_search, %{query: "ä¸å­˜åœ¨çš„å…³é”®è¯"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 108, raw: "WHEN when_tape_search query=\"ä¸å­˜åœ¨çš„å…³é”®è¯\""}, 108)
    # line 109: THEN assert_search_results count=0
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_search_results, %{count: 0}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 109, raw: "THEN assert_search_results count=0"}, 109)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-013
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-013] fork åˆ›å»ºéš”ç¦»å·¥ä½œåŒº" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-013"}
    # line 116: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 116, raw: "GIVEN create_temp_dir"}, 116)
    # line 117: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 117, raw: "GIVEN tape_init"}, 117)
    # line 118: GIVEN tape_append kind="message" content="parent msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "parent msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 118, raw: "GIVEN tape_append kind=\"message\" content=\"parent msg\""}, 118)
    # line 119: WHEN when_tape_fork
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_fork, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 119, raw: "WHEN when_tape_fork"}, 119)
    # line 120: THEN assert_entry_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 120, raw: "THEN assert_entry_count expected=1"}, 120)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-014
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-014] fork å†™å…¥ä¸æ±¡æŸ“çˆ¶å·¥ä½œåŒº" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-014"}
    # line 123: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 123, raw: "GIVEN create_temp_dir"}, 123)
    # line 124: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 124, raw: "GIVEN tape_init"}, 124)
    # line 125: GIVEN tape_append kind="message" content="parent msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "parent msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 125, raw: "GIVEN tape_append kind=\"message\" content=\"parent msg\""}, 125)
    # line 126: GIVEN tape_fork
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_fork, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 126, raw: "GIVEN tape_fork"}, 126)
    # line 127: GIVEN tape_append kind="message" content="fork msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "fork msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 127, raw: "GIVEN tape_append kind=\"message\" content=\"fork msg\""}, 127)
    # line 128: GIVEN tape_restore_parent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_restore_parent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 128, raw: "GIVEN tape_restore_parent"}, 128)
    # line 129: THEN assert_entry_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 129, raw: "THEN assert_entry_count expected=1"}, 129)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-015
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-015] merge åˆå¹¶ fork æ•°æ®" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-015"}
    # line 132: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 132, raw: "GIVEN create_temp_dir"}, 132)
    # line 133: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 133, raw: "GIVEN tape_init"}, 133)
    # line 134: GIVEN tape_append kind="message" content="parent msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "parent msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 134, raw: "GIVEN tape_append kind=\"message\" content=\"parent msg\""}, 134)
    # line 135: GIVEN tape_fork
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_fork, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 135, raw: "GIVEN tape_fork"}, 135)
    # line 136: GIVEN tape_append kind="message" content="fork new msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "fork new msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 136, raw: "GIVEN tape_append kind=\"message\" content=\"fork new msg\""}, 136)
    # line 137: WHEN when_tape_merge
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_merge, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 137, raw: "WHEN when_tape_merge"}, 137)
    # line 138: THEN assert_entry_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 138, raw: "THEN assert_entry_count expected=2"}, 138)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-016
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-016] merge æ— æ–°æ•°æ®ä¸å½±å“çˆ¶å·¥ä½œåŒº" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-016"}
    # line 141: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 141, raw: "GIVEN create_temp_dir"}, 141)
    # line 142: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 142, raw: "GIVEN tape_init"}, 142)
    # line 143: GIVEN tape_append kind="message" content="parent msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "parent msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 143, raw: "GIVEN tape_append kind=\"message\" content=\"parent msg\""}, 143)
    # line 144: GIVEN tape_fork
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_fork, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 144, raw: "GIVEN tape_fork"}, 144)
    # line 145: GIVEN tape_restore_parent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_restore_parent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 145, raw: "GIVEN tape_restore_parent"}, 145)
    # line 146: WHEN when_tape_merge
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_merge, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 146, raw: "WHEN when_tape_merge"}, 146)
    # line 147: THEN assert_entry_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 147, raw: "THEN assert_entry_count expected=1"}, 147)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-017
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-017] malformed JSON è¡Œè·³è¿‡" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-017"}
    # line 154: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 154, raw: "GIVEN create_temp_dir"}, 154)
    # line 155: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 155, raw: "GIVEN tape_init"}, 155)
    # line 156: GIVEN tape_append kind="message" content="good msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "good msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 156, raw: "GIVEN tape_append kind=\"message\" content=\"good msg\""}, 156)
    # line 157: GIVEN corrupt_jsonl path="anchors/001_session-start/messages.jsonl" line_content="this is not json{{"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :corrupt_jsonl, %{line_content: "this is not json{{", path: "anchors/001_session-start/messages.jsonl"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 157, raw: "GIVEN corrupt_jsonl path=\"anchors/001_session-start/messages.jsonl\" line_content=\"this is not json{{\""}, 157)
    # line 158: WHEN when_tape_append kind="message" content="another good msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_append, %{content: "another good msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 158, raw: "WHEN when_tape_append kind=\"message\" content=\"another good msg\""}, 158)
    # line 159: THEN assert_entry_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 159, raw: "THEN assert_entry_count expected=2"}, 159)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-018
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-018] ç©º JSONL æ–‡ä»¶æ¢å¤" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-018"}
    # line 162: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 162, raw: "GIVEN create_temp_dir"}, 162)
    # line 163: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 163, raw: "GIVEN tape_init"}, 163)
    # line 164: GIVEN tape_append kind="message" content="will be cleared"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "will be cleared", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 164, raw: "GIVEN tape_append kind=\"message\" content=\"will be cleared\""}, 164)
    # line 165: GIVEN tape_append kind="tool_call" content="tool data"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "tool data", kind: "tool_call"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 165, raw: "GIVEN tape_append kind=\"tool_call\" content=\"tool data\""}, 165)
    # line 166: GIVEN clear_file path="anchors/001_session-start/messages.jsonl"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :clear_file, %{path: "anchors/001_session-start/messages.jsonl"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 166, raw: "GIVEN clear_file path=\"anchors/001_session-start/messages.jsonl\""}, 166)
    # line 167: WHEN when_tape_rebuild_index
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_rebuild_index, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 167, raw: "WHEN when_tape_rebuild_index"}, 167)
    # line 168: THEN assert_entry_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 168, raw: "THEN assert_entry_count expected=1"}, 168)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-019
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-019] DB ä¸¢å¤±åä»æ–‡ä»¶é‡å»º" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-019"}
    # line 171: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 171, raw: "GIVEN create_temp_dir"}, 171)
    # line 172: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 172, raw: "GIVEN tape_init"}, 172)
    # line 173: GIVEN tape_append kind="message" content="rebuild msg 1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "rebuild msg 1", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 173, raw: "GIVEN tape_append kind=\"message\" content=\"rebuild msg 1\""}, 173)
    # line 174: GIVEN tape_append kind="message" content="rebuild msg 2"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "rebuild msg 2", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 174, raw: "GIVEN tape_append kind=\"message\" content=\"rebuild msg 2\""}, 174)
    # line 175: GIVEN tape_append kind="tool_call" content="rebuild tool"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "rebuild tool", kind: "tool_call"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 175, raw: "GIVEN tape_append kind=\"tool_call\" content=\"rebuild tool\""}, 175)
    # line 176: GIVEN delete_file path="index.db"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :delete_file, %{path: "index.db"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 176, raw: "GIVEN delete_file path=\"index.db\""}, 176)
    # line 177: WHEN when_tape_rebuild_index
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_rebuild_index, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 177, raw: "WHEN when_tape_rebuild_index"}, 177)
    # line 178: THEN assert_entry_count expected=3
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 3}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 178, raw: "THEN assert_entry_count expected=3"}, 178)
    # line 179: THEN assert_anchor_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_anchor_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 179, raw: "THEN assert_anchor_count expected=1"}, 179)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-020
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-020]" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-020"}
    # line 186: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 186, raw: "GIVEN create_temp_dir"}, 186)
    # line 187: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 187, raw: "GIVEN tape_init"}, 187)
    # line 188: WHEN when_tape_append kind="message" content="ä¸­æ–‡æ¶ˆæ¯ ğŸ‰ emojiæµ‹è¯•"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_append, %{content: "ä¸­æ–‡æ¶ˆæ¯ ğŸ‰ emojiæµ‹è¯•", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 188, raw: "WHEN when_tape_append kind=\"message\" content=\"ä¸­æ–‡æ¶ˆæ¯ ğŸ‰ emojiæµ‹è¯•\""}, 188)
    # line 189: THEN assert_entry_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 189, raw: "THEN assert_entry_count expected=1"}, 189)
    # line 190: THEN assert_jsonl_contains path="anchors/001_session-start/messages.jsonl" text="ä¸­æ–‡æ¶ˆæ¯"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/messages.jsonl", text: "ä¸­æ–‡æ¶ˆæ¯"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 190, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/messages.jsonl\" text=\"ä¸­æ–‡æ¶ˆæ¯\""}, 190)
    # line 191: THEN assert_jsonl_contains path="anchors/001_session-start/messages.jsonl" text="ğŸ‰"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/messages.jsonl", text: "ğŸ‰"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 191, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/messages.jsonl\" text=\"ğŸ‰\""}, 191)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-021
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-021] between_anchors è·¨ anchor èŒƒå›´æŸ¥è¯¢" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-021"}
    # line 198: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 198, raw: "GIVEN create_temp_dir"}, 198)
    # line 199: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 199, raw: "GIVEN tape_init"}, 199)
    # line 200: GIVEN tape_append anchor="session-start" kind="message" content="start msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "session-start", content: "start msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 200, raw: "GIVEN tape_append anchor=\"session-start\" kind=\"message\" content=\"start msg\""}, 200)
    # line 201: GIVEN tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 201, raw: "GIVEN tape_handoff name=\"phase-1\""}, 201)
    # line 202: GIVEN tape_append anchor="phase-1" kind="message" content="phase1 msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "phase-1", content: "phase1 msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 202, raw: "GIVEN tape_append anchor=\"phase-1\" kind=\"message\" content=\"phase1 msg\""}, 202)
    # line 203: WHEN when_tape_between_anchors start="session-start" end="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_between_anchors, %{end: "phase-1", start: "session-start"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 203, raw: "WHEN when_tape_between_anchors start=\"session-start\" end=\"phase-1\""}, 203)
    # line 204: THEN assert_query_results count=2 contains="start msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_query_results, %{contains: "start msg", count: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 204, raw: "THEN assert_query_results count=2 contains=\"start msg\""}, 204)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-022
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-022] search è·¨ anchor æœç´¢" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-022"}
    # line 207: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 207, raw: "GIVEN create_temp_dir"}, 207)
    # line 208: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 208, raw: "GIVEN tape_init"}, 208)
    # line 209: GIVEN tape_append anchor="session-start" kind="message" content="æœç´¢ç›®æ ‡alpha"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "session-start", content: "æœç´¢ç›®æ ‡alpha", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 209, raw: "GIVEN tape_append anchor=\"session-start\" kind=\"message\" content=\"æœç´¢ç›®æ ‡alpha\""}, 209)
    # line 210: GIVEN tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 210, raw: "GIVEN tape_handoff name=\"phase-1\""}, 210)
    # line 211: GIVEN tape_append anchor="phase-1" kind="message" content="æœç´¢ç›®æ ‡beta"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "phase-1", content: "æœç´¢ç›®æ ‡beta", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 211, raw: "GIVEN tape_append anchor=\"phase-1\" kind=\"message\" content=\"æœç´¢ç›®æ ‡beta\""}, 211)
    # line 212: WHEN when_tape_search query="æœç´¢ç›®æ ‡"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_search, %{query: "æœç´¢ç›®æ ‡"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 212, raw: "WHEN when_tape_search query=\"æœç´¢ç›®æ ‡\""}, 212)
    # line 213: THEN assert_search_results count=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_search_results, %{count: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 213, raw: "THEN assert_search_results count=2"}, 213)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-023
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-023] handoff é‡å¤åç§°è¿”å›é”™è¯¯" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-023"}
    # line 216: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 216, raw: "GIVEN create_temp_dir"}, 216)
    # line 217: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 217, raw: "GIVEN tape_init"}, 217)
    # line 218: GIVEN tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 218, raw: "GIVEN tape_handoff name=\"phase-1\""}, 218)
    # line 219: WHEN when_tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 219, raw: "WHEN when_tape_handoff name=\"phase-1\""}, 219)
    # line 220: THEN assert_tape_error error_contains="anchor already exists"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_tape_error, %{error_contains: "anchor already exists"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 220, raw: "THEN assert_tape_error error_contains=\"anchor already exists\""}, 220)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-024
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-024] merge å¤±è´¥å›æ»š â€” çˆ¶ DB æŸå" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-024"}
    # line 223: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 223, raw: "GIVEN create_temp_dir"}, 223)
    # line 224: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 224, raw: "GIVEN tape_init"}, 224)
    # line 225: GIVEN tape_append kind="message" content="parent msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "parent msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 225, raw: "GIVEN tape_append kind=\"message\" content=\"parent msg\""}, 225)
    # line 226: GIVEN tape_fork
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_fork, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 226, raw: "GIVEN tape_fork"}, 226)
    # line 227: GIVEN tape_append kind="message" content="fork new msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "fork new msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 227, raw: "GIVEN tape_append kind=\"message\" content=\"fork new msg\""}, 227)
    # line 228: GIVEN tape_restore_parent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_restore_parent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 228, raw: "GIVEN tape_restore_parent"}, 228)
    # line 229: GIVEN tape_close_db
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_close_db, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 229, raw: "GIVEN tape_close_db"}, 229)
    # line 230: WHEN when_tape_merge
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_merge, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 230, raw: "WHEN when_tape_merge"}, 230)
    # line 231: THEN assert_tape_error error_contains="merge failed"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_tape_error, %{error_contains: "merge failed"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 231, raw: "THEN assert_tape_error error_contains=\"merge failed\""}, 231)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-025
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-025] rebuild_index å¤š anchor å¤š kind é‡å»º" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-025"}
    # line 234: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 234, raw: "GIVEN create_temp_dir"}, 234)
    # line 235: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 235, raw: "GIVEN tape_init"}, 235)
    # line 236: GIVEN tape_append anchor="session-start" kind="message" content="msg1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "session-start", content: "msg1", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 236, raw: "GIVEN tape_append anchor=\"session-start\" kind=\"message\" content=\"msg1\""}, 236)
    # line 237: GIVEN tape_append anchor="session-start" kind="tool_call" content="tool1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "session-start", content: "tool1", kind: "tool_call"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 237, raw: "GIVEN tape_append anchor=\"session-start\" kind=\"tool_call\" content=\"tool1\""}, 237)
    # line 238: GIVEN tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 238, raw: "GIVEN tape_handoff name=\"phase-1\""}, 238)
    # line 239: GIVEN tape_append anchor="phase-1" kind="message" content="msg2"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "phase-1", content: "msg2", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 239, raw: "GIVEN tape_append anchor=\"phase-1\" kind=\"message\" content=\"msg2\""}, 239)
    # line 240: GIVEN delete_file path="index.db"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :delete_file, %{path: "index.db"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 240, raw: "GIVEN delete_file path=\"index.db\""}, 240)
    # line 241: WHEN when_tape_rebuild_index
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_rebuild_index, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 241, raw: "WHEN when_tape_rebuild_index"}, 241)
    # line 242: THEN assert_entry_count expected=3
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 3}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 242, raw: "THEN assert_entry_count expected=3"}, 242)
    # line 243: THEN assert_anchor_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_anchor_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 243, raw: "THEN assert_anchor_count expected=2"}, 243)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-026
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-026] åŒ anchor æ··åˆ kind æ–‡ä»¶åˆ†ç¦»" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-026"}
    # line 246: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 246, raw: "GIVEN create_temp_dir"}, 246)
    # line 247: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 247, raw: "GIVEN tape_init"}, 247)
    # line 248: GIVEN tape_append kind="message" content="hello"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "hello", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 248, raw: "GIVEN tape_append kind=\"message\" content=\"hello\""}, 248)
    # line 249: GIVEN tape_append kind="tool_call" content="tool data"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "tool data", kind: "tool_call"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 249, raw: "GIVEN tape_append kind=\"tool_call\" content=\"tool data\""}, 249)
    # line 250: WHEN when_tape_append kind="message" content="world"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_append, %{content: "world", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 250, raw: "WHEN when_tape_append kind=\"message\" content=\"world\""}, 250)
    # line 251: THEN assert_entry_count expected=3
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 3}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 251, raw: "THEN assert_entry_count expected=3"}, 251)
    # line 252: THEN assert_jsonl_contains path="anchors/001_session-start/messages.jsonl" text="hello"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/messages.jsonl", text: "hello"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 252, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/messages.jsonl\" text=\"hello\""}, 252)
    # line 253: THEN assert_jsonl_contains path="anchors/001_session-start/messages.jsonl" text="world"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/messages.jsonl", text: "world"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 253, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/messages.jsonl\" text=\"world\""}, 253)
    # line 254: THEN assert_jsonl_contains path="anchors/001_session-start/tool_calls.jsonl" text="tool data"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/tool_calls.jsonl", text: "tool data"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 254, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/tool_calls.jsonl\" text=\"tool data\""}, 254)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-027
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-027] merge åˆå¹¶ fork ä¸­æ–°å»ºçš„ anchor" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-027"}
    # line 257: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 257, raw: "GIVEN create_temp_dir"}, 257)
    # line 258: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 258, raw: "GIVEN tape_init"}, 258)
    # line 259: GIVEN tape_append kind="message" content="parent msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "parent msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 259, raw: "GIVEN tape_append kind=\"message\" content=\"parent msg\""}, 259)
    # line 260: GIVEN tape_fork
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_fork, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 260, raw: "GIVEN tape_fork"}, 260)
    # line 261: GIVEN tape_handoff name="fork-phase"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "fork-phase"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 261, raw: "GIVEN tape_handoff name=\"fork-phase\""}, 261)
    # line 262: GIVEN tape_append anchor="fork-phase" kind="message" content="fork phase msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "fork-phase", content: "fork phase msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 262, raw: "GIVEN tape_append anchor=\"fork-phase\" kind=\"message\" content=\"fork phase msg\""}, 262)
    # line 263: GIVEN tape_restore_parent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_restore_parent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 263, raw: "GIVEN tape_restore_parent"}, 263)
    # line 264: WHEN when_tape_merge
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_merge, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 264, raw: "WHEN when_tape_merge"}, 264)
    # line 265: THEN assert_entry_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 265, raw: "THEN assert_entry_count expected=2"}, 265)
    # line 266: THEN assert_anchor_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_anchor_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 266, raw: "THEN assert_anchor_count expected=2"}, 266)
    # line 267: THEN assert_dir_exists path="anchors/002_fork-phase"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_dir_exists, %{path: "anchors/002_fork-phase"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 267, raw: "THEN assert_dir_exists path=\"anchors/002_fork-phase\""}, 267)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-028
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-028] é‡å¤åˆå§‹åŒ–ä¿ç•™å·²æœ‰æ•°æ®" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-028"}
    # line 274: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 274, raw: "GIVEN create_temp_dir"}, 274)
    # line 275: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 275, raw: "GIVEN tape_init"}, 275)
    # line 276: GIVEN tape_append kind="message" content="existing msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "existing msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 276, raw: "GIVEN tape_append kind=\"message\" content=\"existing msg\""}, 276)
    # line 277: GIVEN tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 277, raw: "GIVEN tape_handoff name=\"phase-1\""}, 277)
    # line 278: GIVEN tape_append anchor="phase-1" kind="tool_call" content="existing tool"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "phase-1", content: "existing tool", kind: "tool_call"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 278, raw: "GIVEN tape_append anchor=\"phase-1\" kind=\"tool_call\" content=\"existing tool\""}, 278)
    # line 279: WHEN when_tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 279, raw: "WHEN when_tape_init"}, 279)
    # line 280: THEN assert_entry_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 280, raw: "THEN assert_entry_count expected=2"}, 280)
    # line 281: THEN assert_anchor_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_anchor_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 281, raw: "THEN assert_anchor_count expected=2"}, 281)
    # line 282: THEN assert_jsonl_contains path="anchors/001_session-start/messages.jsonl" text="existing msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/messages.jsonl", text: "existing msg"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 282, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/messages.jsonl\" text=\"existing msg\""}, 282)
    # line 283: THEN assert_jsonl_contains path="anchors/002_phase-1/tool_calls.jsonl" text="existing tool"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/002_phase-1/tool_calls.jsonl", text: "existing tool"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 283, raw: "THEN assert_jsonl_contains path=\"anchors/002_phase-1/tool_calls.jsonl\" text=\"existing tool\""}, 283)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-029
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-029] è‡ªå®šä¹‰ kind è¿½åŠ å†™å…¥ç‹¬ç«‹æ–‡ä»¶" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-029"}
    # line 286: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 286, raw: "GIVEN create_temp_dir"}, 286)
    # line 287: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 287, raw: "GIVEN tape_init"}, 287)
    # line 288: GIVEN tape_append kind="message" content="normal msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "normal msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 288, raw: "GIVEN tape_append kind=\"message\" content=\"normal msg\""}, 288)
    # line 289: WHEN when_tape_append kind="event" content="custom event data"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_append, %{content: "custom event data", kind: "event"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 289, raw: "WHEN when_tape_append kind=\"event\" content=\"custom event data\""}, 289)
    # line 290: THEN assert_entry_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 290, raw: "THEN assert_entry_count expected=2"}, 290)
    # line 291: THEN assert_jsonl_contains path="anchors/001_session-start/messages.jsonl" text="normal msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/messages.jsonl", text: "normal msg"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 291, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/messages.jsonl\" text=\"normal msg\""}, 291)
    # line 292: THEN assert_jsonl_contains path="anchors/001_session-start/events.jsonl" text="custom event data"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/events.jsonl", text: "custom event data"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 292, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/events.jsonl\" text=\"custom event data\""}, 292)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-030
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-030] fork ä¿ç•™å¤š anchor å®Œæ•´ç»“æ„" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-030"}
    # line 295: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 295, raw: "GIVEN create_temp_dir"}, 295)
    # line 296: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 296, raw: "GIVEN tape_init"}, 296)
    # line 297: GIVEN tape_append anchor="session-start" kind="message" content="start msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "session-start", content: "start msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 297, raw: "GIVEN tape_append anchor=\"session-start\" kind=\"message\" content=\"start msg\""}, 297)
    # line 298: GIVEN tape_handoff name="phase-1"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-1"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 298, raw: "GIVEN tape_handoff name=\"phase-1\""}, 298)
    # line 299: GIVEN tape_append anchor="phase-1" kind="message" content="phase1 msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "phase-1", content: "phase1 msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 299, raw: "GIVEN tape_append anchor=\"phase-1\" kind=\"message\" content=\"phase1 msg\""}, 299)
    # line 300: GIVEN tape_handoff name="phase-2"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_handoff, %{name: "phase-2"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 300, raw: "GIVEN tape_handoff name=\"phase-2\""}, 300)
    # line 301: GIVEN tape_append anchor="phase-2" kind="tool_call" content="phase2 tool"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{anchor: "phase-2", content: "phase2 tool", kind: "tool_call"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 301, raw: "GIVEN tape_append anchor=\"phase-2\" kind=\"tool_call\" content=\"phase2 tool\""}, 301)
    # line 302: WHEN when_tape_fork
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_fork, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 302, raw: "WHEN when_tape_fork"}, 302)
    # line 303: THEN assert_entry_count expected=3
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 3}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 303, raw: "THEN assert_entry_count expected=3"}, 303)
    # line 304: THEN assert_anchor_count expected=3
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_anchor_count, %{expected: 3}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 304, raw: "THEN assert_anchor_count expected=3"}, 304)
    # line 305: THEN assert_jsonl_contains path="anchors/001_session-start/messages.jsonl" text="start msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/001_session-start/messages.jsonl", text: "start msg"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 305, raw: "THEN assert_jsonl_contains path=\"anchors/001_session-start/messages.jsonl\" text=\"start msg\""}, 305)
    # line 306: THEN assert_jsonl_contains path="anchors/002_phase-1/messages.jsonl" text="phase1 msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/002_phase-1/messages.jsonl", text: "phase1 msg"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 306, raw: "THEN assert_jsonl_contains path=\"anchors/002_phase-1/messages.jsonl\" text=\"phase1 msg\""}, 306)
    # line 307: THEN assert_jsonl_contains path="anchors/003_phase-2/tool_calls.jsonl" text="phase2 tool"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_jsonl_contains, %{path: "anchors/003_phase-2/tool_calls.jsonl", text: "phase2 tool"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 307, raw: "THEN assert_jsonl_contains path=\"anchors/003_phase-2/tool_calls.jsonl\" text=\"phase2 tool\""}, 307)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-031
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-031] åˆæ³• JSON ä½†å­—æ®µç±»å‹é”™è¯¯çš„è¡Œè¢«è·³è¿‡" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-031"}
    # line 314: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 314, raw: "GIVEN create_temp_dir"}, 314)
    # line 315: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 315, raw: "GIVEN tape_init"}, 315)
    # line 316: GIVEN tape_append kind="message" content="good msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "good msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 316, raw: "GIVEN tape_append kind=\"message\" content=\"good msg\""}, 316)
    # line 317: GIVEN corrupt_jsonl path="anchors/001_session-start/messages.jsonl" line_content="{\"id\": null, \"kind\": 123, \"content\": null, \"timestamp\": \"bad\"}"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :corrupt_jsonl, %{line_content: "{\\\"id\\\": null, \\\"kind\\\": 123, \\\"content\\\": null, \\\"timestamp\\\": \\\"bad\\\"}", path: "anchors/001_session-start/messages.jsonl"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 317, raw: "GIVEN corrupt_jsonl path=\"anchors/001_session-start/messages.jsonl\" line_content=\"{\\\"id\\\": null, \\\"kind\\\": 123, \\\"content\\\": null, \\\"timestamp\\\": \\\"bad\\\"}\""}, 317)
    # line 318: GIVEN delete_file path="index.db"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :delete_file, %{path: "index.db"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 318, raw: "GIVEN delete_file path=\"index.db\""}, 318)
    # line 319: WHEN when_tape_rebuild_index
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_rebuild_index, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 319, raw: "WHEN when_tape_rebuild_index"}, 319)
    # line 320: THEN assert_entry_count expected=1
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 1}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 320, raw: "THEN assert_entry_count expected=1"}, 320)
    _ctx = ctx
    :ok
  end

  # Source: BDD-TAPE-032
  @tag :tape
  @tag :unit
  test "[BDD-TAPE-032] merge å fork ä¸´æ—¶ç›®å½•è¢«æ¸…ç†" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-TAPE-032"}
    # line 323: GIVEN create_temp_dir
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :create_temp_dir, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 323, raw: "GIVEN create_temp_dir"}, 323)
    # line 324: GIVEN tape_init
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_init, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 324, raw: "GIVEN tape_init"}, 324)
    # line 325: GIVEN tape_append kind="message" content="parent msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "parent msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 325, raw: "GIVEN tape_append kind=\"message\" content=\"parent msg\""}, 325)
    # line 326: GIVEN tape_fork
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_fork, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 326, raw: "GIVEN tape_fork"}, 326)
    # line 327: GIVEN tape_append kind="message" content="fork msg"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_append, %{content: "fork msg", kind: "message"}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 327, raw: "GIVEN tape_append kind=\"message\" content=\"fork msg\""}, 327)
    # line 328: GIVEN tape_restore_parent
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :given, :tape_restore_parent, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 328, raw: "GIVEN tape_restore_parent"}, 328)
    # line 329: WHEN when_tape_merge
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :when_tape_merge, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 329, raw: "WHEN when_tape_merge"}, 329)
    # line 330: THEN assert_entry_count expected=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_entry_count, %{expected: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 330, raw: "THEN assert_entry_count expected=2"}, 330)
    # line 331: THEN assert_fork_cleaned
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_fork_cleaned, %{}, %{file: "/home/wangbo/document/gong/docs/bdd/tape_storage.dsl", line: 331, raw: "THEN assert_fork_cleaned"}, 331)
    _ctx = ctx
    :ok
  end

end
