# Generated by bdd_compiler from /home/wangbo/document/gong/docs/bdd/retry.dsl. DO NOT EDIT.

defmodule Gong.BDD.Generated.RetryTest do
  use ExUnit.Case, async: false

  @moduletag :bdd_generated

  # Source: BDD-RETRY-001
  @tag :agent_loop
  @tag :unit
  test "[BDD-RETRY-001] 429 错误分类为 transient" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-RETRY-001"}
    # line 5: WHEN classify_error error="HTTP 429 Too Many Requests"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :classify_error, %{error: "HTTP 429 Too Many Requests"}, %{file: "/home/wangbo/document/gong/docs/bdd/retry.dsl", line: 5, raw: "WHEN classify_error error=\"HTTP 429 Too Many Requests\""}, 5)
    # line 6: THEN assert_error_class expected="transient"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_error_class, %{expected: "transient"}, %{file: "/home/wangbo/document/gong/docs/bdd/retry.dsl", line: 6, raw: "THEN assert_error_class expected=\"transient\""}, 6)
    _ctx = ctx
    :ok
  end

  # Source: BDD-RETRY-002
  @tag :agent_loop
  @tag :unit
  test "[BDD-RETRY-002] context overflow 分类为 context_overflow" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-RETRY-002"}
    # line 9: WHEN classify_error error="prompt is too long for the context window"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :classify_error, %{error: "prompt is too long for the context window"}, %{file: "/home/wangbo/document/gong/docs/bdd/retry.dsl", line: 9, raw: "WHEN classify_error error=\"prompt is too long for the context window\""}, 9)
    # line 10: THEN assert_error_class expected="context_overflow"
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_error_class, %{expected: "context_overflow"}, %{file: "/home/wangbo/document/gong/docs/bdd/retry.dsl", line: 10, raw: "THEN assert_error_class expected=\"context_overflow\""}, 10)
    _ctx = ctx
    :ok
  end

  # Source: BDD-RETRY-003
  @tag :agent_loop
  @tag :unit
  test "[BDD-RETRY-003] 指数退避延迟计算" do
    run_id = Gong.BDD.Instructions.V1.new_run_id()
    ctx = %{run_id: run_id, scenario_id: "BDD-RETRY-003"}
    # line 13: WHEN retry_delay attempt=0
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :retry_delay, %{attempt: 0}, %{file: "/home/wangbo/document/gong/docs/bdd/retry.dsl", line: 13, raw: "WHEN retry_delay attempt=0"}, 13)
    # line 14: THEN assert_delay_ms expected=1000
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_delay_ms, %{expected: 1000}, %{file: "/home/wangbo/document/gong/docs/bdd/retry.dsl", line: 14, raw: "THEN assert_delay_ms expected=1000"}, 14)
    # line 15: WHEN retry_delay attempt=2
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :when, :retry_delay, %{attempt: 2}, %{file: "/home/wangbo/document/gong/docs/bdd/retry.dsl", line: 15, raw: "WHEN retry_delay attempt=2"}, 15)
    # line 16: THEN assert_delay_ms expected=4000
    ctx = Gong.BDD.Instructions.V1.run_step!(ctx, :then, :assert_delay_ms, %{expected: 4000}, %{file: "/home/wangbo/document/gong/docs/bdd/retry.dsl", line: 16, raw: "THEN assert_delay_ms expected=4000"}, 16)
    _ctx = ctx
    :ok
  end

end
